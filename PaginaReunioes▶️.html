<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Meeting — Reuniões</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ═══════════════════════════════════════════════
       VARIÁVEIS — PALETA VINTAGE CREME
    ═══════════════════════════════════════════════ */
    :root {
      --creme-base: #F5EFE0;
      --creme-claro: #FAF7F0;
      --creme-medio: #EDE3CC;
      --creme-escuro: #D9CCAA;
      --marrom-escuro: #2C1810;
      --marrom-medio: #5C3D2E;
      --marrom-claro: #8B6347;
      --ocre: #C4822A;
      --ocre-claro: rgba(196,130,42,0.12);
      --ocre-hover: #A06820;
      --verde-vintage: #4A6741;
      --verde-claro: rgba(74,103,65,0.1);
      --vermelho-vintage: #8B2E2E;
      --azul-vintage: #2E4A6B;
      --azul-claro: rgba(46,74,107,0.1);
      --sombra-papel: 0 2px 8px rgba(44,24,16,0.08), 0 1px 2px rgba(44,24,16,0.05);
      --sombra-elevada: 0 8px 32px rgba(44,24,16,0.12), 0 2px 8px rgba(44,24,16,0.08);
      --sombra-flutuante: 0 16px 48px rgba(44,24,16,0.16);
      --borda-papel: 1px solid rgba(44,24,16,0.1);
      --fonte-titulo: 'DM Serif Display', Georgia, serif;
      --fonte-corpo: 'Plus Jakarta Sans', sans-serif;
      --raio: 4px;
      --raio-md: 8px;
      --raio-lg: 12px;
      --trans: all 0.25s cubic-bezier(0.4,0,0.2,1);
    }

    /* ═══════════════════════════════════════════════
       RESET & BASE
    ═══════════════════════════════════════════════ */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; overflow-x:hidden; }
    body {
      font-family: var(--fonte-corpo);
      background: var(--creme-base);
      color: var(--marrom-escuro);
      min-height: 100vh;
      font-size: 13px;
      line-height: 1.6;
      background-image:
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232C1810' fill-opacity='0.025'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    /* ═══════════════════════════════════════════════
       ANIMAÇÕES
    ═══════════════════════════════════════════════ */
    @keyframes fadeInUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeIn   { from { opacity:0; } to { opacity:1; } }
    @keyframes spin     { to { transform:rotate(360deg); } }
    @keyframes pulsar   { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
    @keyframes piscarGrav { 0%,100%{color:var(--vermelho-vintage);} 50%{color:var(--ocre);} }
    @keyframes loadBar  { 0%{transform:translateX(-100%);} 100%{transform:translateX(350%);} }
    @keyframes toastIn  { from{opacity:0;transform:translateX(120px);} to{opacity:1;transform:translateX(0);} }
    @keyframes toastOut { to{opacity:0;transform:translateX(120px);} }
    @keyframes skeletonShimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }

    .fade-in-up { animation: fadeInUp 0.5s ease-out both; }
    .fade-in-up:nth-child(1) { animation-delay:0.04s; }
    .fade-in-up:nth-child(2) { animation-delay:0.1s; }
    .fade-in-up:nth-child(3) { animation-delay:0.16s; }

    /* ═══════════════════════════════════════════════
       HEADER
    ═══════════════════════════════════════════════ */
    .header {
      background: var(--marrom-escuro);
      border-bottom: 3px solid var(--ocre);
      padding: 0 2rem;
      position: sticky; top:0; z-index:200;
      box-shadow: 0 2px 16px rgba(44,24,16,0.4);
    }
    .header-inner {
      display: flex; align-items: stretch;
      gap: 0; max-width: 1700px; margin: 0 auto;
    }
    .header-logo {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.875rem 1.5rem 0.875rem 0;
      border-right: 1px solid rgba(255,255,255,0.08);
      text-decoration: none; flex-shrink: 0;
      margin-right: 1.5rem;
    }
    .logo-icon {
      width: 36px; height: 36px;
      background: var(--ocre);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .logo-icon i { color: var(--marrom-escuro); font-size: 1rem; }
    .logo-text { font-family: var(--fonte-titulo); font-size: 1.25rem; color: var(--creme-claro); letter-spacing: 0.3px; }
    .logo-text em { color: var(--ocre); font-style: normal; }

    /* NAV esquerdo + links */
    .header-nav { display:flex; align-items:center; gap:0.25rem; flex:1; }
    .nav-link {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.55rem 1rem;
      color: rgba(245,239,224,0.6);
      text-decoration: none;
      font-size: 0.82rem; font-weight: 600;
      border-radius: var(--raio);
      transition: var(--trans);
      position: relative; white-space: nowrap;
    }
    .nav-link:hover { color: var(--creme-claro); background: rgba(255,255,255,0.07); }
    .nav-link.ativo { color: var(--ocre); }
    .nav-link.ativo::after {
      content:''; position:absolute; bottom:-1px; left:0; right:0; height:2px;
      background: var(--ocre); border-radius: 2px 2px 0 0;
    }

    /* Status pills no header (lado direito) */
    .header-status { display:flex; align-items:center; gap:0.5rem; margin-left:auto; }
    .pill-status {
      display: inline-flex; align-items: center; gap: 0.35rem;
      padding: 0.3rem 0.7rem;
      border-radius: 100px;
      font-size: 0.72rem; font-weight: 700;
      border: 1px solid rgba(245,239,224,0.15);
      color: rgba(245,239,224,0.55);
      background: rgba(255,255,255,0.04);
      transition: var(--trans);
    }
    .pill-status .dot { width:6px; height:6px; border-radius:50%; background: rgba(245,239,224,0.3); flex-shrink:0; }
    .pill-status.ok .dot { background: #6bbf6e; }
    .pill-status.ok { color: rgba(107,191,110,0.9); border-color: rgba(107,191,110,0.25); }
    .pill-status.erro .dot { background: #e06060; }
    .pill-status.erro { color: rgba(224,96,96,0.9); border-color: rgba(224,96,96,0.25); }

    /* ═══════════════════════════════════════════════
       LAYOUT PRINCIPAL
    ═══════════════════════════════════════════════ */
    .main-grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 0;
      max-width: 1700px;
      margin: 0 auto;
      min-height: calc(100vh - 60px);
    }

    /* Coluna esquerda: gravação */
    .coluna-esq {
      background: var(--creme-claro);
      border-right: var(--borda-papel);
      padding: 1.5rem;
      display: flex; flex-direction: column; gap: 1.25rem;
      overflow-y: auto;
    }

    /* Coluna direita: atas e catálogo */
.coluna-dir {
  background: var(--creme-base);
  display: grid;
  grid-template-rows: minmax(250px, 50vh) 1fr;
  overflow: hidden;
}

    /* ═══════════════════════════════════════════════
       CARDS
    ═══════════════════════════════════════════════ */
    .card {
      background: var(--creme-claro);
      border: var(--borda-papel);
      border-radius: var(--raio-lg);
      box-shadow: var(--sombra-papel);
      overflow: hidden;
    }
    .card-header {
      padding: 0.875rem 1.25rem;
      border-bottom: var(--borda-papel);
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(180deg, rgba(217,204,170,0.3) 0%, transparent 100%);
    }
    .card-titulo {
      font-family: var(--fonte-titulo); font-size: 1rem;
      color: var(--marrom-escuro); letter-spacing: 0.2px;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .card-titulo i { color: var(--ocre); font-size: 0.85rem; }
    .card-body { padding: 1.25rem; }

    /* ═══════════════════════════════════════════════
       SECTION LABEL (ornamento vintage)
    ═══════════════════════════════════════════════ */
    .section-label {
      font-family: var(--fonte-titulo);
      font-size: 0.72rem; letter-spacing: 2px; text-transform: uppercase;
      color: var(--marrom-claro);
      display: flex; align-items: center; gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .section-label::before, .section-label::after {
      content:''; flex:1; height:1px; background: var(--creme-escuro);
    }

    /* ═══════════════════════════════════════════════
       GRAVAÇÃO
    ═══════════════════════════════════════════════ */
    .gravacao-visual {
      height: 90px;
      background: var(--marrom-escuro);
      border-radius: var(--raio-md);
      overflow: hidden;
      position: relative;
    }
    .gravacao-visual canvas { width:100%; height:100%; display:block; }
    .gravacao-placeholder {
      position: absolute; inset:0;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.4rem;
      color: rgba(245,239,224,0.25); font-size: 0.8rem;
    }
    .gravacao-placeholder i { font-size: 1.5rem; }

    .timer-display {
      font-family: 'DM Serif Display', serif;
      font-size: 2.75rem; letter-spacing: 3px;
      color: var(--marrom-escuro);
      text-align: center;
      text-shadow: 0 1px 0 rgba(255,255,255,0.8);
    }
    .timer-display.gravando { animation: piscarGrav 1.2s ease-in-out infinite; }
    .timer-display.pausado { color: var(--ocre); }

    .status-grav {
      text-align: center; font-size: 0.72rem; font-weight: 700;
      letter-spacing: 1.5px; text-transform: uppercase;
      color: var(--marrom-claro);
    }
    .status-grav.gravando { color: var(--vermelho-vintage); }
    .status-grav.pausado { color: var(--ocre); }

    .controles-grav { display:flex; gap:0.5rem; }
    .controles-grav .btn { flex:1; justify-content:center; }

    /* ═══════════════════════════════════════════════
       BOTÕES
    ═══════════════════════════════════════════════ */
    .btn {
      display: inline-flex; align-items: center; gap: 0.45rem;
      padding: 0.65rem 1.125rem;
      border: none; border-radius: var(--raio-md);
      font-family: var(--fonte-corpo);
      font-size: 0.82rem; font-weight: 700;
      cursor: pointer; transition: var(--trans);
      text-decoration: none; position: relative; overflow: hidden;
      letter-spacing: 0.2px;
    }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

    .btn-primario {
      background: var(--ocre); color: var(--creme-claro);
      box-shadow: 0 2px 6px rgba(196,130,42,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .btn-primario:hover:not(:disabled) {
      background: var(--ocre-hover);
      box-shadow: 0 4px 14px rgba(196,130,42,0.4);
      transform: translateY(-1px);
    }

    .btn-secundario {
      background: var(--creme-medio); color: var(--marrom-medio);
      border: 1px solid var(--creme-escuro);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }
    .btn-secundario:hover:not(:disabled) {
      background: var(--creme-escuro); color: var(--marrom-escuro);
      transform: translateY(-1px);
    }

    .btn-verde {
      background: var(--verde-vintage); color: var(--creme-claro);
      box-shadow: 0 2px 6px rgba(74,103,65,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .btn-verde:hover:not(:disabled) {
      background: #3a5433; transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(74,103,65,0.4);
    }

    .btn-vermelho {
      background: var(--vermelho-vintage); color: var(--creme-claro);
      box-shadow: 0 2px 6px rgba(139,46,46,0.3);
    }
    .btn-vermelho:hover:not(:disabled) { background: #721e1e; transform: translateY(-1px); }

    .btn-gravando {
      background: var(--vermelho-vintage); color: white;
      animation: none;
      box-shadow: 0 0 0 0 rgba(139,46,46,0.4);
    }

    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
    .btn-xs {
      display: inline-flex; align-items: center; justify-content: center;
      width: 28px; height: 28px; border-radius: var(--raio);
      border: 1px solid var(--creme-escuro);
      background: var(--creme-claro); color: var(--marrom-claro);
      cursor: pointer; transition: var(--trans); font-size: 0.72rem;
    }
    .btn-xs:hover { background: var(--creme-medio); color: var(--marrom-escuro); transform: translateY(-1px); }
    .btn-xs:disabled { opacity:0.3; cursor:not-allowed; transform:none; }

    .btn-xs.azul:hover { background: var(--azul-claro); color: var(--azul-vintage); border-color: rgba(46,74,107,0.25); }
    .btn-xs.verde:hover { background: var(--verde-claro); color: var(--verde-vintage); border-color: rgba(74,103,65,0.25); }
    .btn-xs.ocre:hover { background: var(--ocre-claro); color: var(--ocre); border-color: rgba(196,130,42,0.25); }
    .btn-xs.roxo:hover { background: rgba(100,60,130,0.1); color: #643c82; border-color: rgba(100,60,130,0.25); }

    /* Btn carregando */
    .btn.carregando { color: transparent !important; pointer-events: none; }
    .btn.carregando::after {
      content:''; position:absolute; top:50%; left:50%;
      width:16px; height:16px; margin:-8px 0 0 -8px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white; border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    /* ═══════════════════════════════════════════════
       FORMULÁRIO
    ═══════════════════════════════════════════════ */
    .form-grupo { margin-bottom: 0.875rem; }
    .form-label {
      display: block; margin-bottom: 0.3rem;
      font-size: 0.72rem; font-weight: 700; letter-spacing: 0.8px;
      text-transform: uppercase; color: var(--marrom-medio);
    }
    .form-input, .form-select {
      width: 100%;
      padding: 0.6rem 0.875rem;
      background: var(--creme-base);
      border: 1px solid var(--creme-escuro);
      border-radius: var(--raio-md);
      color: var(--marrom-escuro);
      font-family: var(--fonte-corpo); font-size: 0.85rem;
      transition: var(--trans);
      box-shadow: inset 0 1px 3px rgba(44,24,16,0.06);
    }
    .form-input:focus, .form-select:focus {
      outline: none; border-color: var(--ocre);
      box-shadow: 0 0 0 3px rgba(196,130,42,0.12), inset 0 1px 3px rgba(44,24,16,0.04);
    }
    .form-input::placeholder { color: var(--creme-escuro); }

    /* ═══════════════════════════════════════════════
       UPLOAD DROPZONE
    ═══════════════════════════════════════════════ */
    .dropzone {
      border: 2px dashed var(--creme-escuro);
      border-radius: var(--raio-lg);
      padding: 1.75rem 1.25rem;
      text-align: center; cursor: pointer;
      transition: var(--trans);
      background: linear-gradient(135deg, rgba(217,204,170,0.15), rgba(245,239,224,0.3));
    }
    .dropzone:hover, .dropzone.arrastando {
      border-color: var(--ocre);
      background: var(--ocre-claro);
    }
    .dropzone i { font-size: 2rem; color: var(--marrom-claro); margin-bottom: 0.5rem; opacity:0.6; }
    .dropzone h3 { font-size: 0.875rem; font-weight: 700; color: var(--marrom-escuro); margin-bottom: 0.2rem; }
    .dropzone p { font-size: 0.78rem; color: var(--marrom-claro); }

    .arquivo-preview {
      display: flex; align-items: center; gap: 0.875rem;
      padding: 0.875rem 1rem;
      background: var(--ocre-claro);
      border: 1px solid rgba(196,130,42,0.2);
      border-radius: var(--raio-md);
    }
    .arquivo-preview i { font-size: 1.5rem; color: var(--ocre); flex-shrink:0; }
    .arquivo-nome { font-weight: 700; font-size: 0.82rem; color: var(--marrom-escuro); word-break:break-all; }
    .arquivo-tam { font-size: 0.72rem; color: var(--marrom-claro); }
    .btn-remover { background:none; border:none; color: var(--vermelho-vintage); cursor:pointer; padding:0.3rem; border-radius:var(--raio); transition:var(--trans); }
    .btn-remover:hover { background: rgba(139,46,46,0.08); }

    /* Progresso */
    .progresso-wrap { display:none; }
    .progresso-wrap.visivel { display:block; }
    .progresso-trilha { height:5px; background: var(--creme-escuro); border-radius:3px; overflow:hidden; }
    .progresso-fill { height:100%; background: linear-gradient(90deg, var(--ocre), var(--ocre-hover)); transition: width 0.3s ease; width:0%; }
    .progresso-info { display:flex; justify-content:space-between; margin-top:0.3rem; font-size:0.72rem; color:var(--marrom-claro); font-weight:600; }

    /* ═══════════════════════════════════════════════
       CONSOLE (MODAL)
    ═══════════════════════════════════════════════ */
    .console-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.55rem 0.875rem;
      background: var(--marrom-escuro);
      border-radius: var(--raio-md);
      cursor: pointer; transition: var(--trans);
      border: 1px solid rgba(196,130,42,0.2);
    }
    .console-toggle:hover { background: #3a2018; }
    .console-toggle-label { display:flex; align-items:center; gap:0.5rem; color: var(--creme-medio); font-size:0.8rem; font-weight:600; }
    .console-toggle-label i { color: var(--ocre); font-size:0.75rem; }
    .console-badge {
      display: inline-flex; align-items: center; justify-content: center;
      min-width: 18px; height: 18px; padding: 0 5px;
      background: var(--ocre); color: var(--marrom-escuro);
      border-radius: 100px; font-size: 0.65rem; font-weight: 800;
    }

    /* ═══════════════════════════════════════════════
       COLUNA DIREITA — TOPO: ATA ATUAL
    ═══════════════════════════════════════════════ */
.ata-panel {
  border-bottom: var(--borda-papel);
  display: flex; flex-direction: column;
  overflow: hidden;
  min-height: 0;
}
    .ata-panel-header {
      padding: 1rem 1.5rem;
      border-bottom: var(--borda-papel);
      display: flex; align-items: center; gap: 1rem;
      background: linear-gradient(180deg, var(--creme-claro) 0%, var(--creme-base) 100%);
      flex-shrink: 0;
    }
    .ata-panel-titulo {
      font-family: var(--fonte-titulo); font-size: 1.1rem;
      color: var(--marrom-escuro); flex:1; min-width:0;
    }
    .ata-panel-titulo span { font-style: italic; opacity:0.5; font-size:0.9rem; }
    .ata-acoes { display:flex; gap:0.4rem; flex-shrink:0; }
    .ata-corpo {
      flex:1; overflow-y:auto; padding:1.5rem 2rem;
      min-height: 0;
    }
    .ata-conteudo-html {
      max-width: 780px; margin: 0 auto;
      font-size: 0.9rem; line-height: 1.8; color: var(--marrom-escuro);
    }
    /* Estilos da ata renderizada */
    .ata-conteudo-html h1 {
      font-family: var(--fonte-titulo); font-size: 1.6rem;
      color: var(--marrom-escuro); margin: 0 0 1.25rem;
      padding-bottom: 0.75rem; border-bottom: 2px solid var(--creme-escuro);
    }
    .ata-conteudo-html h2 {
      font-family: var(--fonte-titulo); font-size: 1.2rem;
      color: var(--marrom-medio); margin: 1.75rem 0 0.75rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .ata-conteudo-html h2::before {
      content:''; width:3px; height:1em; background:var(--ocre); border-radius:2px; flex-shrink:0;
    }
    .ata-conteudo-html h3 {
      font-family: var(--fonte-titulo); font-size: 1rem;
      color: var(--marrom-escuro); margin: 1.25rem 0 0.5rem;
    }
    .ata-conteudo-html p { margin-bottom: 0.875rem; }
    .ata-conteudo-html ul, .ata-conteudo-html ol { padding-left: 1.5rem; margin-bottom: 0.875rem; }
    .ata-conteudo-html li { margin-bottom: 0.4rem; }
    .ata-conteudo-html strong { color: var(--marrom-escuro); font-weight: 700; }
    .ata-conteudo-html em { color: var(--marrom-claro); }
    .ata-conteudo-html hr { border:none; border-top: 1px solid var(--creme-escuro); margin: 1.5rem 0; }
    .ata-conteudo-html table {
      width:100%; border-collapse:collapse; margin: 1rem 0; font-size:0.85rem;
    }
    .ata-conteudo-html th {
      background: var(--marrom-escuro); color: var(--creme-claro);
      padding: 0.5rem 0.875rem; text-align:left; font-weight:700; font-size:0.78rem;
    }
    .ata-conteudo-html td {
      padding: 0.5rem 0.875rem; border-bottom: 1px solid var(--creme-escuro);
      vertical-align:top;
    }
    .ata-conteudo-html tr:nth-child(even) td { background: rgba(217,204,170,0.2); }
    .ata-conteudo-html blockquote {
      border-left: 3px solid var(--ocre);
      padding: 0.5rem 1rem; margin: 0.875rem 0;
      background: var(--ocre-claro); border-radius: 0 var(--raio) var(--raio) 0;
      font-style: italic; color: var(--marrom-medio);
    }

    .ata-vazia {
      display: flex; flex-direction: column; align-items:center; justify-content:center;
      height: 220px; text-align: center; color: var(--marrom-claro);
    }
    .ata-vazia i { font-size: 2.5rem; opacity:0.2; margin-bottom: 0.75rem; }
    .ata-vazia h3 { font-family: var(--fonte-titulo); font-size: 1.1rem; margin-bottom: 0.3rem; opacity:0.6; }
    .ata-vazia p { font-size: 0.82rem; opacity:0.5; }

    /* ═══════════════════════════════════════════════
       PAINEL INFERIOR: CATÁLOGO + BUSCADOR
    ═══════════════════════════════════════════════ */
.catalogo-panel {
  overflow: hidden; display: flex; flex-direction: column;
  min-height: 0;       /* permite encolher dentro do grid */
}
    .catalogo-toolbar {
      padding: 0.875rem 1.5rem;
      border-bottom: var(--borda-papel);
      background: var(--creme-claro);
      display: flex; align-items: center; gap: 0.875rem;
      flex-shrink: 0;
    }
    .catalogo-toolbar-titulo {
      font-family: var(--fonte-titulo); font-size: 0.95rem; color: var(--marrom-escuro);
    }
    .busca-wrap { position:relative; flex:1; max-width: 300px; }
    .busca-wrap i { position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); color:var(--marrom-claro); font-size:0.75rem; }
    .busca-input {
      width:100%; padding: 0.45rem 0.875rem 0.45rem 2.25rem;
      background: var(--creme-base); border: 1px solid var(--creme-escuro);
      border-radius: 100px; font-family:var(--fonte-corpo); font-size:0.8rem;
      color:var(--marrom-escuro); transition:var(--trans);
    }
    .busca-input:focus { outline:none; border-color:var(--ocre); box-shadow: 0 0 0 3px rgba(196,130,42,0.1); }

    /* Filtro responsáveis */
    .filtros-resp {
      display: flex; gap: 0.35rem; flex-wrap: wrap; padding: 0.5rem 1.5rem;
      border-bottom: var(--borda-papel); background: var(--creme-base);
      flex-shrink: 0; min-height: 0;
    }
    .chip-resp {
      display: inline-flex; align-items: center; gap: 0.3rem;
      padding: 0.25rem 0.625rem;
      border-radius: 100px; font-size: 0.72rem; font-weight: 700;
      border: 1px solid var(--creme-escuro);
      background: var(--creme-claro); color: var(--marrom-medio);
      cursor: pointer; transition: var(--trans);
    }
    .chip-resp:hover { border-color: var(--ocre); color: var(--ocre); }
    .chip-resp.ativo { background: var(--ocre); color: white; border-color: var(--ocre); }
    .chip-resp i { font-size: 0.6rem; }

    /* Lista projetos + reuniões */
    .catalogo-lista { flex:1; overflow-y:auto; padding: 0.875rem 1.5rem; display:flex; flex-direction:column; gap:0.5rem; }

    .projeto-grupo {
      border: var(--borda-papel);
      border-radius: var(--raio-md);
      overflow: hidden;
      background: var(--creme-claro);
      transition: var(--trans);
    }
    .projeto-grupo:hover { box-shadow: var(--sombra-papel); }

    .projeto-header {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.625rem 1rem; cursor: pointer;
      background: linear-gradient(135deg, rgba(217,204,170,0.3) 0%, transparent 100%);
      transition: var(--trans); user-select:none;
    }
    .projeto-header:hover { background: linear-gradient(135deg, rgba(196,130,42,0.1) 0%, transparent 100%); }

    .proj-icone {
      width: 30px; height: 30px; flex-shrink:0; border-radius: var(--raio);
      background: var(--marrom-escuro);
      display: flex; align-items: center; justify-content: center;
    }
    .proj-icone i { color: var(--ocre); font-size: 0.72rem; }
    .proj-nome { flex:1; font-weight: 700; font-size: 0.85rem; color: var(--marrom-escuro); min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .proj-meta { font-size: 0.7rem; color: var(--marrom-claro); display:flex; gap:0.5rem; flex-shrink:0; }
    .proj-badge {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 7px; border-radius: 100px;
      font-size: 0.68rem; font-weight: 700;
      background: var(--ocre-claro); color: var(--ocre-hover);
    }
    .proj-chevron { color: var(--marrom-claro); font-size: 0.7rem; transition: transform 0.25s ease; flex-shrink:0; }
    .proj-chevron.aberto { transform: rotate(180deg); }

    .proj-reunioes { display:none; border-top: var(--borda-papel); }
    .proj-reunioes.aberto { display:block; }

    .reuniao-linha {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 1rem 0.5rem 2.5rem;
      border-bottom: 1px solid rgba(44,24,16,0.04);
      transition: var(--trans);
      cursor: pointer;
    }
    .reuniao-linha:last-child { border-bottom:none; }
    .reuniao-linha:hover { background: var(--ocre-claro); }
    .reuniao-dot { width:6px; height:6px; border-radius:50%; background:var(--ocre); flex-shrink:0; }
    .reuniao-nome { flex:1; font-size:0.82rem; font-weight:600; color:var(--marrom-escuro); min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .reuniao-data { font-size:0.7rem; color:var(--marrom-claro); flex-shrink:0; }
    .reuniao-acoes { display:flex; gap:2px; flex-shrink:0; }

    /* Não catalogadas */
    .nc-grupo { border: 1.5px dashed rgba(196,130,42,0.35); border-radius: var(--raio-md); overflow:hidden; }
    .nc-grupo .projeto-header { background: linear-gradient(135deg, rgba(196,130,42,0.08) 0%, transparent 100%); }
    .nc-grupo .proj-icone { background: var(--ocre); }
    .nc-grupo .proj-icone i { color: white; }
    .nc-grupo .proj-nome { color: var(--ocre-hover); }
    .nc-grupo .proj-badge { background: rgba(196,130,42,0.15); }
    .nc-grupo .reuniao-dot { background: var(--ocre); }

    .btn-associar {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 7px; border-radius: var(--raio);
      border: 1px solid rgba(196,130,42,0.3);
      background: none; color: var(--ocre-hover); font-size: 0.68rem;
      font-weight: 700; cursor: pointer; transition: var(--trans);
      font-family: var(--fonte-corpo);
    }
    .btn-associar:hover { background: var(--ocre-claro); border-color: var(--ocre); }

    /* ═══════════════════════════════════════════════
       MODAIS BASE
    ═══════════════════════════════════════════════ */
    .modal-overlay {
      position: fixed; inset:0;
      background: rgba(44,24,16,0.55);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity:0; visibility:hidden; transition: var(--trans);
    }
    .modal-overlay.visivel { opacity:1; visibility:visible; }
    .modal-caixa {
      background: var(--creme-claro);
      border-radius: var(--raio-lg);
      border: 1px solid var(--creme-escuro);
      box-shadow: var(--sombra-flutuante);
      max-width: 860px; width: 94%;
      max-height: 90vh; overflow: hidden;
      transform: scale(0.94) translateY(12px);
      transition: var(--trans);
      display: flex; flex-direction: column;
    }
    .modal-overlay.visivel .modal-caixa { transform: scale(1) translateY(0); }
    .modal-caixa.larga { max-width: 1060px; }
    .modal-caixa.estreita { max-width: 520px; }

    .modal-header {
      padding: 1rem 1.5rem; border-bottom: var(--borda-papel);
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(180deg, var(--creme-medio) 0%, var(--creme-claro) 100%);
      flex-shrink:0;
    }
    .modal-titulo { font-family: var(--fonte-titulo); font-size: 1.1rem; color: var(--marrom-escuro); }
    .modal-fechar {
      background:none; border:none; color:var(--marrom-claro); font-size:1rem;
      cursor:pointer; padding:0.35rem; border-radius:var(--raio); transition:var(--trans);
    }
    .modal-fechar:hover { background: rgba(139,46,46,0.08); color:var(--vermelho-vintage); }
    .modal-body { padding:1.5rem; overflow-y:auto; flex:1; }

    /* Tabs do modal de ata */
    .modal-tabs { display:flex; gap:0; border-bottom: 2px solid var(--creme-escuro); margin-bottom:1.25rem; }
    .modal-tab {
      padding: 0.6rem 1.25rem; border:none; background:none;
      font-family:var(--fonte-corpo); font-size:0.82rem; font-weight:700;
      color:var(--marrom-claro); cursor:pointer; transition:var(--trans);
      border-bottom: 2.5px solid transparent; margin-bottom:-2px;
    }
    .modal-tab:hover { color:var(--marrom-escuro); }
    .modal-tab.ativo { color:var(--ocre); border-bottom-color:var(--ocre); }
    .modal-tab-conteudo { display:none; }
    .modal-tab-conteudo.ativo { display:block; animation:fadeIn 0.25s ease-out; }

    .modal-meta {
      display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1.25rem;
    }
    .meta-chip {
      display:inline-flex; align-items:center; gap:0.3rem;
      padding: 0.3rem 0.7rem;
      background: var(--creme-base); border: var(--borda-papel);
      border-radius: 100px; font-size:0.75rem; font-weight:600;
      color:var(--marrom-medio);
    }
    .meta-chip i { font-size:0.65rem; color:var(--ocre); }
    .meta-chip a { color:var(--azul-vintage); text-decoration:none; display:flex; align-items:center; gap:3px; }

    .modal-rodape {
      padding: 1rem 1.5rem; border-top: var(--borda-papel);
      display:flex; gap:0.5rem; justify-content:flex-end; flex-wrap:wrap;
      background: var(--creme-base); flex-shrink:0;
    }

    .conteudo-texto {
      background: var(--creme-base);
      border: var(--borda-papel); border-radius: var(--raio-md);
      padding: 1.25rem; max-height: 420px; overflow-y:auto;
      font-size:0.87rem; line-height:1.8; color:var(--marrom-escuro);
    }
    .conteudo-texto h1 { font-family:var(--fonte-titulo); font-size:1.4rem; color:var(--marrom-escuro); margin:0 0 1rem; padding-bottom:0.5rem; border-bottom:2px solid var(--creme-escuro); }
    .conteudo-texto h2 { font-family:var(--fonte-titulo); font-size:1.1rem; color:var(--marrom-medio); margin:1.5rem 0 0.6rem; }
    .conteudo-texto h3 { font-family:var(--fonte-titulo); font-size:0.95rem; color:var(--marrom-escuro); margin:1rem 0 0.4rem; }
    .conteudo-texto table { width:100%; border-collapse:collapse; margin:0.875rem 0; font-size:0.82rem; }
    .conteudo-texto th { background:var(--marrom-escuro); color:var(--creme-claro); padding:0.4rem 0.75rem; text-align:left; font-size:0.75rem; }
    .conteudo-texto td { padding:0.4rem 0.75rem; border-bottom:1px solid var(--creme-escuro); }
    .conteudo-texto tr:nth-child(even) td { background:rgba(217,204,170,0.2); }
    .conteudo-texto strong { color:var(--marrom-escuro); }
    .conteudo-texto ul, .conteudo-texto ol { padding-left:1.5rem; margin-bottom:0.75rem; }
    .conteudo-texto hr { border:none; border-top:1px solid var(--creme-escuro); margin:1.25rem 0; }

    /* ═══════════════════════════════════════════════
       MODAL CONSOLE
    ═══════════════════════════════════════════════ */
    .console-logs {
      background: var(--marrom-escuro);
      border-radius: var(--raio-md);
      padding: 0.875rem; height: 380px;
      overflow-y: auto; font-family: 'Courier New', monospace;
      font-size: 0.78rem; line-height: 1.8;
    }
    .log-linha { display:flex; gap:0.625rem; padding:0.2rem 0; border-bottom:1px solid rgba(255,255,255,0.04); }
    .log-hora { color: rgba(245,239,224,0.3); flex-shrink:0; }
    .log-tag {
      flex-shrink:0; padding:0 0.45rem; border-radius:3px;
      font-size:0.65rem; font-weight:700; text-transform:uppercase;
      align-self:flex-start; margin-top:2px;
    }
    .log-tag.INFO { background: rgba(46,74,107,0.3); color:#7aadd9; }
    .log-tag.SUCESSO { background: rgba(74,103,65,0.3); color:#8ecf8a; }
    .log-tag.ERRO { background: rgba(139,46,46,0.3); color:#e08080; }
    .log-tag.ALERTA { background: rgba(196,130,42,0.25); color:#e6c07a; }
    .log-msg { flex:1; word-break:break-word; color:rgba(245,239,224,0.8); }
    .console-vazio { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:rgba(245,239,224,0.2); gap:0.4rem; }
    .console-vazio i { font-size:1.75rem; }

    /* ═══════════════════════════════════════════════
       MODAL ASSOCIAR PROJETO
    ═══════════════════════════════════════════════ */
    .assoc-busca { position:relative; margin-bottom:0.875rem; }
    .assoc-busca i { position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); color:var(--marrom-claro); font-size:0.75rem; }
    .assoc-busca input { width:100%; padding:0.55rem 0.875rem 0.55rem 2.25rem; border:1px solid var(--creme-escuro); border-radius:var(--raio-md); background:var(--creme-base); font-family:var(--fonte-corpo); font-size:0.85rem; color:var(--marrom-escuro); transition:var(--trans); }
    .assoc-busca input:focus { outline:none; border-color:var(--ocre); box-shadow:0 0 0 3px rgba(196,130,42,0.1); }

    .resp-grupo-titulo {
      font-size:0.68rem; font-weight:800; letter-spacing:1.5px; text-transform:uppercase;
      color:var(--marrom-claro); padding: 0.5rem 0 0.35rem;
      display:flex; align-items:center; gap:0.5rem;
      border-top: var(--borda-papel); margin-top:0.5rem;
    }
    .resp-grupo-titulo:first-child { border-top:none; margin-top:0; }

    .projeto-opcao {
      display:flex; align-items:center; gap:0.75rem;
      padding:0.6rem 0.875rem; border-radius:var(--raio-md);
      border: 1.5px solid transparent; cursor:pointer; transition:var(--trans);
      margin-bottom:0.25rem; background:var(--creme-base);
    }
    .projeto-opcao:hover { border-color:var(--marrom-escuro); background:var(--creme-medio); }
    .projeto-opcao.selecionado { border-color:var(--ocre); background:var(--ocre-claro); }
    .proj-opcao-icone { width:30px; height:30px; background:var(--marrom-escuro); border-radius:var(--raio); display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .proj-opcao-icone i { color:var(--ocre); font-size:0.72rem; }
    .proj-opcao-nome { font-weight:700; font-size:0.82rem; color:var(--marrom-escuro); }
    .proj-opcao-meta { font-size:0.7rem; color:var(--marrom-claro); }
    .lista-scroll { max-height:320px; overflow-y:auto; padding-right:4px; }

    /* ═══════════════════════════════════════════════
       MODAL EMAIL
    ═══════════════════════════════════════════════ */
    .chips-email { display:flex; flex-wrap:wrap; gap:0.35rem; padding:0.75rem; background:var(--creme-base); border:var(--borda-papel); border-radius:var(--raio-md); min-height:50px; margin-bottom:0.75rem; }
    .email-chip {
      display:inline-flex; align-items:center; gap:0.35rem;
      padding:0.3rem 0.625rem; border-radius:100px;
      border: 1.5px solid var(--creme-escuro);
      background:var(--creme-claro); color:var(--marrom-medio);
      font-size:0.75rem; font-weight:600; cursor:pointer; transition:var(--trans);
    }
    .email-chip:hover { border-color:var(--ocre); }
    .email-chip.sel { background:var(--ocre-claro); border-color:var(--ocre); color:var(--ocre-hover); }

    /* ═══════════════════════════════════════════════
       LOADING OVERLAY
    ═══════════════════════════════════════════════ */
    .loading-overlay {
      position:fixed; inset:0;
      background: rgba(44,24,16,0.88); backdrop-filter:blur(8px);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:2000; opacity:0; visibility:hidden; transition:var(--trans);
    }
    .loading-overlay.visivel { opacity:1; visibility:visible; }
    .loading-spinner {
      width:52px; height:52px; position:relative; margin-bottom:1.5rem;
    }
    .loading-spinner::before, .loading-spinner::after {
      content:''; position:absolute; border-radius:50%; animation: spin 1.4s linear infinite;
    }
    .loading-spinner::before {
      inset:0; border:3px solid transparent;
      border-top-color:var(--ocre); border-right-color:var(--ocre);
    }
    .loading-spinner::after {
      inset:20%; border:3px solid transparent;
      border-top-color:rgba(245,239,224,0.7);
      animation-duration:0.9s; animation-direction:reverse;
    }
    .loading-texto { font-family:var(--fonte-titulo); font-size:1.1rem; color:var(--creme-claro); margin-bottom:1rem; }
    .loading-bar { width:180px; height:3px; background:rgba(245,239,224,0.15); border-radius:2px; overflow:hidden; }
    .loading-bar-fill { height:100%; background:linear-gradient(90deg,var(--ocre),#e6c07a,var(--ocre)); background-size:200%; animation:loadBar 1.5s ease-in-out infinite; width:40%; }

    /* ═══════════════════════════════════════════════
       TOAST
    ═══════════════════════════════════════════════ */
    #toasts { position:fixed; top:16px; right:16px; z-index:9999; display:flex; flex-direction:column; gap:8px; }
    .toast {
      min-width:260px; max-width:380px; padding:12px 16px;
      border-radius:var(--raio-md); font-family:var(--fonte-corpo);
      font-size:0.82rem; font-weight:600; color:var(--creme-claro);
      display:flex; align-items:center; gap:8px;
      box-shadow: 0 8px 24px rgba(44,24,16,0.25);
      animation: toastIn 0.35s ease-out;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .toast.saindo { animation: toastOut 0.25s ease-in forwards; }
    .toast.sucesso { background: var(--verde-vintage); }
    .toast.erro { background: var(--vermelho-vintage); }
    .toast.aviso { background: var(--ocre); color: var(--marrom-escuro); }
    .toast.info { background: var(--azul-vintage); }
    .toast i { flex-shrink:0; }
    .toast-fechar { margin-left:auto; background:none; border:none; color:inherit; opacity:0.6; cursor:pointer; padding:2px; }
    .toast-fechar:hover { opacity:1; }

    /* ═══════════════════════════════════════════════
       SKELETON
    ═══════════════════════════════════════════════ */
    .skeleton {
      background: linear-gradient(90deg, var(--creme-medio) 25%, var(--creme-escuro) 50%, var(--creme-medio) 75%);
      background-size:400%; animation: skeletonShimmer 1.5s ease-in-out infinite;
      border-radius:var(--raio);
    }

    /* ═══════════════════════════════════════════════
       BADGES
    ═══════════════════════════════════════════════ */
    .badge { display:inline-flex; align-items:center; gap:3px; padding:2px 8px; border-radius:100px; font-size:0.68rem; font-weight:700; }
    .badge.tem { background:var(--verde-claro); color:var(--verde-vintage); }
    .badge.nao { background:rgba(44,24,16,0.05); color:var(--marrom-claro); }

    /* ═══════════════════════════════════════════════
       SCROLLBAR
    ═══════════════════════════════════════════════ */
    ::-webkit-scrollbar { width:5px; height:5px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:var(--creme-escuro); border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background:var(--marrom-claro); }
    .console-logs::-webkit-scrollbar-thumb { background:rgba(245,239,224,0.15); }

    /* ═══════════════════════════════════════════════
       RESPONSIVO
    ═══════════════════════════════════════════════ */
    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
      .coluna-esq { border-right:none; border-bottom: var(--borda-papel); }
      .coluna-dir { grid-template-rows: 1fr auto; }
    }
    @media (max-width: 600px) {
      .header { padding: 0 1rem; }
      .header-inner { flex-wrap:wrap; gap:0; }
      .header-logo { padding:0.75rem 1rem 0.75rem 0; }
      .header-nav { padding: 0.35rem 0; width:100%; }
      .coluna-esq, .catalogo-lista { padding: 1rem; }
    }

    /* Separador ornamental */
    .ornamento {
      display:flex; align-items:center; gap:0.5rem;
      font-size:0.65rem; color:var(--creme-escuro); letter-spacing:3px;
      text-align:center; margin: 0.5rem 0;
    }
    .ornamento::before, .ornamento::after { content:''; flex:1; height:1px; background:var(--creme-escuro); }


/* ═══════════════════════════════════════════════
   BANNER ALERTA NÃO CATALOGADAS
═══════════════════════════════════════════════ */
#bannerNaoCatalogadas {
  background: var(--vermelho-vintage);
  color: #FAF7F0;
  padding: 0.55rem 2rem;
  font-size: 0.8rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  letter-spacing: 0.3px;
  animation: fadeIn 0.4s ease-out;
  position: sticky;
  top: 60px;
  z-index: 150;
  border-bottom: 2px solid rgba(0,0,0,0.15);
}
#bannerNaoCatalogadas i { font-size: 0.85rem; flex-shrink: 0; }

/* ═══════════════════════════════════════════════
   RESPONSIVO MOBILE — SOBRESCREVE BREAKPOINTS
═══════════════════════════════════════════════ */

/* Tablet (≤900px) */
@media (max-width: 900px) {
  .main-grid {
    grid-template-columns: 1fr;
    min-height: auto;
  }
  .coluna-esq {
    border-right: none;
    border-bottom: var(--borda-papel);
    max-height: none;
    overflow-y: visible;
  }
  .coluna-dir {
    grid-template-rows: auto 1fr;
    min-height: 70vh;
  }
  .ata-panel {
    min-height: 300px;
    max-height: 50vh;
  }
  .catalogo-panel {
    min-height: 280px;
  }
}

/* Mobile (≤600px) */
@media (max-width: 600px) {

  /* ── HEADER ── */
  .header { padding: 0 0.875rem; }
  .header-inner {
    flex-wrap: wrap;
    align-items: center;
    gap: 0;
  }

  /* Linha 1: Logo (cresce) + Console (direita) */
  .header-logo {
    flex: 1;
    padding: 0.65rem 0;
    border-right: none;
    margin-right: 0;
  }
  .logo-text { font-size: 0.95rem; }
  .logo-icon { width: 28px; height: 28px; }
  .logo-icon i { font-size: 0.8rem; }

  .header-status {
    flex-shrink: 0;
    gap: 0.35rem;
    padding: 0.65rem 0;
  }
  .header-status .pill-status { display: none !important; }
  .header-status .btn-sm { padding: 0.38rem 0.65rem; font-size: 0.75rem; }

  /* Linha 2: Nav ocupa linha inteira */
  .header-nav {
    flex-basis: 100%;   /* ← força nova linha */
    width: 100%;
    flex-wrap: wrap;    /* links quebram se não couber */
    gap: 0.2rem;
    padding: 0.35rem 0 0.5rem;
    border-top: 1px solid rgba(255,255,255,0.08);
    overflow: visible;
  }

  .nav-link {
    padding: 0.4rem 0.8rem;
    font-size: 0.76rem;
    font-weight: 700;
    flex-shrink: 0;
    white-space: nowrap;
    border-radius: var(--raio);
  }
  .nav-link i { display: inline; margin-right: 0.3rem; }
  /* Indicador ativo: fundo em vez de sublinhado */
  .nav-link.ativo::after { display: none; }
  .nav-link.ativo { background: rgba(196,130,42,0.18); color: var(--ocre); }

  /* ── BANNER ── */
  #bannerNaoCatalogadas {
    top: 0;
    position: relative;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    flex-wrap: wrap;
    text-align: center;
    justify-content: center;
  }

  /* ── COLUNAS ── */
  .coluna-esq { padding: 0.875rem; gap: 0.875rem; }
  .card-body { padding: 0.875rem; }
  .card-header { padding: 0.625rem 0.875rem; }
  .timer-display { font-size: 2.2rem; }
  .controles-grav { flex-wrap: wrap; }
  .controles-grav .btn { font-size: 0.78rem; padding: 0.6rem 0.875rem; }
  .dropzone { padding: 1.25rem 0.875rem; }
  .dropzone i { font-size: 1.5rem; }
  .dropzone h3 { font-size: 0.82rem; }

  /* ── ATA ── */
  .ata-panel { min-height: 200px; max-height: 45vh; }
  .ata-panel-header { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
  .ata-panel-titulo { font-size: 0.9rem; }
  .ata-acoes { width: 100%; justify-content: flex-end; }
  .ata-corpo { padding: 1rem; }
  .ata-conteudo-html { font-size: 0.85rem; }
  .ata-conteudo-html h1 { font-size: 1.3rem; }
  .ata-conteudo-html h2 { font-size: 1rem; }
  .ata-conteudo-html table { font-size: 0.78rem; display: block; overflow-x: auto; }

  /* ── CATÁLOGO ── */
  .catalogo-toolbar { padding: 0.625rem 0.875rem; flex-wrap: wrap; gap: 0.5rem; }
  .catalogo-toolbar-titulo { font-size: 0.85rem; }
  .busca-wrap { max-width: 100%; width: 100%; order: 3; }
  .filtros-resp { padding: 0.4rem 0.875rem; }
  .catalogo-lista { padding: 0.625rem 0.875rem; }
  .reuniao-linha { padding: 0.45rem 0.875rem 0.45rem 1.875rem; }
  .reuniao-nome { font-size: 0.78rem; }
  .reuniao-data { display: none; }
  .btn-associar { font-size: 0.65rem; padding: 2px 6px; }
  .proj-nome { font-size: 0.82rem; }
  .proj-meta { display: none; }

  /* ── MODAIS ── */
  .modal-caixa { width: 98%; max-height: 95vh; }
  .modal-body { padding: 1rem; }
  .modal-rodape { padding: 0.75rem 1rem; }
  .modal-header { padding: 0.75rem 1rem; }
  .conteudo-texto { max-height: 55vh; }
  .conteudo-texto table { display: block; overflow-x: auto; font-size: 0.78rem; }
  .console-logs { height: 260px; font-size: 0.72rem; }
  .lista-scroll { max-height: 240px; }
  .modal-meta { gap: 0.35rem; }
  .meta-chip { font-size: 0.7rem; padding: 0.25rem 0.5rem; }
}

/* Scroll horizontal suave no header em mobile */
@media (max-width: 600px) {
  .header-inner::-webkit-scrollbar { display: none; }
  .header-inner { -ms-overflow-style: none; scrollbar-width: none; }
  .header-nav::-webkit-scrollbar { display: none; }
}

  </style>
</head>
<body>

<!-- Toast Container -->
<div id="toasts"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-texto" id="loadingTexto">Processando com IA</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- ═══ HEADER ═══ -->
<header class="header">
  <div class="header-inner">
    <a href="#" class="header-logo">
      <div class="logo-icon"><i class="fas fa-microphone-lines"></i></div>
      <span class="logo-text">Smart <em>Meeting</em></span>
    </a>
    <nav class="header-nav">
      <a href="#" class="nav-link ativo" data-pagina="reunioes"><i class="fas fa-video"></i> Reuniões</a>
      <a href="#" class="nav-link" data-pagina="relatorios"><i class="fas fa-clipboard-check"></i> Relatórios IA</a>
      <a href="#" class="nav-link" data-pagina="projeto"><i class="fas fa-project-diagram"></i> Projetos</a>
    </nav>
    <div class="header-status">
      <div class="pill-status" id="pillChave">
        <span class="dot"></span>
        <span>Chave API</span>
      </div>
      <div class="pill-status" id="pillDrive">
        <span class="dot"></span>
        <span>Drive</span>
      </div>
      <button class="btn btn-sm btn-secundario" style="border-color:rgba(245,239,224,0.15);color:rgba(245,239,224,0.55);background:rgba(255,255,255,0.06);" onclick="abrirConsole()">
        <i class="fas fa-terminal"></i> Console
        <span class="console-badge" id="badgeConsole" style="display:none">0</span>
      </button>
    </div>
  </div>
</header>

<div id="bannerNaoCatalogadas" style="display:none;">
  <i class="fas fa-exclamation-triangle"></i>
  <span id="bannerNaoCatalogadasTexto"></span>
  <button onclick="scrollParaNaoCatalogadas()" style="margin-left:0.75rem;background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.3);color:#fff;padding:3px 10px;border-radius:100px;cursor:pointer;font-size:0.72rem;font-weight:700;font-family:var(--fonte-corpo);">Ver reuniões</button>
</div>

<!-- ═══ GRID PRINCIPAL ═══ -->
<div class="main-grid">

  <!-- ══ COLUNA ESQUERDA ══ -->
  <aside class="coluna-esq">

    <!-- Gravação -->
    <div class="card fade-in-up">
      <div class="card-header">
        <div class="card-titulo"><i class="fas fa-microphone"></i> Gravar Reunião</div>
        <span id="statusGrav" style="font-size:0.72rem;font-weight:700;letter-spacing:0.8px;color:var(--marrom-claro);">PRONTO</span>
      </div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:1rem;">
        <div class="gravacao-visual" id="visualContainer">
          <canvas id="visualCanvas"></canvas>
          <div class="gravacao-placeholder" id="visualPlaceholder">
            <i class="fas fa-waveform-lines"></i>
            <span>Visualização de áudio</span>
          </div>
        </div>
        <div>
          <div class="timer-display" id="timerDisplay">00:00:00</div>
          <div class="status-grav" id="statusGravLabel">Aguardando...</div>
        </div>
        <div class="controles-grav">
          <button class="btn btn-primario" id="btnIniciar" onclick="iniciarGravacao()">
            <i class="fas fa-circle"></i> Iniciar
          </button>
          <button class="btn btn-secundario" id="btnPausar" onclick="pausarGravacao()" disabled>
            <i class="fas fa-pause"></i>
          </button>
          <button class="btn btn-vermelho" id="btnParar" onclick="pararGravacao()" disabled>
            <i class="fas fa-stop"></i> Encerrar
          </button>
        </div>
      </div>
    </div>

    <!-- Upload -->
    <div class="card fade-in-up">
      <div class="card-header">
        <div class="card-titulo"><i class="fas fa-file-audio"></i> Enviar Áudio</div>
      </div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:0.875rem;">

        <div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-cloud-arrow-up"></i>
          <h3>Arraste o áudio aqui</h3>
          <p>ou clique para selecionar · MP3, WAV, WebM, M4A até 500MB</p>
        </div>
        <input type="file" id="fileInput" style="display:none" accept="audio/*" onchange="onFileSelect(event)">

        <div class="arquivo-preview" id="arquivoPreview" style="display:none">
          <i class="fas fa-file-audio"></i>
          <div style="flex:1;min-width:0">
            <div class="arquivo-nome" id="arquivoNome">—</div>
            <div class="arquivo-tam" id="arquivoTam">—</div>
          </div>
          <button class="btn-remover" onclick="removerArquivo()" title="Remover"><i class="fas fa-times"></i></button>
        </div>

        <div class="form-grupo">
          <label class="form-label">Título da Reunião</label>
          <input type="text" class="form-input" id="inputTitulo" placeholder="Ex: Reunião de Sprint Planning">
        </div>
        <div class="form-grupo" style="margin-bottom:0">
          <label class="form-label">Participantes</label>
          <input type="text" class="form-input" id="inputParticipantes" placeholder="João, Maria, Pedro...">
        </div>

        <div class="progresso-wrap" id="progressoWrap">
          <div class="progresso-trilha"><div class="progresso-fill" id="progressoFill"></div></div>
          <div class="progresso-info"><span id="progressoTexto">Enviando...</span><span id="progressoPct">0%</span></div>
        </div>

        <button class="btn btn-verde" id="btnEnviar" onclick="enviarAudio()" disabled style="width:100%;justify-content:center;">
          <i class="fas fa-paper-plane"></i> Processar com IA
        </button>
      </div>
    </div>

  </aside>

  <!-- ══ COLUNA DIREITA ══ -->
  <section class="coluna-dir">

    <!-- ATA ATUAL — painel superior -->
    <div class="ata-panel">
      <div class="ata-panel-header">
        <div class="ata-panel-titulo" id="ataPainelTitulo">
          <i class="fas fa-file-lines" style="color:var(--ocre);margin-right:0.5rem;font-size:0.9rem;"></i>
          Ata da Reunião <span id="ataPainelSubtitulo">— nenhuma selecionada</span>
        </div>
        <div class="ata-acoes" id="ataAcoes" style="display:none">
          <button class="btn btn-sm btn-secundario" onclick="copiarAtaAtual()"><i class="fas fa-copy"></i> Copiar</button>
          <button class="btn btn-sm btn-primario" onclick="abrirEmailAtaAtual()"><i class="fas fa-envelope"></i> Enviar</button>
        </div>
      </div>
      <div class="ata-corpo" id="ataCorpo">
        <div class="ata-vazia" id="ataVazia">
          <i class="fas fa-book-open"></i>
          <h3>Nenhuma ata selecionada</h3>
          <p>Selecione uma reunião no catálogo abaixo ou processe um novo áudio</p>
        </div>
        <div class="ata-conteudo-html" id="ataConteudo" style="display:none"></div>
      </div>
    </div>

    <!-- CATÁLOGO — painel inferior -->
    <div class="catalogo-panel">
      <div class="catalogo-toolbar">
        <div class="catalogo-toolbar-titulo"><i class="fas fa-book-bookmark" style="color:var(--ocre);margin-right:0.4rem;font-size:0.85rem;"></i> Catálogo de Atas</div>
        <div class="busca-wrap">
          <i class="fas fa-magnifying-glass"></i>
          <input type="text" class="busca-input" id="buscaReuniao" placeholder="Buscar reunião ou projeto..." oninput="filtrarCatalogo()">
        </div>
        <button class="btn btn-sm btn-secundario" onclick="carregarCatalogo()"><i class="fas fa-rotate"></i></button>
      </div>

      <!-- Chips de responsáveis -->
      <div class="filtros-resp" id="filtrosResp">
        <span style="font-size:0.7rem;font-weight:700;color:var(--marrom-claro);align-self:center;letter-spacing:0.5px;">Filtrar:</span>
        <button class="chip-resp ativo" data-resp="todos" onclick="filtrarPorResp(this)">
          <i class="fas fa-users"></i> Todos
        </button>
      </div>

      <div class="catalogo-lista" id="catalogoLista">
        <!-- preenchido dinamicamente -->
        <div style="display:flex;flex-direction:column;gap:0.4rem">
          <div class="skeleton" style="height:40px;width:100%;"></div>
          <div class="skeleton" style="height:40px;width:100%;"></div>
          <div class="skeleton" style="height:40px;width:85%;"></div>
        </div>
      </div>
    </div>

  </section>
</div>

<!-- ══════════════════════════════════════════════
     MODAIS
══════════════════════════════════════════════ -->

<!-- Modal Console -->
<div class="modal-overlay" id="modalConsole">
  <div class="modal-caixa">
    <div class="modal-header">
      <div class="modal-titulo"><i class="fas fa-terminal" style="color:var(--ocre);margin-right:6px;"></i> Console de Logs</div>
      <button class="modal-fechar" onclick="fecharModal('modalConsole')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" style="padding:1rem;">
      <div class="console-logs" id="consoleLogs">
        <div class="console-vazio"><i class="fas fa-terminal"></i><span>Aguardando logs...</span></div>
      </div>
      <div style="display:flex;gap:0.5rem;margin-top:0.75rem;justify-content:flex-end;">
        <button class="btn btn-sm btn-secundario" onclick="limparLogs()"><i class="fas fa-trash"></i> Limpar</button>
        <button class="btn btn-sm btn-secundario" onclick="fecharModal('modalConsole')"><i class="fas fa-times"></i> Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalhes Reunião -->
<div class="modal-overlay" id="modalReuniao">
  <div class="modal-caixa larga">
    <div class="modal-header">
      <div class="modal-titulo" id="modalReuniaoTitulo">Detalhes da Reunião</div>
      <button class="modal-fechar" onclick="fecharModal('modalReuniao')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="modal-meta" id="modalReuniaoMeta"></div>
      <div class="modal-tabs">
        <button class="modal-tab ativo" data-tab="ata" onclick="trocarTab(this,'ata')"><i class="fas fa-file-lines"></i> Ata</button>
        <button class="modal-tab" data-tab="transcricao" onclick="trocarTab(this,'transcricao')"><i class="fas fa-microphone"></i> Transcrição</button>
      </div>
      <div class="modal-tab-conteudo ativo" id="tabAta">
        <div class="conteudo-texto" id="modalAtaTexto"><p style="color:var(--marrom-claro);text-align:center;padding:2rem"><i class="fas fa-spinner fa-spin"></i> Carregando...</p></div>
      </div>
      <div class="modal-tab-conteudo" id="tabTranscricao">
        <div class="conteudo-texto" id="modalTranscricaoTexto" style="white-space:pre-wrap;font-family:inherit;font-size:0.82rem;"></div>
      </div>
    </div>
    <div class="modal-rodape" id="modalReuniaoRodape"></div>
  </div>
</div>

<!-- Modal Associar Projeto -->
<div class="modal-overlay" id="modalAssociar">
  <div class="modal-caixa estreita">
    <div class="modal-header">
      <div class="modal-titulo"><i class="fas fa-tag" style="color:var(--ocre);margin-right:6px;"></i> Associar ao Projeto</div>
      <button class="modal-fechar" onclick="fecharModal('modalAssociar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.8rem;color:var(--marrom-claro);margin-bottom:1rem;">
        <i class="fas fa-video" style="color:var(--ocre);"></i>
        <strong id="assocTituloReuniao"></strong>
      </p>
      <div class="assoc-busca">
        <i class="fas fa-magnifying-glass"></i>
        <input type="text" id="assocBusca" placeholder="Buscar projeto..." oninput="filtrarProjetosAssoc()">
      </div>
      <div class="lista-scroll" id="listaProjetosAssoc">
        <div class="console-vazio" style="color:var(--marrom-claro);height:120px;"><i class="fas fa-spinner fa-spin"></i></div>
      </div>
      <div style="display:flex;gap:0.5rem;margin-top:1.25rem;justify-content:flex-end;">
        <button class="btn btn-sm btn-secundario" onclick="fecharModal('modalAssociar')">Cancelar</button>
        <button class="btn btn-sm btn-primario" onclick="confirmarAssociacao()"><i class="fas fa-check"></i> Confirmar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Email -->
<div class="modal-overlay" id="modalEmail">
  <div class="modal-caixa estreita">
    <div class="modal-header">
      <div class="modal-titulo"><i class="fas fa-envelope" style="color:var(--ocre);margin-right:6px;"></i> Enviar Ata por Email</div>
      <button class="modal-fechar" onclick="fecharModal('modalEmail')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-grupo">
        <label class="form-label">Destinatários Padrão (clique para selecionar)</label>
        <div class="chips-email" id="chipsEmailPadrao"></div>
      </div>
      <div class="form-grupo">
        <label class="form-label">Adicionar Email</label>
        <div style="display:flex;gap:0.5rem">
          <input type="email" class="form-input" id="inputNovoEmail" placeholder="email@exemplo.com" style="flex:1">
          <button class="btn btn-sm btn-secundario" onclick="addEmail()"><i class="fas fa-plus"></i></button>
        </div>
      </div>
      <div class="form-grupo" id="emailsAdicionadosWrap" style="display:none">
        <label class="form-label">Adicionados</label>
        <div class="chips-email" id="chipsEmailAdd"></div>
      </div>
      <div style="display:flex;gap:0.5rem;margin-top:1.25rem;justify-content:flex-end;">
        <button class="btn btn-sm btn-secundario" onclick="fecharModal('modalEmail')">Cancelar</button>
        <button class="btn btn-sm btn-verde" onclick="confirmarEmail()"><i class="fas fa-paper-plane"></i> Enviar</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     JAVASCRIPT
══════════════════════════════════════════════ -->
<script>
// ═══════════════════════════════════════
//  ESTADO GLOBAL
// ═══════════════════════════════════════
var mediaRecorder = null, chunksAudio = [], streamAudio = null;
var timerInterval = null, segsGravados = 0, gravPausada = false;
var arquivoAtual = null, audioCtx = null, analisador = null, animViz = null;
let cacheReuniao = [];    // cache local para o catálogo
let dadosCatalogo = { porProjeto:{}, semCatalogo:[] };
let reuniaoModalAtual = null; // dados da reunião aberta
let totalLogs = 0;

// Estado modal email
let emailReunId = null, emailAta = null;
let emailsSel = new Set(), emailsAdd = [];
let emailsPadrao = [];

// Estado modal associar
let assocReunId = null, assocProjSel = null;
let todosProjetosAssoc = [];

// Estado ATA atual no painel
let ataAtualReunId = null, ataAtualTexto = '';

// Constantes de envio
const FATIA_MB = 6 * 1024 * 1024;
const CHUNKS_PAR = 3;
const LOTE_UPLOAD = 3;

// ═══════════════════════════════════════
//  INICIALIZAÇÃO
// ═══════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  verificarConfig();
  carregarCatalogo();
  setupDropzone();
  log('INFO', '🚀 Smart Meeting inicializado');
});

// ═══════════════════════════════════════
//  CONFIGURAÇÃO / HEADER STATUS
// ═══════════════════════════════════════
function verificarConfig() {
  google.script.run
    .withSuccessHandler(r => {
      setPill('pillChave', r && r.temChaveApi, 'Chave API');
      setPill('pillDrive', r && r.temPastaDrive, r && r.nomePastaDrive ? 'Drive: ' + r.nomePastaDrive : 'Drive');
      if (r && r.temChaveApi) log('SUCESSO', '✅ Chave API Gemini configurada');
      if (r && r.temPastaDrive) log('SUCESSO', '✅ Pasta Drive: ' + r.nomePastaDrive);
    })
    .withFailureHandler(() => setPill('pillChave', false, 'Erro'))
    .verificarConfiguracaoReunioes();
}

function setPill(id, ok, label) {
  const el = document.getElementById(id);
  el.classList.toggle('ok', !!ok);
  el.classList.toggle('erro', !ok);
  el.querySelector('span:last-child').textContent = label;
}

// ═══════════════════════════════════════
//  GRAVAÇÃO
// ═══════════════════════════════════════
async function iniciarGravacao() {
  try {
    log('INFO', '🎙️ Solicitando microfone...');
    streamAudio = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true } });
    setupVisualizador(streamAudio);

    const tipos = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
    const tipo = tipos.find(t => MediaRecorder.isTypeSupported(t)) || 'audio/webm';
    log('INFO', `📹 Formato: ${tipo}`);

    mediaRecorder = new MediaRecorder(streamAudio, { mimeType: tipo, audioBitsPerSecond:32000 });
    chunksAudio = [];
    mediaRecorder.ondataavailable = e => e.data.size > 0 && chunksAudio.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunksAudio, { type: tipo });
      arquivoAtual = new File([blob], 'gravacao.webm', { type: tipo });
      mostrarArquivo(arquivoAtual);
      log('SUCESSO', `✅ Gravação: ${fmtBytes(blob.size)}`);
    };
    mediaRecorder.start(1000);
    segsGravados = 0; gravPausada = false;
    timerInterval = setInterval(tickTimer, 1000);
    setUIGrav('gravando');
    log('INFO', '🔴 Gravando...');
  } catch(e) {
    log('ERRO', '❌ ' + e.message);
    toast('Erro ao acessar microfone', 'erro');
  }
}

function pausarGravacao() {
  if (!mediaRecorder) return;
  if (gravPausada) {
    mediaRecorder.resume(); gravPausada = false; setUIGrav('gravando');
    log('INFO', '▶️ Retomado');
  } else {
    mediaRecorder.pause(); gravPausada = true; setUIGrav('pausado');
    log('INFO', '⏸️ Pausado');
  }
}

function pararGravacao() {
  if (!mediaRecorder) return;
  mediaRecorder.stop();
  streamAudio && streamAudio.getTracks().forEach(t => t.stop()); streamAudio = null;
  timerInterval && clearInterval(timerInterval); timerInterval = null;
  animViz && cancelAnimationFrame(animViz); animViz = null;
  setUIGrav('parado');
  log('SUCESSO', '✅ Gravação finalizada');
}

function tickTimer() {
  if (!gravPausada) {
    segsGravados++;
    const h = Math.floor(segsGravados/3600), m = Math.floor((segsGravados%3600)/60), s = segsGravados%60;
    document.getElementById('timerDisplay').textContent =
      `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
}

function setUIGrav(estado) {
  const btnI = document.getElementById('btnIniciar');
  const btnP = document.getElementById('btnPausar');
  const btnS = document.getElementById('btnParar');
  const timer = document.getElementById('timerDisplay');
  const label = document.getElementById('statusGravLabel');
  const statusH = document.getElementById('statusGrav');

  const cfg = {
    gravando: { iDisabled:true, iClass:'btn-gravando', iText:'<i class="fas fa-circle"></i> Gravando', pDisabled:false, pText:'<i class="fas fa-pause"></i>', sDisabled:false, timerClass:'gravando', labelText:'● Gravando...', labelClass:'gravando', statusText:'GRAVANDO' },
    pausado:  { iDisabled:true, iClass:'btn-gravando', iText:'<i class="fas fa-circle"></i> Pausado', pDisabled:false, pText:'<i class="fas fa-play"></i>', sDisabled:false, timerClass:'pausado', labelText:'⏸ Pausado', labelClass:'pausado', statusText:'PAUSADO' },
    parado:   { iDisabled:false, iClass:'btn-primario', iText:'<i class="fas fa-circle"></i> Iniciar', pDisabled:true, pText:'<i class="fas fa-pause"></i>', sDisabled:true, timerClass:'', labelText:'Finalizado', labelClass:'', statusText:'PRONTO' }
  };
  const c = cfg[estado];
  btnI.disabled = c.iDisabled; btnI.className = 'btn ' + c.iClass; btnI.innerHTML = c.iText;
  btnP.disabled = c.pDisabled; btnP.innerHTML = c.pText;
  btnS.disabled = c.sDisabled;
  timer.className = 'timer-display ' + c.timerClass;
  label.textContent = c.labelText; label.className = 'status-grav ' + c.labelClass;
  statusH.textContent = c.statusText;
}

// ═══════════════════════════════════════
//  VISUALIZADOR
// ═══════════════════════════════════════
function setupVisualizador(stream) {
  const canvas = document.getElementById('visualCanvas');
  const ctx = canvas.getContext('2d');
  const ph = document.getElementById('visualPlaceholder');
  const cont = document.getElementById('visualContainer');
  ph.style.display = 'none';
  canvas.width = cont.offsetWidth; canvas.height = cont.offsetHeight;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const src = audioCtx.createMediaStreamSource(stream);
  analisador = audioCtx.createAnalyser(); analisador.fftSize = 256;
  src.connect(analisador);
  const data = new Uint8Array(analisador.frequencyBinCount);
  const bw = (canvas.width / data.length) * 2.2;

  function draw() {
    animViz = requestAnimationFrame(draw);
    analisador.getByteFrequencyData(data);
    ctx.fillStyle = '#2C1810'; ctx.fillRect(0,0,canvas.width,canvas.height);
    let x = 0;
    for (let i = 0; i < data.length; i++) {
      const h = (data[i]/255) * canvas.height * 0.8;
      const grad = ctx.createLinearGradient(0, canvas.height-h, 0, canvas.height);
      grad.addColorStop(0, '#C4822A'); grad.addColorStop(1, '#5C3D2E');
      ctx.fillStyle = grad;
      ctx.fillRect(x, canvas.height-h, bw, h);
      x += bw + 1;
    }
  }
  draw();
}

// ═══════════════════════════════════════
//  UPLOAD / ARQUIVO
// ═══════════════════════════════════════
function setupDropzone() {
  const dz = document.getElementById('dropzone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('arrastando'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('arrastando'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('arrastando');
    const f = e.dataTransfer.files[0];
    if (f) processarArquivo(f);
  });
}

function onFileSelect(e) { const f = e.target.files[0]; if(f) processarArquivo(f); }

function processarArquivo(f) {
  if (!f.type.startsWith('audio/')) { toast('Arquivo inválido (não é áudio)', 'erro'); return; }
  if (f.size > 500*1024*1024) { toast('Arquivo muito grande (máx 500MB)', 'erro'); return; }
  arquivoAtual = f; mostrarArquivo(f);
  log('INFO', `📁 ${f.name} — ${fmtBytes(f.size)}`);
}

function mostrarArquivo(f) {
  document.getElementById('dropzone').style.display = 'none';
  document.getElementById('arquivoPreview').style.display = 'flex';
  document.getElementById('arquivoNome').textContent = f.name;
  document.getElementById('arquivoTam').textContent = fmtBytes(f.size);
  document.getElementById('btnEnviar').disabled = false;
}

function removerArquivo() {
  arquivoAtual = null;
  document.getElementById('dropzone').style.display = 'block';
  document.getElementById('arquivoPreview').style.display = 'none';
  document.getElementById('btnEnviar').disabled = true;
  document.getElementById('fileInput').value = '';
  log('INFO', '🗑️ Arquivo removido');
}

// ═══════════════════════════════════════
//  ENVIO DE ÁUDIO
// ═══════════════════════════════════════
async function enviarAudio() {
  if (!arquivoAtual) { toast('Selecione um arquivo', 'aviso'); return; }
  const titulo = document.getElementById('inputTitulo').value || 'Reunião ' + new Date().toLocaleDateString('pt-BR');
  const participantes = document.getElementById('inputParticipantes').value || '';

  try {
    mostrarLoading('Preparando áudio...');
    log('INFO', `📤 Iniciando envio: ${fmtBytes(arquivoAtual.size)}`);

    let arq = arquivoAtual;
    if (arq.size > 15*1024*1024) {
      atualizarLoading('Otimizando áudio...');
      arq = await comprimirAudio(arquivoAtual, p => atualizarLoading(`Otimizando (${p}%)...`));
    }

    if (arq.size < 12*1024*1024) {
      log('INFO', '📦 Arquivo pequeno — envio direto');
      const b64 = await arqParaBase64(arq);
      await enviarDireto(b64, titulo, participantes);
    } else {
      log('INFO', `📦 Arquivo grande — pipeline chunks`);
      const bkp = arquivoAtual; arquivoAtual = arq;
      await enviarGrande(titulo, participantes);
      arquivoAtual = bkp;
    }
  } catch(e) {
    esconderLoading();
    log('ERRO', '❌ ' + e.message);
    toast('Erro: ' + e.message, 'erro');
  }
}

async function enviarDireto(b64, titulo, participantes) {
  atualizarLoading('Enviando para IA...');
  google.script.run
    .withSuccessHandler(r => trataResposta(r, titulo))
    .withFailureHandler(e => {
  esconderLoading();
  log('ERRO','❌ '+e.message);
  toast('Erro no servidor','erro');
  // ✅ Cleanup proteção
  if (typeof processamentoConcluido === 'function') {
    processamentoConcluido(false, typeof estadoProtecao !== 'undefined' ? estadoProtecao.sessaoId : null);
  }
})
    .processarAudioReuniao({ audioBase64:b64, tipoMime:arquivoAtual.type, tamanhoBytes:arquivoAtual.size, titulo, participantes, dataInicio:new Date().toISOString(), duracaoMinutos:Math.ceil(segsGravados/60) });
}

function trataResposta(r, titulo) {
  esconderLoading();
  if (!r) { log('ERRO','❌ Resposta vazia'); return; }
  (r.logs||[]).forEach(l => log(l.tipo, l.mensagem));
  if (r.sucesso) {
    log('SUCESSO','🎉 Concluído!'); toast('Processamento concluído!','sucesso');
    if (r.ata) exibirAtaPainel(r.reuniaoId, r.ata, titulo, true);
    carregarCatalogo();
    limparForm();
    if (r.ata && r.reuniaoId) setTimeout(() => abrirModalEmail(r.reuniaoId, r.ata), 600);
  } else {
    log('ERRO','❌ ' + (r.mensagem||'erro')); toast('Falha: '+(r.mensagem||'erro'),'erro');
  }
}

// Pipeline grande (chunks)
async function enviarGrande(titulo, participantes) {
  const tipo = arquivoAtual.type || 'audio/webm';
  const tam = arquivoAtual.size;
  const nChunks = Math.ceil(tam / FATIA_MB);
  const idUpload = 'up_' + Date.now().toString(36);

  log('INFO', `📦 ${nChunks} partes de ~${(FATIA_MB/1024/1024).toFixed(0)}MB`);
  atualizarLoading('Enviando ao servidor (0%)...');

  let enviados = 0;
  async function enviarChunk(i) {
    const ini = i*FATIA_MB, fim = Math.min(ini+FATIA_MB,tam);
    const b64 = await lerFatia(arquivoAtual.slice(ini,fim));
    return new Promise((res,rej) => {
      google.script.run
        .withSuccessHandler(r => { if(r?.sucesso){enviados++;atualizarLoading(`Enviando (${Math.round(enviados/nChunks*100)}%)...`);res();} else rej(new Error(r?.mensagem)); })
        .withFailureHandler(e => rej(new Error(e?.message)))
        .receberChunkAudio({ idUpload, indiceChunk:i, totalChunks:nChunks, chunkBase64:b64, tipoMime:tipo });
    });
  }
  for (let i = 0; i < nChunks; i += CHUNKS_PAR) {
    const ps = []; for (let j=0; j<CHUNKS_PAR && (i+j)<nChunks; j++) ps.push(enviarChunk(i+j));
    await Promise.all(ps);
  }
  log('SUCESSO','✅ Todos os chunks enviados!');

  // Etapa 1a: iniciar sessões
  atualizarLoading('Iniciando upload Gemini...');
  const r1a = await chamarServidor('etapa1a_IniciarSessoesUpload', { idUpload, tipoMime:tipo, titulo });
  (r1a.logs||[]).forEach(l=>log(l.tipo,l.mensagem));
  if (!r1a.sucesso) { esconderLoading(); log('ERRO','❌ Etapa 1a: '+r1a.mensagem); return; }

  // Etapa 1b: lotes
  let offG=0, offD=0, gemUri='', gemName='', proxChunk=0, nlote=0;
  while (proxChunk < nChunks) {
    const ci=proxChunk, cf=Math.min(ci+LOTE_UPLOAD-1,nChunks-1), ultimo=(cf>=nChunks-1);
    nlote++;
    atualizarLoading(`Gemini ${Math.round((cf+1)/nChunks*100)}% — lote ${nlote}`);
    const r1b = await chamarServidor('etapa1b_EnviarLoteParaGemini', { idUpload, geminiUrl:r1a.geminiUrl, driveUrl:r1a.driveUrl, chunkInicio:ci, chunkFim:cf, offsetGemini:offG, offsetDrive:offD, totalBytes:r1a.totalBytes, ehUltimoLote:ultimo });
    (r1b.logs||[]).forEach(l=>log(l.tipo,l.mensagem));
    if (!r1b.sucesso) { esconderLoading(); log('ERRO','❌ Lote '+nlote+': '+r1b.mensagem); return; }
    offG=r1b.offsetGemini; offD=r1b.offsetDrive;
    if (r1b.finalizado) { gemUri=r1b.geminiFileUri; gemName=r1b.geminiFileName; break; }
    proxChunk = (r1b.interrompidoPorTempo && r1b.proximoChunkInicio!==undefined) ? r1b.proximoChunkInicio : cf+1;
  }
  if (!gemUri) { esconderLoading(); log('ERRO','❌ Upload não finalizado'); return; }

  // Etapa 1c
  atualizarLoading('Aguardando Gemini...');
  const r1c = await chamarServidor('etapa1c_AguardarProcessamentoGemini', { geminiFileName:gemName, geminiFileUri:gemUri, nomeAudio:r1a.nomeAudio, idUpload, totalBytes:r1a.totalBytes });
  (r1c.logs||[]).forEach(l=>log(l.tipo,l.mensagem));
  if (!r1c.sucesso) { esconderLoading(); log('ERRO','❌ '+r1c.mensagem); return; }

  // Etapa 2: transcrição
  atualizarLoading('Transcrevendo...');
  log('ALERTA','⏳ Pode demorar alguns minutos para áudios longos');
  const r2 = await chamarServidor('etapa2_TranscreverAudio', { fileUri:r1c.fileUri, tipoMime:tipo });
  (r2.logs||[]).forEach(l=>log(l.tipo,l.mensagem));
  if (!r2.sucesso) { esconderLoading(); log('ERRO','❌ '+r2.mensagem); return; }
  const transcricao = r2.transcricao;

  // Etapa 3: ATA
  atualizarLoading('Gerando ATA...');
  const LIMITE_MR = 100000, SEG_TAM = 100000;
  let rAta;
  if (transcricao.length < LIMITE_MR) {
    rAta = await chamarServidor('etapa3_GerarAta', { transcricao, titulo, participantes });
  } else {
    atualizarLoading('Gerando ATA (Map-Reduce)...');
    const segs = dividirSegs(transcricao, SEG_TAM);
    log('INFO', `📦 ${segs.length} segmentos para extração paralela`);
    const ress = await Promise.all(segs.map((s,i) => chamarServidor('extrairPontosSegmentoServidor', { segmento:s, numSegmento:i+1, totalSegmentos:segs.length })));
    const pts = ress.map((r,i) => `\n\n=== SEGMENTO ${i+1}/${segs.length} ===\n\n` + (r.pontosChave || segs[i].substring(0,15000)));
    ress.forEach(r => (r.logs||[]).forEach(l=>log(l.tipo,l.mensagem)));
    rAta = await chamarServidor('gerarAtaDesdeExtracoes', { pontosConsolidados:pts.join(''), titulo, participantes });
  }
  (rAta?.logs||[]).forEach(l=>log(l.tipo,l.mensagem));
  const ataFinal = rAta?.sucesso && rAta.ata?.length > 50 ? rAta.ata : '';
  if (ataFinal) log('SUCESSO','✅ ATA gerada: '+ataFinal.length+' chars');

  // Relatório e salvar em paralelo
  atualizarLoading('Finalizando...');
  const [rRel, rSalvar] = await Promise.all([
    chamarServidor('etapa_SoRelatorioIdentificacoes', { transcricao, titulo }).catch(e => ({ sucesso:false, mensagem:e.message })),
    chamarServidor('etapa_SalvarReuniao', { titulo, participantes, transcricao, ata:ataFinal, sugestoes:rAta?.sugestoes||'', dataInicio:new Date().toISOString(), duracaoMinutos:Math.ceil(segsGravados/60), fileName:gemName, idUpload, linkAudio:r1c.linkAudio||'' })
  ]);
  (rRel?.logs||[]).forEach(l=>log(l.tipo,l.mensagem));
  (rSalvar?.logs||[]).forEach(l=>log(l.tipo,l.mensagem));

  esconderLoading();
  if (rSalvar?.sucesso) {
    log('SUCESSO','🎉 Processamento completo!'); toast('Concluído com sucesso!','sucesso');
    if (ataFinal) exibirAtaPainel(rSalvar.reuniaoId, ataFinal, titulo, true);
    if (typeof processamentoConcluido === 'function') {
  processamentoConcluido(true, typeof estadoProtecao !== 'undefined' ? estadoProtecao.sessaoId : null);
}
    carregarCatalogo(); limparForm();
    if (ataFinal && rSalvar.reuniaoId) setTimeout(() => abrirModalEmail(rSalvar.reuniaoId, ataFinal), 600);
  } else {
    log('ERRO','❌ Salvar: '+(rSalvar?.mensagem||'erro'));
    if (ataFinal) exibirAtaPainel(null, ataFinal, titulo, false);
    if (typeof processamentoConcluido === 'function') {
  processamentoConcluido(false, typeof estadoProtecao !== 'undefined' ? estadoProtecao.sessaoId : null);
}
  }
}

function chamarServidor(fn, dados) {
  return new Promise((res,rej) => {
    google.script.run
      .withSuccessHandler(res)
      .withFailureHandler(e => rej(new Error(e?.message||'Erro desconhecido')))
      [fn](dados);
  });
}

function lerFatia(blob) {
  return new Promise((res,rej) => {
    const rd = new FileReader();
    rd.onload = () => { const r=rd.result; const c=r.indexOf(','); res(c>=0?r.substring(c+1):r); };
    rd.onerror = () => rej(new Error('Erro ao ler fatia'));
    rd.readAsDataURL(blob);
  });
}

function arqParaBase64(f) {
  return new Promise((res,rej) => {
    const rd = new FileReader();
    rd.onload = () => res(rd.result);
    rd.onerror = rej;
    rd.readAsDataURL(f);
  });
}

function dividirSegs(txt, tam) {
  const segs=[]; let pos=0;
  while(pos<txt.length) {
    let fim = Math.min(pos+tam, txt.length);
    if (fim<txt.length) { const ult=txt.lastIndexOf('\n',fim); if(ult>pos+tam*0.7) fim=ult+1; }
    segs.push(txt.substring(pos,fim)); pos=fim;
  }
  return segs;
}

async function comprimirAudio(f, onP) {
  onP(0);
  if (f.size > 50*1024*1024) { log('INFO','📦 Arquivo grande — sem compressão'); return f; }
  log('INFO','🔄 Comprimindo áudio...');
  return new Promise((res) => {
    const rd = new FileReader();
    rd.onload = () => {
      onP(15);
      const ctxT = new (window.AudioContext||window.webkitAudioContext)();
      ctxT.decodeAudioData(rd.result).then(buf => {
        onP(35);
        const DEST = 16000;
        const dur = buf.duration;
        const nAm = Math.ceil(dur * DEST);
        const ctxO = new OfflineAudioContext(1, nAm, DEST);
        const src = ctxO.createBufferSource(); src.buffer = buf; src.connect(ctxO.destination); src.start(0);
        ctxO.startRendering().then(rendered => {
          onP(70);
          const pcm = rendered.getChannelData(0);
          const wav = pcmParaWav(pcm, DEST);
          onP(100);
          try { ctxT.close(); } catch(e){}
          const arqNovo = new File([wav], f.name.replace(/\.[^.]+$/,'')+'_16k.wav', { type:'audio/wav' });
          log('SUCESSO', `✅ ${fmtBytes(f.size)} → ${fmtBytes(arqNovo.size)}`);
          res(arqNovo);
        }).catch(() => { try{ctxT.close();}catch(e){} res(f); });
      }).catch(() => res(f));
    };
    rd.onerror = () => res(f);
    rd.readAsArrayBuffer(f);
  });
}

function pcmParaWav(amostras, taxa) {
  const n=amostras.length, bpa=2, nc=1, tb=nc*bpa, taxaB=taxa*tb, tamD=n*tb;
  const buf = new ArrayBuffer(44+tamD); const v = new DataView(buf);
  const ws = (off,s) => { for(let i=0;i<s.length;i++) v.setUint8(off+i,s.charCodeAt(i)); };
  ws(0,'RIFF'); v.setUint32(4,36+tamD,true); ws(8,'WAVE'); ws(12,'fmt ');
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,nc,true);
  v.setUint32(24,taxa,true); v.setUint32(28,taxaB,true); v.setUint16(32,tb,true); v.setUint16(34,16,true);
  ws(36,'data'); v.setUint32(40,tamD,true);
  let off=44;
  for(let i=0;i<n;i++) { let a=amostras[i]; a=Math.max(-1,Math.min(1,a)); v.setInt16(off,a<0?a*0x8000:a*0x7FFF,true); off+=2; }
  return new Blob([buf],{type:'audio/wav'});
}

// ═══════════════════════════════════════
//  PAINEL ATA
// ═══════════════════════════════════════
function exibirAtaPainel(reunId, textoAta, titulo, mostrarBotoes) {
  ataAtualReunId = reunId; ataAtualTexto = textoAta;

  // Proteção: se elementos não existem ainda, aborta sem erro
  const elVazia = document.getElementById('ataVazia');
  const elConteudo = document.getElementById('ataConteudo');
  const elTitulo = document.getElementById('ataPainelTitulo');
  const elAcoes = document.getElementById('ataAcoes');

  if (!elVazia || !elConteudo || !elTitulo) return;

  elVazia.style.display = 'none';
  elConteudo.style.display = 'block';
  elConteudo.innerHTML = renderMd(textoAta);

  // Atualiza título SEM destruir o span subtitulo
  // Usa textContent no nó de texto ou recria com subtitulo incluso mas oculto
  elTitulo.innerHTML =
    '<i class="fas fa-file-lines" style="color:var(--ocre);margin-right:0.5rem;font-size:0.9rem;"></i> ' +
    esc(titulo || 'Ata da Reunião') +
    '<span id="ataPainelSubtitulo" style="display:none;"></span>';

  if (elAcoes) elAcoes.style.display = mostrarBotoes ? 'flex' : 'none';
}

function copiarAtaAtual() {
  if (!ataAtualTexto) { toast('Nenhuma ata para copiar','aviso'); return; }
  navigator.clipboard.writeText(ataAtualTexto).then(() => toast('Ata copiada!','sucesso'));
}

function abrirEmailAtaAtual() {
  if (!ataAtualReunId) { toast('Salve a reunião primeiro','aviso'); return; }
  abrirModalEmail(ataAtualReunId, ataAtualTexto);
}

// ═══════════════════════════════════════
//  CATÁLOGO
// ═══════════════════════════════════════
let filtroResp = 'todos';
let termoBusca = '';

function carregarCatalogo() {
  document.getElementById('catalogoLista').innerHTML =
    '<div style="display:flex;flex-direction:column;gap:0.4rem"><div class="skeleton" style="height:38px;width:100%;"></div><div class="skeleton" style="height:38px;width:100%;"></div><div class="skeleton" style="height:38px;width:85%;"></div></div>';

  google.script.run
    .withSuccessHandler(r => {
      if (!r?.sucesso) { document.getElementById('catalogoLista').innerHTML='<p style="text-align:center;padding:2rem;color:var(--marrom-claro);font-size:0.8rem;">Erro ao carregar catálogo</p>'; return; }
      dadosCatalogo = r;
      // Flatten para cache
      cacheReuniao = [];
      Object.values(r.porProjeto||{}).forEach(p => p.reunioes.forEach(ru => { ru._projetoNome=p.nome; cacheReuniao.push(ru); }));
      (r.semCatalogo||[]).forEach(ru => { ru._projetoNome=''; cacheReuniao.push(ru); });

      // Coletar responsáveis de projetos
      const resps = new Set();
      Object.values(r.porProjeto||{}).forEach(p => {
        if (p.responsavelNomes) p.responsavelNomes.forEach(n=>resps.add(n));
      });
      renderizarFiltrosResp(resps);
      renderizarCatalogo();

      // Carregar a ata da reunião mais recente
      if (cacheReuniao.length > 0 && cacheReuniao[0].temAta) {
        carregarAtaParaPainel(cacheReuniao[0]);
      }
    })
    .withFailureHandler(e => {
      document.getElementById('catalogoLista').innerHTML='<p style="text-align:center;padding:2rem;color:var(--marrom-claro);font-size:0.8rem;">Erro: '+(e?.message||'desconhecido')+'</p>';
    })
    .obterReunioesCatalogadas();
}

function carregarAtaParaPainel(r) {
  if (ataAtualReunId) return; // já tem uma ata exibida
  google.script.run
    .withSuccessHandler(res => {
      if (res?.sucesso && res.conteudo) {
        exibirAtaPainel(r.id, res.conteudo, r.titulo, true);
      }
    })
    .withFailureHandler(() => {})
    .obterConteudoReuniao(r.id, 'ata');
}

function renderizarFiltrosResp(resps) {
  const cont = document.getElementById('filtrosResp');
  // Mantém o "Todos"
  let html = '<span style="font-size:0.7rem;font-weight:700;color:var(--marrom-claro);align-self:center;letter-spacing:0.5px;">Filtrar:</span>';
  html += `<button class="chip-resp ${filtroResp==='todos'?'ativo':''}" data-resp="todos" onclick="filtrarPorResp(this)"><i class="fas fa-users"></i> Todos</button>`;
  resps.forEach(n => {
    html += `<button class="chip-resp ${filtroResp===n?'ativo':''}" data-resp="${esc(n)}" onclick="filtrarPorResp(this)"><i class="fas fa-user"></i> ${esc(n)}</button>`;
  });
  cont.innerHTML = html;
}

function filtrarPorResp(btn) {
  filtroResp = btn.getAttribute('data-resp');
  document.querySelectorAll('.chip-resp').forEach(c => c.classList.remove('ativo'));
  btn.classList.add('ativo');
  renderizarCatalogo();
}

function filtrarCatalogo() {
  termoBusca = document.getElementById('buscaReuniao').value.toLowerCase();
  renderizarCatalogo();
}

function renderizarCatalogo() {
  const lista = document.getElementById('catalogoLista');
  let html = '';
  const tb = termoBusca;
  const fr = filtroResp;

  // Projetos
  const projetos = Object.values(dadosCatalogo.porProjeto||{});
  const projetosFiltrados = projetos.filter(p => {
    const nomeBate = !tb || p.nome.toLowerCase().includes(tb);
    const respBate = fr==='todos' || (p.responsavelNomes||[]).some(n => n===fr);
    const reunioesBatem = !tb || p.reunioes.some(r => r.titulo?.toLowerCase().includes(tb));
    return (nomeBate || reunioesBatem) && respBate;
  });

  projetosFiltrados.forEach(p => {
    const reunBatem = tb ? p.reunioes.filter(r => r.titulo?.toLowerCase().includes(tb)) : p.reunioes;
    if (!reunBatem.length && tb) return;
    const secId = 'proj_' + p.id;
    html += `
      <div class="projeto-grupo">
        <div class="projeto-header" onclick="toggleProj('${secId}')">
          <div class="proj-icone"><i class="fas fa-folder"></i></div>
          <div class="proj-nome" title="${esc(p.nome)}">${esc(p.nome)}</div>
          <div class="proj-meta">${p.status||''}</div>
          <span class="proj-badge"><i class="fas fa-video"></i> ${reunBatem.length}</span>
          <i class="fas fa-chevron-down proj-chevron" id="chev_${secId}"></i>
        </div>
        <div class="proj-reunioes" id="list_${secId}">
          ${reunBatem.map(r => renderLinhaReuniao(r, false)).join('')}
        </div>
      </div>`;
  });

  // Não catalogadas
  const semCat = (dadosCatalogo.semCatalogo||[]).filter(r => !tb || r.titulo?.toLowerCase().includes(tb));

  // ✅ Atualiza banner de alerta
  atualizarBannerNaoCatalogadas(semCat.length);

  if (semCat.length) {
    html += `
      <div class="projeto-grupo nc-grupo" id="grupoNaoCatalogadas">
        <div class="projeto-header" onclick="toggleProj('nc')">
          <div class="proj-icone"><i class="fas fa-inbox"></i></div>
          <div class="proj-nome">Não Catalogadas</div>
          <div class="proj-meta">Associe a um projeto</div>
          <span class="proj-badge"><i class="fas fa-video"></i> ${semCat.length}</span>
          <i class="fas fa-chevron-down proj-chevron" id="chev_nc"></i>
        </div>
        <div class="proj-reunioes" id="list_nc">
          ${semCat.map(r => renderLinhaReuniao(r, true)).join('')}
        </div>
      </div>`;
  }

  if (!html) {
    html = '<div style="text-align:center;padding:2rem;color:var(--marrom-claro);font-size:0.82rem;"><i class="fas fa-inbox" style="font-size:1.5rem;display:block;opacity:0.2;margin-bottom:0.5rem;"></i>Nenhuma reunião encontrada</div>';
  }

  lista.innerHTML = html;

  // Abre o primeiro projeto automaticamente
  if (projetosFiltrados.length > 0) toggleProj('proj_' + projetosFiltrados[0].id, true);
  else if (semCat.length) toggleProj('nc', true);
}

/** Exibe ou oculta o banner de alerta de reuniões não catalogadas */
function atualizarBannerNaoCatalogadas(qtd) {
  const banner = document.getElementById('bannerNaoCatalogadas');
  const texto  = document.getElementById('bannerNaoCatalogadasTexto');
  if (!banner || !texto) return;
  if (qtd > 0) {
    texto.textContent = qtd === 1
      ? '1 reunião ainda não foi associada a nenhum projeto!'
      : qtd + ' reuniões ainda não foram associadas a nenhum projeto!';
    banner.style.display = 'flex';
  } else {
    banner.style.display = 'none';
  }
}

/** Scroll suave até o grupo "Não Catalogadas" */
function scrollParaNaoCatalogadas() {
  const grupo = document.getElementById('grupoNaoCatalogadas');
  if (!grupo) return;
  toggleProj('nc', true);
  setTimeout(() => grupo.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
}

function renderLinhaReuniao(r, mostrarAssoc) {
  const dt = r.dataInicio ? new Date(r.dataInicio).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'}) : '—';
  const acoes = [
    r.temAta ? `<button class="btn-xs azul" title="Ver Ata" onclick="event.stopPropagation();selecionarReuniao('${r.id}')"><i class="fas fa-file-lines"></i></button>` : '',
    r.temTranscricao ? `<button class="btn-xs" title="Ver Transcrição" onclick="event.stopPropagation();abrirModalReuniao('${r.id}','transcricao')"><i class="fas fa-microphone"></i></button>` : '',
    r.temAta ? `<button class="btn-xs ocre" title="Enviar Email" onclick="event.stopPropagation();emailRapido('${r.id}')"><i class="fas fa-envelope"></i></button>` : '',
    r.linkAudio ? `<button class="btn-xs roxo" title="Ouvir" onclick="event.stopPropagation();window.open('${r.linkAudio}','_blank')"><i class="fas fa-headphones"></i></button>` : ''
  ].join('');
  const btnAssoc = mostrarAssoc
    ? `<button class="btn-associar" onclick="event.stopPropagation();abrirModalAssociar('${r.id}','${esc(r.titulo||'')}')"><i class="fas fa-tag"></i> Associar</button>`
    : `<button class="btn-associar" title="Mover" onclick="event.stopPropagation();abrirModalAssociar('${r.id}','${esc(r.titulo||'')}')"><i class="fas fa-rotate"></i></button>`;
  return `
    <div class="reuniao-linha" onclick="selecionarReuniao('${r.id}')">
      <div class="reuniao-dot"></div>
      <div class="reuniao-nome" title="${esc(r.titulo||'Sem título')}">${esc(r.titulo||'Sem título')}</div>
      <div class="reuniao-data">${dt}</div>
      <div class="reuniao-acoes">${acoes}</div>
      ${btnAssoc}
    </div>`;
}

function toggleProj(id, forcarAbrir) {
  const el = document.getElementById('list_'+id);
  const chev = document.getElementById('chev_'+id);
  if (!el) return;
  const aberto = el.classList.contains('aberto');
  if (forcarAbrir || !aberto) {
    el.classList.add('aberto'); if(chev) chev.classList.add('aberto');
  } else {
    el.classList.remove('aberto'); if(chev) chev.classList.remove('aberto');
  }
}

function selecionarReuniao(id) {
  const r = cacheReuniao.find(x => String(x.id)===String(id));
  if (!r) return;
  if (!r.temAta) { toast('Esta reunião não tem ata','aviso'); return; }

  const elVazia = document.getElementById('ataVazia');
  const elConteudo = document.getElementById('ataConteudo');
  const elAcoes = document.getElementById('ataAcoes');
  const elTitulo = document.getElementById('ataPainelTitulo');

  if (!elVazia || !elConteudo) return;

  elVazia.style.display = 'none';
  elConteudo.style.display = 'block';
  elConteudo.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--marrom-claro);"><i class="fas fa-spinner fa-spin" style="font-size:1.5rem;display:block;margin-bottom:0.75rem;"></i>Carregando ata...</div>';
  if (elAcoes) elAcoes.style.display = 'none';
  if (elTitulo) {
    elTitulo.innerHTML =
      '<i class="fas fa-file-lines" style="color:var(--ocre);margin-right:0.5rem;font-size:0.9rem;"></i> ' +
      esc(r.titulo || 'Ata') +
      '<span id="ataPainelSubtitulo" style="display:none;"></span>';
  }

  google.script.run
    .withSuccessHandler(res => {
      if (res?.sucesso && res.conteudo) {
        exibirAtaPainel(r.id, res.conteudo, r.titulo, true);
      } else {
        elConteudo.innerHTML = '<p style="text-align:center;padding:2rem;color:var(--vermelho-vintage);">Não foi possível carregar a ata</p>';
      }
    })
    .withFailureHandler(e => {
      elConteudo.innerHTML = '<p style="text-align:center;padding:2rem;color:var(--vermelho-vintage);">Erro: '+(e?.message||'desconhecido')+'</p>';
    })
    .obterConteudoReuniao(id, 'ata');
}

// ═══════════════════════════════════════
//  MODAL REUNIÃO (ata/transcrição)
// ═══════════════════════════════════════
function abrirModalReuniao(id, tabInicial) {
  tabInicial = tabInicial || 'ata';
  const r = cacheReuniao.find(x => String(x.id)===String(id));
  if (!r) { toast('Reunião não encontrada','aviso'); return; }

  reuniaoModalAtual = { ...r };
  document.getElementById('modalReuniaoTitulo').textContent = r.titulo || 'Reunião';

  const dt = r.dataInicio ? new Date(r.dataInicio).toLocaleString('pt-BR') : '—';
  let meta = `<div class="meta-chip"><i class="fas fa-calendar"></i>${dt}</div>`;
  if (r.duracao) meta += `<div class="meta-chip"><i class="fas fa-clock"></i>${r.duracao} min</div>`;
  if (r.participantes) meta += `<div class="meta-chip"><i class="fas fa-users"></i>${esc(r.participantes)}</div>`;
  if (r.linkAudio) meta += `<div class="meta-chip"><a href="${r.linkAudio}" target="_blank"><i class="fas fa-headphones"></i> Áudio <i class="fas fa-external-link-alt"></i></a></div>`;
  document.getElementById('modalReuniaoMeta').innerHTML = meta;

  document.getElementById('modalAtaTexto').innerHTML = '<p style="color:var(--marrom-claro);text-align:center;padding:2rem"><i class="fas fa-spinner fa-spin"></i> Carregando...</p>';
  document.getElementById('modalTranscricaoTexto').innerHTML = '<p style="color:var(--marrom-claro);text-align:center;padding:2rem"><i class="fas fa-spinner fa-spin"></i> Carregando...</p>';

  // Rodapé
  let rod = '';
  if (r.temAta) rod += `<button class="btn btn-sm btn-secundario" onclick="copiarModal('ata')"><i class="fas fa-copy"></i> Copiar Ata</button>`;
  if (r.temTranscricao) rod += `<button class="btn btn-sm btn-secundario" onclick="copiarModal('transcricao')"><i class="fas fa-copy"></i> Copiar Transcrição</button>`;
  if (r.temAta) rod += `<button class="btn btn-sm btn-primario" onclick="emailRapido('${r.id}')"><i class="fas fa-envelope"></i> Enviar Email</button>`;
  rod += `<button class="btn btn-sm btn-secundario" onclick="fecharModal('modalReuniao')">Fechar</button>`;
  document.getElementById('modalReuniaoRodape').innerHTML = rod;

  abrirModal('modalReuniao');
  trocarTab(document.querySelector(`.modal-tab[data-tab="${tabInicial}"]`), tabInicial);

  if (r.temAta) google.script.run.withSuccessHandler(res => {
    if (res?.sucesso) { reuniaoModalAtual.ata = res.conteudo; document.getElementById('modalAtaTexto').innerHTML = renderMdConteudo(res.conteudo); }
  }).withFailureHandler(()=>{}).obterConteudoReuniao(id, 'ata');

  if (r.temTranscricao) google.script.run.withSuccessHandler(res => {
    if (res?.sucesso) { reuniaoModalAtual.transcricao = res.conteudo; document.getElementById('modalTranscricaoTexto').innerHTML = `<pre style="white-space:pre-wrap;font-family:inherit;font-size:0.82rem;line-height:1.7;">${esc(res.conteudo)}</pre>`; }
  }).withFailureHandler(()=>{}).obterConteudoReuniao(id, 'transcricao');
}

function trocarTab(btn, tab) {
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('ativo'));
  document.querySelectorAll('.modal-tab-conteudo').forEach(c => c.classList.remove('ativo'));
  if (btn) btn.classList.add('ativo');
  const id = tab==='ata' ? 'tabAta' : 'tabTranscricao';
  document.getElementById(id)?.classList.add('ativo');
}

function copiarModal(tipo) {
  const txt = reuniaoModalAtual?.[tipo];
  if (!txt) { toast('Nada para copiar','aviso'); return; }
  navigator.clipboard.writeText(txt).then(() => toast('Copiado!','sucesso'));
}

// ═══════════════════════════════════════
//  MODAL ASSOCIAR
// ═══════════════════════════════════════
function abrirModalAssociar(id, titulo) {
  assocReunId = id; assocProjSel = null;
  document.getElementById('assocTituloReuniao').textContent = titulo || '';
  document.getElementById('assocBusca').value = '';
  document.getElementById('listaProjetosAssoc').innerHTML = '<div class="console-vazio" style="color:var(--marrom-claro);height:100px;"><i class="fas fa-spinner fa-spin"></i></div>';
  abrirModal('modalAssociar');

  google.script.run
    .withSuccessHandler(r => {
      if (r?.sucesso && r.projetos) {
        todosProjetosAssoc = r.projetos;
        renderizarProjetosAssoc(r.projetos);
      }
    })
    .withFailureHandler(()=>{})
    .obterProjetosParaAssociacao();
}

function filtrarProjetosAssoc() {
  const tb = document.getElementById('assocBusca').value.toLowerCase();
  const filtrados = tb ? todosProjetosAssoc.filter(p => p.nome.toLowerCase().includes(tb)) : todosProjetosAssoc;
  renderizarProjetosAssoc(filtrados);
}

function renderizarProjetosAssoc(projetos) {
  if (!projetos.length) {
    document.getElementById('listaProjetosAssoc').innerHTML = '<p style="text-align:center;color:var(--marrom-claro);font-size:0.82rem;padding:1rem;">Nenhum projeto encontrado</p>';
    return;
  }

  // Agrupa por responsável (se disponível)
  const grupos = {};
  projetos.forEach(p => {
    const resp = p.responsavelNomes?.join(', ') || 'Sem responsável atribuído';
    if (!grupos[resp]) grupos[resp] = [];
    grupos[resp].push(p);
  });

  let html = '';
  Object.entries(grupos).forEach(([resp, ps]) => {
    html += `<div class="resp-grupo-titulo"><i class="fas fa-user"></i>${esc(resp)}</div>`;
    ps.forEach(p => {
      html += `<div class="projeto-opcao${assocProjSel===p.id?' selecionado':''}" data-id="${p.id}" onclick="selProj('${p.id}',this)">
        <div class="proj-opcao-icone"><i class="fas fa-folder"></i></div>
        <div><div class="proj-opcao-nome">${esc(p.nome)}</div><div class="proj-opcao-meta">${esc(p.status||'Em andamento')}</div></div>
      </div>`;
    });
  });

  document.getElementById('listaProjetosAssoc').innerHTML = html;
}

function selProj(id, el) {
  assocProjSel = id;
  document.querySelectorAll('.projeto-opcao').forEach(e => e.classList.remove('selecionado'));
  el.classList.add('selecionado');
}

function confirmarAssociacao() {
  if (!assocProjSel) { toast('Selecione um projeto','aviso'); return; }
  mostrarLoading('Salvando...');
  google.script.run
    .withSuccessHandler(r => {
      esconderLoading();
      if (r?.sucesso) { toast('Associação salva!','sucesso'); fecharModal('modalAssociar'); carregarCatalogo(); }
      else toast('Erro: '+(r?.mensagem||'desconhecido'),'erro');
    })
    .withFailureHandler(e => { esconderLoading(); toast('Erro','erro'); })
    .associarReuniaoAoProjeto(assocReunId, assocProjSel);
}

// ═══════════════════════════════════════
//  MODAL EMAIL
// ═══════════════════════════════════════
function abrirModalEmail(reunId, ata) {
  emailReunId = reunId; emailAta = ata;
  emailsSel.clear(); emailsAdd = [];
  document.getElementById('inputNovoEmail').value = '';
  document.getElementById('emailsAdicionadosWrap').style.display = 'none';
  document.getElementById('chipsEmailAdd').innerHTML = '';
  document.getElementById('chipsEmailPadrao').innerHTML = '<span style="color:var(--marrom-claro);font-size:0.75rem;"><i class="fas fa-spinner fa-spin"></i></span>';
  abrirModal('modalEmail');

  google.script.run
    .withSuccessHandler(r => {
      if (r?.sucesso) {
        emailsPadrao = r.emails||[];
        document.getElementById('chipsEmailPadrao').innerHTML = emailsPadrao.map(e =>
          `<div class="email-chip${emailsSel.has(e)?' sel':''}" onclick="toggleEmail('${e}',this)">${esc(e)}</div>`
        ).join('') || '<span style="color:var(--marrom-claro);font-size:0.75rem;">Nenhum email padrão</span>';
      }
    })
    .withFailureHandler(()=>{})
    .obterEmailsDestinatariosPadrao();
}

function emailRapido(id) {
  const r = cacheReuniao.find(x => String(x.id)===String(id));
  if (!r?.temAta) { toast('Sem ata para enviar','aviso'); return; }
  fecharModal('modalReuniao');
  google.script.run
    .withSuccessHandler(res => { if (res?.sucesso) abrirModalEmail(id, res.conteudo); })
    .withFailureHandler(()=>toast('Erro ao carregar ata','erro'))
    .obterConteudoReuniao(id,'ata');
}

function toggleEmail(e, el) {
  if (emailsSel.has(e)) { emailsSel.delete(e); el.classList.remove('sel'); }
  else { emailsSel.add(e); el.classList.add('sel'); }
}

function addEmail() {
  const v = document.getElementById('inputNovoEmail').value.trim();
  if (!v || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) { toast('Email inválido','aviso'); return; }
  if (emailsAdd.includes(v) || emailsPadrao.includes(v)) { toast('Já adicionado','aviso'); return; }
  emailsAdd.push(v);
  document.getElementById('inputNovoEmail').value = '';
  renderChipsAdd();
}

function renderChipsAdd() {
  const wrap = document.getElementById('emailsAdicionadosWrap');
  const cont = document.getElementById('chipsEmailAdd');
  wrap.style.display = emailsAdd.length ? 'block' : 'none';
  cont.innerHTML = emailsAdd.map(e =>
    `<div class="email-chip sel">${esc(e)}<button style="background:none;border:none;color:var(--vermelho-vintage);cursor:pointer;padding:0 0 0 4px;" onclick="removeEmailAdd('${e}')"><i class="fas fa-times"></i></button></div>`
  ).join('');
}

function removeEmailAdd(e) { emailsAdd = emailsAdd.filter(x=>x!==e); renderChipsAdd(); }

function confirmarEmail() {
  const todos = [...emailsSel, ...emailsAdd];
  if (!todos.length) { toast('Selecione pelo menos um destinatário','aviso'); return; }
  if (!emailReunId) { toast('ID da reunião não encontrado','erro'); return; }
  mostrarLoading('Enviando email...');
  google.script.run
    .withSuccessHandler(r => {
      esconderLoading();
      if (r?.sucesso) { toast(r.mensagem,'sucesso'); fecharModal('modalEmail'); }
      else toast('Erro: '+(r?.mensagem||'desconhecido'),'erro');
    })
    .withFailureHandler(e => { esconderLoading(); toast('Erro','erro'); })
    .enviarAtaPorEmail(emailReunId, todos);
}

// ═══════════════════════════════════════
//  CONSOLE
// ═══════════════════════════════════════
function abrirConsole() { abrirModal('modalConsole'); }

function log(tipo, msg) {
  totalLogs++;
  const badge = document.getElementById('badgeConsole');
  badge.style.display = 'inline-flex'; badge.textContent = totalLogs;

  const cont = document.getElementById('consoleLogs');
  const vazio = cont.querySelector('.console-vazio');
  if (vazio) vazio.remove();

  const hora = new Date().toLocaleTimeString('pt-BR');
  const div = document.createElement('div');
  div.className = 'log-linha';
  div.innerHTML = `<span class="log-hora">${hora}</span><span class="log-tag ${tipo}">${tipo}</span><span class="log-msg">${esc(msg)}</span>`;
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
}

function limparLogs() {
  totalLogs = 0;
  document.getElementById('consoleLogs').innerHTML = '<div class="console-vazio"><i class="fas fa-terminal"></i><span>Aguardando logs...</span></div>';
  document.getElementById('badgeConsole').style.display = 'none';
}

// ═══════════════════════════════════════
//  MODAL HELPERS
// ═══════════════════════════════════════
function abrirModal(id) { document.getElementById(id).classList.add('visivel'); }
function fecharModal(id) { document.getElementById(id).classList.remove('visivel'); }

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target===m) m.classList.remove('visivel'); });
});

// ═══════════════════════════════════════
//  LOADING
// ═══════════════════════════════════════
function mostrarLoading(txt) { document.getElementById('loadingTexto').textContent = txt||'Processando'; document.getElementById('loadingOverlay').classList.add('visivel'); }
function atualizarLoading(txt) { document.getElementById('loadingTexto').textContent = txt; }
function esconderLoading() { document.getElementById('loadingOverlay').classList.remove('visivel'); }

// ═══════════════════════════════════════
//  TOAST
// ═══════════════════════════════════════
const ICONE_TOAST = { sucesso:'fa-check-circle', erro:'fa-times-circle', aviso:'fa-exclamation-triangle', info:'fa-info-circle' };
function toast(msg, tipo, dur) {
  tipo = tipo||'sucesso'; dur = dur||4000;
  const cont = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = `toast ${tipo}`;
  el.innerHTML = `<i class="fas ${ICONE_TOAST[tipo]||'fa-info-circle'}"></i><span>${esc(msg)}</span><button class="toast-fechar" onclick="this.closest('.toast').remove()"><i class="fas fa-times"></i></button>`;
  cont.appendChild(el);
  setTimeout(() => { el.classList.add('saindo'); setTimeout(() => el.remove(), 250); }, dur);
}

// ═══════════════════════════════════════
//  MARKDOWN → HTML
// ═══════════════════════════════════════
function renderMd(txt) {
  if (!txt) return '';
  return md2html(txt);
}

function renderMdConteudo(txt) {
  if (!txt) return '';
  return `<div class="conteudo-texto">${md2html(txt)}</div>`;
}

function md2html(txt) {
  // Converte markdown para HTML rico
  return txt
    .replace(/^#{4}\s+(.+)$/gm, '<h4>$1</h4>')
    .replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>')
    .replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code style="font-family:monospace;background:var(--creme-medio);padding:1px 5px;border-radius:3px;font-size:0.9em;">$1</code>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/^---+$/gm, '<hr>')
    .replace(/^\| (.+) \|$/gm, (_, row) => {
      const cells = row.split(' | ');
      return '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
    })
    .replace(/(<tr>.*<\/tr>)/gs, (m) => {
      const rows = m.match(/<tr>.*?<\/tr>/gs) || [];
      if (!rows.length) return m;
      const header = rows[0].replace(/<td>/g,'<th>').replace(/<\/td>/g,'</th>');
      const body = rows.slice(1).join('');
      return `<table><thead>${header}</thead><tbody>${body}</tbody></table>`;
    })
    .replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    .replace(/<\/ul>\s*<ul>/g, '')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>');
}

// ═══════════════════════════════════════
//  UTILITÁRIOS
// ═══════════════════════════════════════
function esc(s) { const d=document.createElement('div'); d.textContent=String(s||''); return d.innerHTML; }
function fmtBytes(b) { if(b<1024) return b+' B'; if(b<1024*1024) return (b/1024).toFixed(1)+' KB'; return (b/1024/1024).toFixed(2)+' MB'; }

function limparForm() {
  removerArquivo();
  document.getElementById('inputTitulo').value = '';
  document.getElementById('inputParticipantes').value = '';
  document.getElementById('timerDisplay').textContent = '00:00:00';
  segsGravados = 0;
}

// ═══════════════════════════════════════
//  NAVEGAÇÃO
// ═══════════════════════════════════════
(function() {
  function configurarLinks(url) {
    document.querySelectorAll('a[data-pagina]').forEach(a => {
      const pg = a.getAttribute('data-pagina');
      const full = url + '?pagina=' + pg;
      a.href = full;
      a.addEventListener('click', e => { e.preventDefault(); window.top.location.href = full; });
    });
  }
  if (typeof google !== 'undefined' && google.script) {
    google.script.run.withSuccessHandler(configurarLinks).withFailureHandler(()=>{}).obterUrlBaseWebApp();
  }
})();
</script>
<?!= include('ProtecaoAntiPerda▶️'); ?>
</body>
</html>