<script>
    /* ========================================================================
     * RENDERIZAÇÃO PRINCIPAL & MOTOR DE LINHAS (OTIMIZADO)
     * ======================================================================== */
    
    // Função helper para atualizar ou criar linha (Upsert) - ELIMINA O LAG
    function upsertLinha(idUnico, d, classes, attrs = {}) {
      const svg = document.getElementById('svgConexoes');
      let path = document.getElementById(idUnico);
      
      if (!path) {
        // Se não existe, cria (Insert)
        path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.id = idUnico;
        path.setAttribute('class', classes);
        // Aplica atributos extras
        Object.keys(attrs).forEach(key => path.setAttribute(key, attrs[key]));
        svg.appendChild(path);
      }
      
      // Sempre atualiza o desenho (Update) - Leve e Rápido
      path.setAttribute('d', d);
      return path;
    }

    function renderizarDiagrama() {
      const cont = document.getElementById('containerDiagrama');
      const svg = document.getElementById('svgConexoes');

      // Limpar apenas conteúdo HTML, preservar SVG se possível ou recriar limpo
      // Para renderização completa (load inicial), limpamos tudo
      cont.innerHTML = '';
      cont.appendChild(svg);
      
      svg.innerHTML = ''; 
      svg.innerHTML += `<defs><marker id="setaDependencia" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" class="seta-dependencia" /></marker></defs>`;

      const setoresUnicos = [...new Set(dadosDiagrama.projetos.map(p => p.setor).filter(s => s))];
      setoresUnicos.sort().forEach((nomeSetor, index) => {
          renderizarSetor(nomeSetor, index);
      });

      dadosDiagrama.projetos.forEach(projeto => {
        if (!isProjetoVisivel(projeto.id)) return;
        if (typeof projeto.posX !== 'number' || typeof projeto.posY !== 'number') return;
        
        renderizarProjeto(projeto, projeto.posX, projeto.posY);

        if (estado.projetosExpandidos.has(projeto.id) && !estado.ocultarEtapasAbertas) {
          const etapasRaiz = obterEtapasRaiz(projeto.id);
          const elemProjeto = document.getElementById('projeto-' + projeto.id);
          const ALTURA_CARD_PROJETO = elemProjeto ? elemProjeto.offsetHeight : 180;
          const GAP_VERTICAL = 130;
          const GAP_HORIZONTAL = 100;
          
          const startY = projeto.posY + ALTURA_CARD_PROJETO + GAP_VERTICAL;
          let currentX = projeto.posX;

          etapasRaiz.forEach((etapa) => {
            if (!etapaPassaNosFiltros(etapa)) return;
            const dimensoes = renderizarEtapaComFilhas(etapa, currentX, startY, 0);
            currentX += dimensoes.largura + GAP_HORIZONTAL;
          });
        }
      });

      
      // Renderização inicial de todas as conexões
      renderizarTodasConexoes();
      
      renderizarBarraNavegacao();
      renderizarDashboardSetores();

      // NOVO: Renderizar painel fixo de equipe
      renderizarPainelResponsaveisFixo();
    }

    /**
 * Atualiza badges de prioridade nos cards de projeto existentes
 * Chamado após as prioridades serem carregadas do backend
 */
function atualizarBadgesPrioridadeCards() {
  dadosDiagrama.projetos.forEach(projeto => {
    const card = document.getElementById('projeto-' + projeto.id);
    if (!card) return;
    
    // Remove badge existente se houver
    const badgeExistente = card.querySelector('.badge-prioridade');
    if (badgeExistente) badgeExistente.remove();
    
    // Adiciona novo badge se houver prioridade
    const prioridadeGlobal = obterMaiorPrioridadeProjeto(projeto.id);
    if (prioridadeGlobal) {
      const badgePrio = document.createElement('div');
      badgePrio.className = 'badge-prioridade' + (prioridadeGlobal <= 3 ? ' prioridade-' + prioridadeGlobal : '');
      badgePrio.textContent = 'P' + prioridadeGlobal;
      badgePrio.title = 'Prioridade #' + prioridadeGlobal;
      card.insertBefore(badgePrio, card.firstChild);
    }
  });
  
  // Também atualiza etapas
  dadosDiagrama.etapas.forEach(etapa => {
    const card = document.getElementById('etapa-' + etapa.id);
    if (!card) return;
    
    const badgeExistente = card.querySelector('.badge-prioridade-etapa');
    if (badgeExistente) badgeExistente.remove();
    
    const prioridade = obterMaiorPrioridadeEtapa(etapa.id);
    if (prioridade) {
      const badge = document.createElement('span');
      badge.className = 'badge-prioridade-etapa';
      badge.textContent = '#' + prioridade;
      badge.title = 'Prioridade #' + prioridade;
      
      const header = card.querySelector('.etapa-badges');
      if (header) header.insertBefore(badge, header.firstChild);
    }
  });
}

/**
 * Obtém a maior prioridade de uma etapa
 */
function obterMaiorPrioridadeEtapa(etapaId) {
  if (!dadosDiagrama || !dadosDiagrama.prioridadesPorResponsavel) return null;
  if (!(dadosDiagrama.prioridadesPorResponsavel instanceof Map)) return null;
  if (dadosDiagrama.prioridadesPorResponsavel.size === 0) return null;
  
  let menorPrioridade = null;
  
  dadosDiagrama.prioridadesPorResponsavel.forEach((lista) => {
    if (!lista || !Array.isArray(lista)) return;
    
    const item = lista.find(p => p.tipoItem === 'etapa' && p.itemId === etapaId);
    if (item) {
      if (menorPrioridade === null || item.ordemPrioridade < menorPrioridade) {
        menorPrioridade = item.ordemPrioridade;
      }
    }
  });
  
  return menorPrioridade;
}
    
    function renderizarTodasConexoes() {
       dadosDiagrama.projetos.forEach(p => redesenharLinhasProjeto(p.id));
       
       dadosDiagrama.etapas.forEach(etapa => {
          if (etapaPassaNosFiltros(etapa)) {
             redesenharLinhasEtapa(etapa.id);
          }
       });
       
       dadosDiagrama.responsaveis.forEach(r => {
          if (estado.filtroResponsaveis.has(r.id)) {
             redesenharLinhasResponsavel(r.id);
          }
       });
       
       // Dependências soltas (garantia)
       dadosDiagrama.dependencias.forEach(dep => {
          // Apenas redesenha se as etapas existirem no DOM
          const elOrig = document.getElementById('etapa-' + dep.etapaOrigemId);
          const elDest = document.getElementById('etapa-' + dep.etapaDestinoId);
          if (elOrig && elDest) {
             const idLinha = `conn-dep-${dep.id}`;
             const p1 = obterPosAnchor(elOrig, dep.origemAnchor || 'direita');
             const p2 = obterPosAnchor(elDest, dep.destinoAnchor || 'esquerda');
             const d = obterCaminhoOrtogonal(p1, p2, 'horizontal');
             
             const path = upsertLinha(idLinha, d, 'linha-dependencia', {
                'marker-end': 'url(#setaDependencia)',
                'data-etapa-origem': dep.etapaOrigemId,
                'data-etapa-destino': dep.etapaDestinoId
             });
             
             // Reatribuir evento click é barato
             path.onclick = (e) => {
                e.stopPropagation();
                if (!podeEditar()) return;
                if (confirm('Remover dependência?')) {
                  google.script.run.removerDependencia(dep.id);
                  dadosDiagrama.dependencias = dadosDiagrama.dependencias.filter(x => x.id !== dep.id);
                  path.remove();
                }
             };
          }
       });
    }

    /* FUNÇÕES DE RENDERIZAÇÃO INCREMENTAL (OTIMIZADAS) */
    
    function atualizarConexoesParciais(tipo, id) {
      if (tipo === 'projeto') {
          redesenharLinhasProjeto(id);
      } 
      else if (tipo === 'etapa') {
          redesenharLinhasEtapa(id);
          
          const etapa = dadosDiagrama.etapas.find(e => e.id === id);
          if (etapa && etapa.projetoId && !etapa.etapaPaiId) {
              if (estado.tipoArrastando !== 'projeto') {
                  redesenharLinhasProjeto(etapa.projetoId);
              }
          }
      } 
      else if (tipo === 'responsavel') {
          redesenharLinhasResponsavel(id);
      } 
      else if (tipo === 'setor') {
          redesenharLinhasSetor(id);
      }
    }

    function redesenharLinhasProjeto(projetoId) {
      const projeto = dadosDiagrama.projetos.find(p => p.id === projetoId);
      if (!projeto) return;
      if (!isProjetoVisivel(projetoId)) return;
      
      const elProj = document.getElementById('projeto-' + projetoId);
      if (!elProj) return;

      // 1. Linha Setor -> Projeto
      if (projeto.setor) {
        const elSetor = document.getElementById('setor-' + projeto.setor.replace(/\s+/g, '-'));
        if (elSetor) {
          const idLinha = `conn-setor-${projeto.setor.replace(/\s+/g, '')}-proj-${projetoId}`;
          const pS = obterPosAnchor(elSetor, 'baixo');
          const pP = obterPosAnchor(elProj, 'topo');
          const d = obterCaminhoOrtogonal(pS, pP, 'vertical');
          
          upsertLinha(idLinha, d, 'linha-padrao linha-hierarquia-setor', {
             'data-projeto': projetoId,
             'data-setor': projeto.setor
          });
        }
      }
      
      // 2. Linhas Projeto -> Etapas Raiz
      if (estado.projetosExpandidos.has(projetoId) && !estado.ocultarEtapasAbertas) {
        const etapasRaiz = obterEtapasRaiz(projetoId);
        etapasRaiz.forEach(etapa => {
          if (!etapaPassaNosFiltros(etapa)) return;
          const elEtapa = document.getElementById('etapa-' + etapa.id);
          if (elEtapa) {
            const idLinha = `conn-proj-${projetoId}-etapa-${etapa.id}`;
            const pP = obterPosAnchor(elProj, 'baixo');
            const pE = obterPosAnchor(elEtapa, 'topo');
            const d = obterCaminhoOrtogonal(pP, pE, 'vertical');
            
            upsertLinha(idLinha, d, 'linha-padrao linha-hierarquia-projeto', {
                'data-projeto': projetoId,
                'data-etapa-destino': etapa.id
            });
          }
        });
      }
    }

    function redesenharLinhasEtapa(etapaId) {
      const etapa = dadosDiagrama.etapas.find(e => e.id === etapaId);
      if (!etapa) return;
      
      const elFilha = document.getElementById('etapa-' + etapaId);
      if (!elFilha) return; 

      // 1. Pai -> Esta Etapa (Hierarquia)
      if (etapa.etapaPaiId && !estado.etapasFilhasColapsadas.has(etapa.etapaPaiId)) {
        const elPai = document.getElementById('etapa-' + etapa.etapaPaiId);
        if (elPai) {
          const idLinha = `conn-etapa-${etapa.etapaPaiId}-etapa-${etapaId}`;
          const pPai = obterPosAnchor(elPai, 'baixo');
          const pFilha = obterPosAnchor(elFilha, 'esquerda');
          const d = obterCaminhoOrtogonal(pPai, pFilha, 'hierarquia');
          
          upsertLinha(idLinha, d, 'linha-padrao linha-hierarquia', {
             'data-etapa-origem': etapa.etapaPaiId,
             'data-etapa-destino': etapaId
          });
        }
      }
      
      // 2. Esta Etapa -> Filhas (Hierarquia) - Saída
      if (!estado.etapasFilhasColapsadas.has(etapaId)) {
        const filhas = obterEtapasFilhas(etapaId).filter(f => etapaPassaNosFiltros(f));
        filhas.forEach(filha => {
          const elFilhaCard = document.getElementById('etapa-' + filha.id);
          if (elFilhaCard) {
            const idLinha = `conn-etapa-${etapaId}-etapa-${filha.id}`;
            const pPai = obterPosAnchor(elFilha, 'baixo');
            const pFilhaDest = obterPosAnchor(elFilhaCard, 'esquerda');
            const d = obterCaminhoOrtogonal(pPai, pFilhaDest, 'hierarquia');
            
            upsertLinha(idLinha, d, 'linha-padrao linha-hierarquia', {
               'data-etapa-origem': etapaId,
               'data-etapa-destino': filha.id
            });
          }
        });
      }
      
      // 3. Responsável -> Esta Etapa (Vínculo)
      // MODIFICADO: Só desenha linha se houver responsáveis diretos (suporta múltiplos)
      if (etapa.responsaveisIds && etapa.responsaveisIds.length > 0) {
        etapa.responsaveisIds.forEach(respId => {
          if (estado.filtroResponsaveis.has(respId)) {
            const elResp = document.getElementById('responsavel-' + respId);
            if (elResp) {
              const idLinha = `conn-resp-${respId}-etapa-${etapaId}`;
              const pR = obterPosAnchor(elResp, 'direita');
              const pE = obterPosAnchor(elFilha, 'esquerda');
              const d = obterCaminhoOrtogonal(pR, pE, 'horizontal');
              
              const path = upsertLinha(idLinha, d, 'linha-vinculo', {
                 'data-responsavel': respId,
                 'data-etapa-destino': etapaId
              });
              
              path.onclick = (e) => {
                 e.stopPropagation();
                 if (!podeEditar()) return;
                 // Lógica simplificada: Remover apenas este responsável
                 if (confirm('Desvincular este responsável?')) {
                     const novosIds = etapa.responsaveisIds.filter(id => id !== respId);
                     const dadosAtualizacao = { responsaveisIds: novosIds };
                     google.script.run.withSuccessHandler(() => {
                         etapa.responsaveisIds = novosIds;
                         path.remove();
                         renderizarDiagrama(); 
                         mostrarToast('Vínculo removido', 'sucesso');
                     }).atualizarEtapa(etapaId, dadosAtualizacao);
                 }
              };
            }
          }
        });
      }
      
      // 4. Dependências (Entrada e Saída)
      const deps = dadosDiagrama.dependencias.filter(d => d.etapaOrigemId === etapaId || d.etapaDestinoId === etapaId);
      deps.forEach(dep => {
        const elOrig = document.getElementById('etapa-' + dep.etapaOrigemId);
        const elDest = document.getElementById('etapa-' + dep.etapaDestinoId);
        
        if (elOrig && elDest) {
          const idLinha = `conn-dep-${dep.id}`;
          const p1 = obterPosAnchor(elOrig, 'direita'); 
          const p2 = obterPosAnchor(elDest, 'esquerda'); 
          const d = obterCaminhoOrtogonal(p1, p2, 'horizontal');
          
          const path = upsertLinha(idLinha, d, 'linha-dependencia', {
             'marker-end': 'url(#setaDependencia)',
             'data-etapa-origem': dep.etapaOrigemId,
             'data-etapa-destino': dep.etapaDestinoId
          });
          
          path.onclick = (e) => {
             e.stopPropagation();
             if (!podeEditar()) return;
             if (confirm('Remover dependência?')) {
               google.script.run.removerDependencia(dep.id);
               dadosDiagrama.dependencias = dadosDiagrama.dependencias.filter(x => x.id !== dep.id);
               path.remove();
             }
          };
        }
      });
    }

    function redesenharLinhasResponsavel(responsavelId) {
      const elResp = document.getElementById('responsavel-' + responsavelId);
      if (!elResp) return;
      
      // Encontra etapas onde este responsável está listado (em array ou string legada)
      const etapasVinculadas = dadosDiagrama.etapas.filter(e => {
          if (!etapaPassaNosFiltros(e)) return false;
          // Verifica se ID está no array
          if (Array.isArray(e.responsaveisIds) && e.responsaveisIds.includes(responsavelId)) return true;
          // Fallback legado
          if (e.responsavelId === responsavelId) return true;
          return false;
      });
      
      etapasVinculadas.forEach(etapa => {
        const elEtapa = document.getElementById('etapa-' + etapa.id);
        if (elEtapa) {
          const idLinha = `conn-resp-${responsavelId}-etapa-${etapa.id}`;
          const pR = obterPosAnchor(elResp, 'direita');
          const pE = obterPosAnchor(elEtapa, 'esquerda');
          const d = obterCaminhoOrtogonal(pR, pE, 'horizontal');
          
          const path = upsertLinha(idLinha, d, 'linha-vinculo', {
             'data-responsavel': responsavelId,
             'data-etapa-destino': etapa.id
          });
          
          path.onclick = (e) => {
             e.stopPropagation();
             if(confirm('Desvincular?')) {
                 const novosIds = (etapa.responsaveisIds || []).filter(id => id !== responsavelId);
                 google.script.run.atualizarEtapa(etapa.id, { responsaveisIds: novosIds });
                 etapa.responsaveisIds = novosIds;
                 path.remove();
             }
          };
        }
      });
    }

    function redesenharLinhasSetor(nomeSetor) {
      const elSetor = document.getElementById('setor-' + nomeSetor.replace(/\s+/g, '-'));
      if (!elSetor) return;
      
      const projetosDoSetor = dadosDiagrama.projetos.filter(p => p.setor === nomeSetor);
      
      projetosDoSetor.forEach(projeto => {
        if (!isProjetoVisivel(projeto.id)) return;
        const elProj = document.getElementById('projeto-' + projeto.id);
        if (elProj) {
          const idLinha = `conn-setor-${nomeSetor.replace(/\s+/g, '')}-proj-${projeto.id}`;
          const pS = obterPosAnchor(elSetor, 'baixo');
          const pP = obterPosAnchor(elProj, 'topo');
          const d = obterCaminhoOrtogonal(pS, pP, 'vertical');
          
          upsertLinha(idLinha, d, 'linha-padrao linha-hierarquia-setor', {
             'data-setor': nomeSetor,
             'data-projeto': projeto.id
          });
        }
      });
    }

    /* RENDERIZAÇÃO DE COMPONENTES */
    
    function renderizarBarraNavegacao() {
      renderizarNavSetores();
      renderizarNavEtapas();
    }

    function renderizarNavEtapas() {
      const container = document.getElementById('navListaEtapas');
      const contador = document.getElementById('navContadorEtapas');
      
      if (!container) return;
      
      container.innerHTML = '';
      
      const etapasPendentes = dadosDiagrama.etapas.filter(e => 
         e.status !== STATUS_ETAPAS.CONCLUIDA &&
         estado.projetosExpandidos.has(e.projetoId)
      );
      
      if (contador) contador.textContent = etapasPendentes.length;
      
      etapasPendentes.forEach(etapa => {
        const projeto = dadosDiagrama.projetos.find(p => p.id === etapa.projetoId);
        const nomeProjeto = projeto ? projeto.nome : 'Desconhecido';
        const corStatus = obterCorPorStatusEtapa(etapa.status);
        
        const card = document.createElement('div');
        card.className = 'nav-card-etapa';
        card.style.borderLeftColor = corStatus.cor;
        
        card.innerHTML = `
          <div class="nav-etapa-status" style="background: ${corStatus.bgCor}; color: ${corStatus.cor};">
            <i class="fas ${obterIconeStatus(etapa.status)}"></i>
          </div>
          <div class="nav-etapa-info">
            <div class="nav-etapa-nome" title="${escaparHtml(etapa.nome)}">${escaparHtml(etapa.nome)}</div>
            <div class="nav-etapa-projeto" title="Projeto: ${escaparHtml(nomeProjeto)}">
              <i class="fas fa-folder"></i>
              <span>${escaparHtml(nomeProjeto)}</span>
            </div>
          </div>
        `;
        
        card.addEventListener('click', () => navegarParaEtapa(etapa.id));
        container.appendChild(card);
      });
    }
    
    function renderizarNavSetores() {
      try {
        const container = document.getElementById('navListaSetores');
        const contador = document.getElementById('navContadorSetores');
        
        if (!container) return;
        
        container.innerHTML = '';
        const setoresUnicos = [...new Set(dadosDiagrama.projetos.map(p => p.setor).filter(s => s))].sort();
        if (contador) contador.textContent = setoresUnicos.length;
        
        setoresUnicos.forEach(nomeSetor => {
          const projetosDoSetor = dadosDiagrama.projetos.filter(p => p.setor === nomeSetor);
          const totalProjetos = projetosDoSetor.length;
          let totalPendentes = 0;
          projetosDoSetor.forEach(proj => {
            const etapasProj = dadosDiagrama.etapas.filter(e => e.projetoId === proj.id);
            totalPendentes += etapasProj.filter(e => e.status !== STATUS_ETAPAS.CONCLUIDA).length;
          });
          const colapsado = estado.setoresColapsados.has(nomeSetor);
            
          const card = document.createElement('div');
          card.className = 'nav-card-setor';
          if (colapsado) card.classList.add('colapsado');
            
          card.innerHTML = `
            ${colapsado ? '<div class="nav-badge-colapsado">OCULTO</div>' : ''}
            <div class="nav-setor-header">
              <div class="nav-setor-icone"><i class="fas fa-building"></i></div>
              <div class="nav-setor-nome" title="${escaparHtml(nomeSetor)}">${escaparHtml(nomeSetor)}</div>
            </div>
            <div class="nav-setor-stats">
              <div class="nav-setor-stat projetos"><i class="fas fa-folder"></i><span>${totalProjetos}</span></div>
              ${totalPendentes > 0 ? `<div class="nav-setor-stat pendentes"><i class="fas fa-clock"></i><span>${totalPendentes}</span></div>` : ''}
            </div>
          `;
          card.addEventListener('click', () => navegarParaSetor(nomeSetor));
          container.appendChild(card);
        });
      } catch (e) { console.error(e); }
    }

    function toggleColapsoSetor(nomeSetor) {
      if (estado.setoresColapsados.has(nomeSetor)) {
        estado.setoresColapsados.delete(nomeSetor);
        mostrarToast(`Setor "${nomeSetor}" expandido`, 'info');
      } else {
        estado.setoresColapsados.add(nomeSetor);
        mostrarToast(`Setor "${nomeSetor}" oculto`, 'info');
      }
      renderizarDiagrama();
    }

    function renderizarSetor(nome, index) {
      const cont = document.getElementById('containerDiagrama');
      const projetosDoSetor = dadosDiagrama.projetos.filter(p => p.setor === nome);

      const colapsadoGrafo = estado.setoresColapsados.has(nome);
      const detalhesExpandidos = estado.setoresDetalhesExpandidos.has(nome);
      const moveIndependente = estado.modoMovimentoSetorIndependente.has(nome);

      const total = projetosDoSetor.length;
      const ativos = projetosDoSetor.filter(p => !p.status || p.status === 'Ativo').length;
      const pausados = projetosDoSetor.filter(p => p.status === 'Pausado').length;
      const concluidos = projetosDoSetor.filter(p => p.status === 'Concluído').length;

      const gerente = obterGerenteSetor(nome);
      const nomeGerente = gerente ? gerente.nome : 'Sem gerente';
      const nomeSafe = nome.replace(/'/g, "\\'");

      let xSetor = 100;
      let ySetor = 40;
      if (estado.posicoesSetores && estado.posicoesSetores[nome]) {
        xSetor = estado.posicoesSetores[nome].x;
        ySetor = estado.posicoesSetores[nome].y;
      } else if (projetosDoSetor.length > 0) {
        const avgX = projetosDoSetor.reduce((s, p) => s + (p.posX || 0), 0) / projetosDoSetor.length;
        xSetor = avgX;
      }

      const listaProjetosHtml = projetosDoSetor.map(p => `
        <div
          class="setor-projeto-item"
          onclick="navegarParaProjeto('${p.id}')"
          title="Ir para o projeto no canvas"
          onmousedown="event.stopPropagation()"
        >
          <i class="fas fa-folder-open"></i>
          <span>${escaparHtml(p.nome)}</span>
        </div>
      `).join('');

      const card = document.createElement('div');
      card.className = 'card-setor arrastavel';
      card.id = 'setor-' + nome.replace(/\s+/g, '-');
      card.style.left = xSetor + 'px';
      card.style.top = ySetor + 'px';

      card.innerHTML = `
        <div class="setor-header">
          <div class="setor-titulo">
            <i class="fas fa-building"></i>
            <span>${escaparHtml(nome)}</span>
          </div>
          <div class="setor-acoes">
            ${podeEditar() ? `
    <button 
      class="btn-setor-toggle"
      onclick="event.stopPropagation(); editarSetorPorNome('${nomeSafe}')"
      title="Editar setor">
      <i class="fas fa-edit"></i>
    </button>
  ` : ''}
            <button    class="btn-setor-toggle ${moveIndependente ? 'ativo' : ''}"   onclick="event.stopPropagation(); alternarMovimentoSetorIndependente('${nomeSafe}')"   title="${moveIndependente ? 'Mover setor sozinho' : 'Mover setor com projetos'}">   <i class="fas fa-${moveIndependente ? 'arrow-down-up-across-line' : 'arrow-down-up-lock'}"></i></button>
            <button onclick="toggleDetalhesSetor('${nomeSafe}')" title="Mostrar lista de projetos" onmousedown="event.stopPropagation()">
              <i class="fas fa-list"></i>
            </button>
            <button 
              onclick="toggleColapsoSetor('${nomeSafe}')" 
              title="${colapsadoGrafo ? 'Mostrar projetos no canvas' : 'Ocultar projetos do canvas'}" 
              onmousedown="event.stopPropagation()"
              style="color: ${colapsadoGrafo ? '#e53e3e' : '#38a169'};"
            >
              <i class="fas ${colapsadoGrafo ? 'fa-eye-slash' : 'fa-eye'}"></i>
            </button>
          </div>
        </div>
        
        <div class="setor-gerente">
          <i class="fas fa-user-tie"></i>
          <span class="${gerente ? '' : 'sem-responsavel'}">${escaparHtml(nomeGerente)}</span>
          ${podeEditar() ? `<button class="btn-editar-gerente" onclick="event.stopPropagation();abrirModalGerenteSetor('${nomeSafe}')" title="Alterar Gerente"><i class="fas fa-edit"></i></button>` : ''}
        </div>

        <div class="setor-resumo">
          <span>Total: <b>${total}</b></span>
          <span>Ativos: <b>${ativos}</b></span>
          <span>Pausados: <b>${pausados}</b></span>
          <span>Concl: <b>${concluidos}</b></span>
        </div>
        ${detalhesExpandidos ? `<div class="setor-lista-projetos" onmousedown="event.stopPropagation()">${listaProjetosHtml || '<em>Sem projetos</em>'}</div>` : ''}
      `;

      card.addEventListener('mousedown', e => {
        if (!podeEditar()) return;
        if (e.target.closest('button') || e.target.closest('.setor-lista-projetos')) return; 
        iniciarArraste(e, 'setor', nome);
      });

      cont.appendChild(card);
    }

    function alternarMovimentoSetorIndependente(nomeSetor) {
       if (estado.modoMovimentoSetorIndependente.has(nomeSetor)) {
          estado.modoMovimentoSetorIndependente.delete(nomeSetor);
          mostrarToast(`Setor "${nomeSetor}" move projetos junto`, 'info');
       } else {
          estado.modoMovimentoSetorIndependente.add(nomeSetor);
          mostrarToast(`Setor "${nomeSetor}" move independente`, 'info');
       }
       renderizarDiagrama();
    }

    function renderizarProjeto(p, x, y) {
      const cont = document.getElementById('containerDiagrama');
      const exp = estado.projetosExpandidos.has(p.id);
      const etapas = dadosDiagrama.etapas.filter(e => e.projetoId === p.id);
      
      const total = etapas.length;
      const pend = etapas.filter(e => e.status !== STATUS_ETAPAS.CONCLUIDA).length;
      const concluidas = etapas.filter(e => e.status === STATUS_ETAPAS.CONCLUIDA).length;
      const bloq = etapas.filter(e => e.status === STATUS_ETAPAS.BLOQUEADA).length;
      
      const stCls = (p.status || 'ativo').toLowerCase();
      const prCls = (p.prioridade || 'media').toLowerCase();

      const percentual = total > 0 ? Math.round((concluidas / total) * 100) : 0;
      
      let progressoProjeto = { percentual, concluidas, total, statusGeral: p.status, corProgresso: { cor: '#3182ce', bgCor: '#ebf8ff' } };
      
      if (p.status === 'Concluído') progressoProjeto.corProgresso = { cor: '#38a169', bgCor: '#f0fff4' };
      else if (p.status === 'Pausado') progressoProjeto.corProgresso = { cor: '#d69e2e', bgCor: '#fffff0' };
      else if (percentual > 75) progressoProjeto.corProgresso = { cor: '#319795', bgCor: '#e6fffa' };
      else if (percentual > 40) progressoProjeto.corProgresso = { cor: '#3182ce', bgCor: '#ebf8ff' };

      const arvoreEtapas = montarArvoreEtapas(p.id);
      const mostrarLista = estado.projetosEtapasVisiveis.has(p.id);
      const listaEtapasHtml = arvoreEtapas.length
        ? renderizarListaEtapasProjeto(arvoreEtapas)
        : '<em style="opacity:.6;font-size:.75rem;padding:8px;display:block;">Sem etapas cadastradas</em>';

      // MODIFICADO: Renderização de múltiplos responsáveis no projeto
      const respsProjeto = obterResponsaveisProjeto(p);
      const responsaveisHtml = respsProjeto.length > 0 
        ? `<div class="projeto-responsaveis">
            ${respsProjeto.map(r => `
              <div class="resp-chip ${r.herdado ? 'herdado' : ''}">
                <span class="resp-chip-avatar">${(r.nome || 'N').charAt(0)}</span>
                <span class="resp-chip-nome" title="${escaparHtml(r.nome)}${r.herdado ? ' (herdado)' : ''}">${escaparHtml(r.nome)}</span>
              </div>
            `).join('')}
           </div>`
        : `<div class="projeto-responsaveis sem-responsavel">
             <i class="fas fa-user-slash"></i>
             <span>Sem responsável</span>
           </div>`;

      const card = document.createElement('div');
      card.className = 'card-projeto' + (exp ? ' expandido' : '') + (p.bloqueado ? ' bloqueado-card' : '');
      card.id = 'projeto-' + p.id;
      card.style.left = x + 'px';
      card.style.top = y + 'px';
      card.dataset.id = p.id;
      card.dataset.tipo = 'projeto';

      

      const setorSafe = p.setor ? p.setor.replace(/'/g, "\\'") : '';
      const infoExtra = (p.setor || p.pilar) ? 
        `<div class="projeto-info-setor">
           ${p.setor ? `
             <span 
                class="projeto-setor-link" 
                onclick="event.stopPropagation();navegarParaSetor('${setorSafe}')"
                title="Navegar para o setor ${escaparHtml(p.setor)}"
             >
               <i class="fas fa-building"></i>
               <span>${escaparHtml(p.setor)}</span>
               <i class="fas fa-arrow-right indicador-nav"></i>
             </span>
           ` : ''}
           ${p.pilar ? `<span class="projeto-pilar"><i class="fas fa-bookmark"></i>${escaparHtml(p.pilar)}</span>` : ''}
         </div>` : '';

      const linkHtml = p.link ? `<div class="projeto-link-container"><a href="${escaparHtml(p.link)}" target="_blank" class="projeto-link-btn" onclick="event.stopPropagation()"><i class="fas fa-external-link-alt"></i><span>Link</span></a></div>` : '';

      // Adicionar badge de prioridade se existir (NOVO)
      const prioridadeGlobal = obterMaiorPrioridadeProjeto(p.id);
      if (prioridadeGlobal) {
        const badgePrio = document.createElement('div');
        badgePrio.className = 'badge-prioridade' + (prioridadeGlobal <= 3 ? ' prioridade-' + prioridadeGlobal : '');
        badgePrio.textContent = 'P' + prioridadeGlobal;
        badgePrio.title = 'Prioridade #' + prioridadeGlobal;
        card.appendChild(badgePrio);
      }

      card.innerHTML += `
        <div class="projeto-barra-status ${stCls}" style="background: ${progressoProjeto.corProgresso.cor};"></div>
        <div class="projeto-indicador-progresso" style="background: ${progressoProjeto.corProgresso.bgCor};">
          <div class="projeto-progresso-info">
            <i class="fas ${obterIconePorStatus(progressoProjeto.statusGeral)}" style="color: ${progressoProjeto.corProgresso.cor};"></i>
            <span class="projeto-progresso-texto" style="color: ${progressoProjeto.corProgresso.cor};">
              ${progressoProjeto.percentual}% (${progressoProjeto.concluidas}/${progressoProjeto.total})
            </span>
          </div>
          <div class="projeto-progresso-barra">
            <div class="projeto-progresso-preenchimento"
                  style="width: ${progressoProjeto.percentual}%; background: ${progressoProjeto.corProgresso.cor};">
            </div>
          </div>
        </div>

        <div class="projeto-conteudo">
          ${infoExtra}
          ${responsaveisHtml} 
          <div class="projeto-header">
            <div class="projeto-icone"><i class="fas fa-folder"></i></div>
            <div class="projeto-titulo-wrap">
              <div class="projeto-nome" title="${escaparHtml(p.nome)}">${escaparHtml(p.nome) || 'Sem nome'}</div>
              <div class="projeto-para-quem">${escaparHtml(p.paraQuem) || ''}</div>
            </div>
            <span class="projeto-prioridade ${prCls}">${escaparHtml(p.prioridade) || 'Média'}</span>
          </div>
          <div class="projeto-badges">
            <span class="projeto-badge total" title="Total de Etapas"><i class="fas fa-layer-group"></i>${etapas.length}</span>
            ${pend > 0 ? `<span class="projeto-badge pendentes" title="Pendentes"><i class="fas fa-clock"></i>${pend}</span>` : ''}
            ${bloq > 0 ? `<span class="projeto-badge bloqueadas" title="Bloqueadas"><i class="fas fa-ban"></i>${bloq}</span>` : ''}
            
            <span 
              class="projeto-badge acao"
              style="cursor:pointer; background: ${mostrarLista ? 'var(--cor-primaria)' : 'var(--cor-primaria-bg)'}; color: ${mostrarLista ? 'white' : 'var(--cor-primaria)'};"
              title="${mostrarLista ? 'Ocultar etapas' : 'Ver etapas'}"
              onclick="event.stopPropagation();toggleListaEtapasProjeto('${p.id}')"
            >
              <i class="fas ${mostrarLista ? 'fa-eye-slash' : 'fa-list'}"></i>
            </span>
          </div>

          <div class="projeto-lista-etapas ${mostrarLista ? 'visivel' : ''}" onmousedown="event.stopPropagation()">
            ${listaEtapasHtml}
          </div>

          ${linkHtml}
          
          <button 
            class="btn-projeto-detalhe"
            onclick="event.stopPropagation();abrirPaginaProjeto('${p.id}')"
            title="Abrir página de detalhes do projeto"
          >
            <i class="fas fa-external-link-alt"></i>
            <span>Detalhes</span>
          </button>
        </div>
        
        <div class="projeto-acoes">
          ${podeCriarEtapaLocal(p.id) ? `
            <button class="btn-projeto-acao" onclick="event.stopPropagation();criarEtapa('${p.id}')" title="Criar Etapa Raiz"><i class="fas fa-plus"></i></button>
          ` : ''}
          ${podeEditarProjetoLocal(p.id) ? `
            <button class="btn-projeto-acao" onclick="event.stopPropagation();editarProjeto('${p.id}')" title="Editar Projeto"><i class="fas fa-edit"></i></button>
            <button class="btn-projeto-acao lock ${p.bloqueado ? 'locked' : ''}" onclick="event.stopPropagation();alternarBloqueioProjeto('${p.id}')" title="Bloquear/Desbloquear"><i class="fas fa-${p.bloqueado ? 'lock' : 'lock-open'}"></i></button>
          ` : ''}
          <button class="btn-projeto-acao expandir ${exp ? 'ativo' : ''}" onclick="event.stopPropagation();toggleExpandirProjeto('${p.id}')" title="Expandir/Recolher"><i class="fas fa-chevron-${exp ? 'up' : 'down'}"></i>${exp ? 'Ocultar' : 'Ver'}</button>
        </div>
      `;

      card.addEventListener('mousedown', e => {
        if (!podeEditar()) return;
        if (p.bloqueado) { mostrarToast('Projeto bloqueado para movimentação.', 'aviso'); return; }
        if (e.target.closest('.btn-projeto-acao, .projeto-acoes, .projeto-link-btn, a, .projeto-lista-etapas, .projeto-badge, .projeto-setor-link, .btn-projeto-detalhe')) return;
        iniciarArraste(e, 'projeto', p.id);
      });
      cont.appendChild(card);
    }


/**
 * Alterna a visibilidade da lista de etapas dentro do card do projeto
 * E desloca os cards de etapas abaixo para evitar sobreposição
 * @param {string} projetoId - ID do projeto
 */
function toggleListaEtapasProjeto(projetoId) {
  if (!estado.projetosExpandidos.has(projetoId)) {
    estado.projetosExpandidos.add(projetoId);
  }
    
  const estaVisivel = estado.projetosEtapasVisiveis.has(projetoId);
  const card = document.getElementById('projeto-' + projetoId);
  if (!card) return;
  
  const containerLista = card.querySelector('.projeto-lista-etapas');
  const badge = card.querySelector('.projeto-badge.acao');
  
  // Captura altura ANTES da mudança
  const alturaAntes = card.offsetHeight;
  
  if (estaVisivel) {
    // Vai COLAPSAR
    estado.projetosEtapasVisiveis.delete(projetoId);
    if (containerLista) containerLista.classList.remove('visivel');
  } else {
    // Vai EXPANDIR
    estado.projetosEtapasVisiveis.add(projetoId);
    if (containerLista) containerLista.classList.add('visivel');
  }
  
  // Atualiza badge visual
  if (badge) {
    const icone = badge.querySelector('i');
    if (icone) {
      icone.className = estaVisivel ? 'fas fa-list' : 'fas fa-eye-slash';
    }
    badge.style.background = estaVisivel ? 'var(--cor-primaria-bg)' : 'var(--cor-primaria)';
    badge.style.color = estaVisivel ? 'var(--cor-primaria)' : 'white';
  }
  
  // Aguarda a transição CSS e recalcula
  setTimeout(() => {
    const alturaDepois = card.offsetHeight;
    const deltaAltura = alturaDepois - alturaAntes;
    
    if (Math.abs(deltaAltura) > 5) {
      // Desloca etapas do projeto para evitar sobreposição
      deslocarEtapasDoProjeto(projetoId, deltaAltura);
    }
    
    // Atualiza conexões
    redesenharLinhasProjeto(projetoId);
  }, 320); // Tempo da transição CSS
}

/**
 * Desloca verticalmente todas as etapas de um projeto
 * @param {string} projetoId - ID do projeto
 * @param {number} deltaY - Quanto deslocar (positivo = para baixo)
 */
function deslocarEtapasDoProjeto(projetoId, deltaY) {
  const etapasDoProjeto = dadosDiagrama.etapas.filter(e => e.projetoId === projetoId);
  
  etapasDoProjeto.forEach(etapa => {
    const cardEtapa = document.getElementById('etapa-' + etapa.id);
    if (cardEtapa) {
      // Adiciona classe para animação suave
      cardEtapa.classList.add('card-deslocando-expansao');
      
      const yAtual = parseFloat(cardEtapa.style.top) || 0;
      cardEtapa.style.top = (yAtual + deltaY) + 'px';
      
      // Atualiza cache
      if (cachePosicoesEtapas.has(etapa.id)) {
        const cache = cachePosicoesEtapas.get(etapa.id);
        cachePosicoesEtapas.set(etapa.id, { x: cache.x, y: cache.y + deltaY });
      }
      
      // Remove classe após animação
      setTimeout(() => {
        cardEtapa.classList.remove('card-deslocando-expansao');
      }, 350);
    }
  });
  
  // Atualiza conexões de todas as etapas
  setTimeout(() => {
    etapasDoProjeto.forEach(etapa => {
      atualizarConexoesParciais('etapa', etapa.id);
    });
  }, 100);
}

    function renderizarEtapa(et, x, y, nivel) {
      const cont = document.getElementById('containerDiagrama');
      const temFilhas = obterEtapasFilhas(et.id).length > 0;
      const filhasColapsadas = estado.etapasFilhasColapsadas.has(et.id);
      const expandida = estado.etapasExpandidas.has(et.id);
      const stNorm = normalizarStatus(et.status);
      const largura = obterLarguraEtapaPorNivel(nivel);
      
      const corStatus = obterCorPorStatusEtapa(et.status);

      const card = document.createElement('div');
      card.className = `card-etapa nivel-${Math.min(nivel, 3)} status-${stNorm}`;
      if (expandida) card.classList.add('expandida');
      card.id = 'etapa-' + et.id;
      card.style.left = x + 'px';
      card.style.top = y + 'px';
      card.style.width = largura + 'px';
      card.dataset.id = et.id;
      card.dataset.tipo = 'etapa';
      if (et.bloqueado) card.classList.add('bloqueado-card');
      
      card.style.setProperty('--cor-status-etapa', corStatus.cor);
      card.style.setProperty('--cor-status-etapa-bg', corStatus.bgCor);
      
      cachePosicoesEtapas.set(et.id, {x, y});

      // MODIFICADO: Renderização de múltiplos responsáveis na etapa
      const respsEtapa = obterResponsaveisEtapa(et);
      const responsaveisResumoHtml = respsEtapa.length > 0
        ? respsEtapa.map(r => `
            <span class="etapa-resp-nome ${r.herdado ? 'herdado' : ''}" title="${escaparHtml(r.nome)}${r.herdado ? ' (herdado)' : ''}">
              ${escaparHtml(r.nome)}${r.herdado ? '<small>(h)</small>' : ''}
            </span>
          `).join(', ')
        : '<span class="sem-responsavel">Não atribuído</span>';

      const projeto = dadosDiagrama.projetos.find(p => p.id === et.projetoId);
      const nomeProjeto = projeto ? projeto.nome : 'Desconhecido';
      const nomeProjetoSafe = nomeProjeto.replace(/'/g, "\\'");
        
      let btnExpandirPrincipal = `
        <button class="btn-etapa-expandir" onclick="event.stopPropagation();toggleExpandirEtapa('${et.id}')" title="${expandida ? 'Recolher' : 'Expandir'}">
          <i class="fas fa-chevron-${expandida ? 'up' : 'down'}"></i>
        </button>
      `;
        
      let btnToggleFilhas = '';
      if (temFilhas) {
        btnToggleFilhas = `
          <button class="btn-etapa-toggle-filhas ${filhasColapsadas ? 'colapsado' : ''}" 
                   onclick="event.stopPropagation();toggleFilhasEtapa('${et.id}')"
                   title="${filhasColapsadas ? 'Mostrar sub-etapas' : 'Ocultar sub-etapas'}">
            <i class="fas fa-${filhasColapsadas ? 'eye-slash' : 'eye'}"></i>
            <span>${temFilhas}</span>
          </button>
        `;
      }
      
      const linkProjetoHtml = `
        <div class="etapa-projeto-link" onclick="event.stopPropagation();navegarParaProjeto('${et.projetoId}')" title="Ir para Projeto: ${escaparHtml(nomeProjeto)}">
          <i class="fas fa-folder"></i>
          <span>${escaparHtml(nomeProjeto)}</span>
          <i class="fas fa-arrow-right indicador-nav-projeto"></i>
        </div>
      `;

      card.innerHTML = `
        <div class="etapa-header">
          <div class="etapa-header-left">
            ${btnExpandirPrincipal}
            <div class="etapa-nome" title="${escaparHtml(et.nome)}">${escaparHtml(et.nome)}</div>
          </div>
          <div class="etapa-badges">
            ${btnToggleFilhas}
            ${et.bloqueado ? '<i class="fas fa-lock etapa-badge-bloqueado"></i>' : ''}
            <span class="etapa-status-badge ${stNorm}">${escaparHtml(et.status)}</span>
          </div>
        </div>
        
        ${linkProjetoHtml}
            
        <div class="etapa-resumo">
          <div class="etapa-resumo-linha">
            <i class="fas fa-user-friends"></i>
            <span class="etapa-resumo-texto">
               ${responsaveisResumoHtml}
            </span>
          </div>
          ${et.descricao ? `
            <div class="etapa-resumo-linha">
              <i class="fas fa-align-left"></i>
              <span class="etapa-resumo-texto">${escaparHtml(et.descricao)}</span>
            </div>
          ` : ''}
        </div>
            
        <div class="etapa-corpo">
          ${et.descricao ? `
            <div class="etapa-campo">
              <div class="etapa-campo-label"><i class="fas fa-align-left"></i> Descrição</div>
              <div class="etapa-campo-valor">${escaparHtml(et.descricao)}</div>
            </div>
          ` : ''}
                
          <div class="etapa-campo">
            <div class="etapa-campo-label"><i class="fas fa-tasks"></i> O Que Fazer</div>
            <div class="etapa-campo-valor ${et.oQueFazer ? '' : 'etapa-campo-vazio'}">
              ${et.oQueFazer ? escaparHtml(et.oQueFazer) : 'Nenhuma tarefa definida'}
            </div>
          </div>
                
<div class="etapa-pendencias-bloco">
  ${renderizarPendenciasEtapaHtml(et.pendencias, et.id)}
</div>
                
        </div>
            
        <div class="etapa-acoes">
          ${podeCriarEtapaLocal(et.projetoId) ? `
            <button class="btn-etapa-acao sub-etapa" onclick="event.stopPropagation();abrirModalSubEtapa('${et.id}')" title="Adicionar Sub-etapa">
              <i class="fas fa-level-down-alt"></i>
              <span>Sub-etapa</span>
            </button>
          ` : ''}
          ${podeEditarEtapaLocal(et.id) ? `
            <button class="btn-etapa-acao editar" onclick="event.stopPropagation();editarEtapa('${et.id}')" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-etapa-acao lock ${et.bloqueado ? 'locked' : ''}" onclick="event.stopPropagation();alternarBloqueioEtapa('${et.id}')" title="${et.bloqueado ? 'Desbloquear' : 'Bloquear'}">
              <i class="fas fa-${et.bloqueado ? 'lock' : 'lock-open'}"></i>
            </button>
          ` : ''}
        </div>
            
        <div class="ponto-conexao topo" data-etapa="${et.id}" data-anchor="topo"></div>
        <div class="ponto-conexao baixo" data-etapa="${et.id}" data-anchor="baixo"></div>
        <div class="ponto-conexao esquerda" data-etapa="${et.id}" data-anchor="esquerda"></div>
        <div class="ponto-conexao direita" data-etapa="${et.id}" data-anchor="direita"></div>
      `;

      const pontos = card.querySelectorAll('.ponto-conexao');
      pontos.forEach(p => {
        p.addEventListener('mousedown', e => {
           if (!podeEditar()) return;
           e.stopPropagation();
           iniciarConexao(et.id, p.dataset.anchor, p);
        });
        p.addEventListener('mouseup', e => {
           if (estado.conectandoEtapa && estado.conectandoEtapa !== et.id) {
             e.stopPropagation();
             finalizarConexao(et.id);
           }
           if (estado.conectandoResponsavel) {
             e.stopPropagation();
             finalizarVinculoResponsavelEtapa(et.id);
           }
        });
      });
        
      cont.appendChild(card);
    }


/**
 * Gera o HTML das pendências para o card da etapa
 * @param {Array} pendencias - Array de pendências
 * @param {string} etapaId - ID da etapa
 * @returns {string} HTML das pendências
 */
function renderizarPendenciasEtapaHtml(pendencias, etapaId) {
  if (!Array.isArray(pendencias) || pendencias.length === 0) {
    return '';
  }
  
  // Função helper para verificar se está concluído (trata string e boolean)
  function estaConcluido(pend) {
    return pend.concluido === true || pend.concluido === 'true';
  }
  
  // Calcula pendentes usando a função helper
  const pendentes = pendencias.filter(function(p) { return !estaConcluido(p); });
  const urgentes = pendentes.filter(function(p) { return p.urgencia === 'alta'; }).length;
  
  // Ordena: não concluídos primeiro, depois por urgência
  var pendenciasOrdenadas = pendencias.slice().sort(function(a, b) {
    var aConcluido = estaConcluido(a);
    var bConcluido = estaConcluido(b);
    
    // Não concluídas primeiro
    if (aConcluido !== bConcluido) return aConcluido ? 1 : -1;
    
    // Depois por urgência
    var ordemUrgencia = { alta: 0, media: 1, baixa: 2 };
    var ordemA = ordemUrgencia[a.urgencia] !== undefined ? ordemUrgencia[a.urgencia] : 1;
    var ordemB = ordemUrgencia[b.urgencia] !== undefined ? ordemUrgencia[b.urgencia] : 1;
    return ordemA - ordemB;
  });
  
  // Mostrar apenas as primeiras 4 pendências
  var pendenciasVisiveis = pendenciasOrdenadas.slice(0, 4);
  var restantes = pendencias.length - 4;
  
  // Monta texto do badge
  var textoBadge = pendentes.length + ' pendente';
  if (pendentes.length !== 1) textoBadge += 's';
  if (urgentes > 0) {
    textoBadge += ' • ' + urgentes + ' urgente';
    if (urgentes !== 1) textoBadge += 's';
  }
  
  var html = '<div class="etapa-campo">' +
    '<div class="etapa-campo-label">' +
      '<i class="fas fa-exclamation-triangle"></i> ' +
      'Pendências ' +
      '<span class="badge-pendencias ' + (urgentes > 0 ? 'tem-urgentes' : 'sem-urgentes') + '">' +
        textoBadge +
      '</span>' +
    '</div>' +
    '<div class="etapa-pendencias-lista">';
  
  pendenciasVisiveis.forEach(function(pend) {
    var textoEscapado = escaparHtml(pend.texto || '');
    var concluido = estaConcluido(pend);
    var classConcluido = concluido ? 'concluido' : '';
    var checkado = concluido ? 'checked' : '';
    var urgencia = pend.urgencia || 'media';
    
    html += '<div class="etapa-pendencia-item ' + classConcluido + '" data-pendencia-id="' + pend.id + '">' +
        '<input ' +
          'type="checkbox" ' +
          'class="etapa-pendencia-checkbox" ' +
          checkado + ' ' +
          'onclick="alternarPendenciaCard(\'' + etapaId + '\', \'' + pend.id + '\', event)" ' +
          'title="' + (concluido ? 'Marcar como pendente' : 'Marcar como concluído') + '"' +
        '>' +
        '<span class="pendencia-item-urgencia ' + urgencia + '" title="Urgência: ' + urgencia + '"></span>' +
        '<span class="pendencia-item-texto" title="' + textoEscapado + '">' + textoEscapado + '</span>' +
      '</div>';
  });
  
  if (restantes > 0) {
    html += '<div class="etapa-pendencias-mais" onclick="editarEtapa(\'' + etapaId + '\')" title="Clique para ver todas">' +
        '<i class="fas fa-ellipsis-h"></i>' +
        '<span>+' + restantes + ' pendência' + (restantes !== 1 ? 's' : '') + '</span>' +
        '<i class="fas fa-external-link-alt" style="font-size: 0.6rem;"></i>' +
      '</div>';
  }
  
  html += '</div></div>';
  
  return html;
}
    
function renderizarEtapaComFilhas(et, x, y, nivel) {
  renderizarEtapa(et, x, y, nivel);
  const card = document.getElementById('etapa-' + et.id);
  const alturaCard = card ? card.offsetHeight : 60;
  const larguraCard = card ? card.offsetWidth : obterLarguraEtapaPorNivel(nivel);

  const prioridadeEtapa = obterMaiorPrioridadeEtapa(et.id);
  if (prioridadeEtapa) {
    const badgePrio = document.createElement('span');
    badgePrio.className = 'badge-prioridade-etapa';
    badgePrio.textContent = '#' + prioridadeEtapa;
    badgePrio.title = 'Prioridade #' + prioridadeEtapa;
    card.appendChild(badgePrio);
  }
      
  if (estado.etapasFilhasColapsadas.has(et.id)) return { altura: alturaCard, largura: larguraCard };

  const filhas = obterEtapasFilhas(et.id).filter(f => etapaPassaNosFiltros(f));
  if (filhas.length === 0) return { altura: alturaCard, largura: larguraCard };
  
  // ============================================================
  // CORREÇÃO: Aumentado GAP_Y de 20 para 50 e GAP_X de 25 para 40
  // ============================================================
  const GAP_Y = 50;  // CORRIGIDO: Era 20
  const GAP_X = 40;  // CORRIGIDO: Era 25
  const OFFSET_X_FILHA = CONFIG.OFFSET_ETAPA_FILHA_X;
  
  const yFilhas = y + alturaCard + GAP_Y;
  let xAtual = x + OFFSET_X_FILHA;
  let maiorAlturaSubarvore = 0;
  let larguraTotalFilhas = 0;

  filhas.forEach((filha, idx) => {
    const dimensoesFilha = renderizarEtapaComFilhas(filha, xAtual, yFilhas, nivel + 1);
    xAtual += dimensoesFilha.largura + GAP_X;
    larguraTotalFilhas += dimensoesFilha.largura;
    if (idx < filhas.length - 1) larguraTotalFilhas += GAP_X;
    maiorAlturaSubarvore = Math.max(maiorAlturaSubarvore, dimensoesFilha.altura);
  });

  const alturaTotal = alturaCard + GAP_Y + maiorAlturaSubarvore;
  const larguraTotal = Math.max(larguraCard, OFFSET_X_FILHA + larguraTotalFilhas);
  return { altura: alturaTotal, largura: larguraTotal };
}

function renderizarPainelResponsaveisFixo() {
  const container = document.getElementById('painelRespConteudo');
  if (!container) return;
  
  if (!dadosDiagrama || !dadosDiagrama.responsaveis || dadosDiagrama.responsaveis.length === 0) {
    container.innerHTML = '<p class="painel-vazio">Nenhum responsável cadastrado</p>';
    return;
  }
  
  let html = '';
  
  dadosDiagrama.responsaveis.forEach(resp => {
    if (!resp || !resp.id) return;
    
    // Calcular envolvimentos
    const setoresGerenciados = (dadosDiagrama.setoresResponsaveis || [])
      .filter(s => s && s.responsavelId === resp.id)
      .map(s => s.nomeSetor);
    
    const projetosEnvolvidos = (dadosDiagrama.projetos || []).filter(p => {
      if (!p) return false;
      if (p.responsaveisIds && Array.isArray(p.responsaveisIds)) {
        return p.responsaveisIds.includes(resp.id);
      }
      if (p.responsavelId) return p.responsavelId === resp.id;
      return false;
    });
    
    const etapasEnvolvidas = (dadosDiagrama.etapas || []).filter(e => {
      if (!e) return false;
      if (e.responsaveisIds && Array.isArray(e.responsaveisIds)) {
        return e.responsaveisIds.includes(resp.id);
      }
      if (e.responsavelId) return e.responsavelId === resp.id;
      return false;
    });
    
    // Calcular estatísticas
    const etapasPendentes = etapasEnvolvidas.filter(e => e.status !== 'Concluída').length;
    const etapasConcluidas = etapasEnvolvidas.filter(e => e.status === 'Concluída').length;
    const totalEtapas = etapasEnvolvidas.length;
    const percentualConclusao = totalEtapas > 0 ? Math.round((etapasConcluidas / totalEtapas) * 100) : 0;
    
    const iniciais = (resp.nome || 'N').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    
    // Obter prioridades deste responsável
    const prioridadesResp = dadosDiagrama.prioridadesPorResponsavel?.get(resp.id) || [];
    
    // Ordenar projetos por prioridade
    const projetosOrdenados = [...projetosEnvolvidos].sort((a, b) => {
      const prioA = prioridadesResp.find(p => p.tipoItem === 'projeto' && p.itemId === a.id)?.ordemPrioridade || 999;
      const prioB = prioridadesResp.find(p => p.tipoItem === 'projeto' && p.itemId === b.id)?.ordemPrioridade || 999;
      return prioA - prioB;
    });
    
    // Verificar se está expandido
    const estaExpandido = estado.colaboradorExpandido === resp.id;
    const classeSec = (estado.colaboradorExpandido && !estaExpandido) ? 'colapsado-secundario' : '';
    const iconExpandir = estaExpandido ? 'fa-chevron-up' : 'fa-chevron-down';
    
    // Definir cor do progresso
    let corProgresso = 'var(--status-a-fazer)';
    if (percentualConclusao === 100) corProgresso = 'var(--status-concluida)';
    else if (percentualConclusao >= 50) corProgresso = 'var(--status-em-andamento)';
    else if (percentualConclusao > 0) corProgresso = 'var(--cor-aviso)';
    
    // Verificar qual seção está visível para este responsável
    const secaoVisivel = estado.secaoColaboradorVisivel?.get(resp.id) || null;
    
    html += `
      <div class="resp-card-fixo ${estaExpandido ? 'expandido' : 'colapsado'} ${classeSec}" data-resp-id="${resp.id}">
        <!-- HEADER CLICÁVEL -->
        <div class="resp-fixo-header-clicavel" onclick="toggleColaboradorExpandido('${resp.id}')">
          <div class="resp-fixo-avatar">${iniciais}</div>
          <div class="resp-fixo-info">
            <div class="resp-fixo-nome">${escaparHtml(resp.nome)}</div>
            <div class="resp-fixo-cargo">${escaparHtml(resp.cargo) || 'Sem cargo'}</div>
          </div>
          <div class="resp-fixo-resumo-mini">
            ${(projetosEnvolvidos.length + etapasEnvolvidas.length) > 0 ? `
              <span class="resp-mini-badge" title="${projetosEnvolvidos.length} projetos, ${etapasEnvolvidas.length} etapas">
                <i class="fas fa-briefcase"></i> ${projetosEnvolvidos.length}
              </span>
              ${etapasPendentes > 0 ? `
                <span class="resp-mini-badge pendente" title="${etapasPendentes} etapas pendentes">
                  <i class="fas fa-clock"></i> ${etapasPendentes}
                </span>
              ` : ''}
            ` : '<span class="resp-mini-badge neutro">Sem atribuições</span>'}
          </div>
          <button class="btn-expandir-colaborador" title="${estaExpandido ? 'Recolher' : 'Expandir'}">
            <i class="fas ${iconExpandir}"></i>
          </button>
        </div>
        
        <!-- CONTEÚDO EXPANSÍVEL -->
        <div class="resp-fixo-conteudo-expansivel ${estaExpandido ? 'visivel' : ''}">
          
          <!-- BARRA DE PROGRESSO -->
          ${totalEtapas > 0 ? `
            <div class="resp-progresso-container">
              <div class="resp-progresso-info">
                <span class="resp-progresso-texto" style="color: ${corProgresso};">${percentualConclusao}% concluído</span>
                <span class="resp-progresso-detalhe">${etapasConcluidas}/${totalEtapas} etapas</span>
              </div>
              <div class="resp-progresso-barra">
                <div class="resp-progresso-preenchimento" style="width: ${percentualConclusao}%; background: ${corProgresso};"></div>
              </div>
            </div>
          ` : ''}
          
          <!-- ESTATÍSTICAS CLICÁVEIS (COMPACTO) -->
          <div class="resp-estatisticas-grid compacto">
            <div class="resp-stat-item clicavel ${secaoVisivel === 'setores' ? 'ativo' : ''}" 
                 onclick="event.stopPropagation(); toggleSecaoColaborador('${resp.id}', 'setores')"
                 title="Clique para ver setores gerenciados">
              <i class="fas fa-building" style="color: var(--cor-primaria);"></i>
              <span class="resp-stat-valor">${setoresGerenciados.length}</span>
              <span class="resp-stat-label">Setores</span>
              <i class="fas fa-chevron-down resp-stat-indicador"></i>
            </div>
            <div class="resp-stat-item clicavel ${secaoVisivel === 'projetos' ? 'ativo' : ''}" 
                 onclick="event.stopPropagation(); toggleSecaoColaborador('${resp.id}', 'projetos')"
                 title="Clique para ver projetos">
              <i class="fas fa-folder" style="color: var(--cor-info);"></i>
              <span class="resp-stat-valor">${projetosEnvolvidos.length}</span>
              <span class="resp-stat-label">Projetos</span>
              <i class="fas fa-chevron-down resp-stat-indicador"></i>
            </div>
            <div class="resp-stat-item clicavel ${secaoVisivel === 'etapas' ? 'ativo' : ''}" 
                 onclick="event.stopPropagation(); toggleSecaoColaborador('${resp.id}', 'etapas')"
                 title="Clique para ver etapas">
              <i class="fas fa-tasks" style="color: var(--status-em-andamento);"></i>
              <span class="resp-stat-valor">${etapasEnvolvidas.length}</span>
              <span class="resp-stat-label">Etapas</span>
              <i class="fas fa-chevron-down resp-stat-indicador"></i>
            </div>
          </div>
          
          <!-- SEÇÃO: SETORES GERENCIADOS (Colapsável) -->
          <div class="resp-secao-colapsavel ${secaoVisivel === 'setores' ? 'visivel' : ''}" data-secao="setores">
            ${setoresGerenciados.length > 0 ? `
              <div class="resp-envolvimento-grupo">
                <div class="resp-envolvimento-titulo">
                  <i class="fas fa-building"></i> Setores Gerenciados
                  <span class="resp-grupo-contador">${setoresGerenciados.length}</span>
                </div>
                <div class="resp-envolvimento-lista">
                  ${setoresGerenciados.map(s => `
                    <span class="resp-envolvimento-item setor-clicavel"
                           onclick="navegarParaSetor('${escaparHtml(s.replace(/'/g, "\\'"))}')"
                           title="Clique para ir ao setor">
                      <i class="fas fa-crown" style="color: #d97706; font-size: 0.65rem;"></i>
                      <span class="resp-item-nome">${escaparHtml(s)}</span>
                      <i class="fas fa-arrow-right resp-item-seta"></i>
                    </span>
                  `).join('')}
                </div>
              </div>
            ` : `
              <div class="resp-sem-envolvimento">
                <i class="fas fa-building"></i>
                <span>Não gerencia nenhum setor</span>
              </div>
            `}
          </div>
          
          <!-- SEÇÃO: PROJETOS (Colapsável) -->
          <div class="resp-secao-colapsavel ${secaoVisivel === 'projetos' ? 'visivel' : ''}" data-secao="projetos">
            ${projetosOrdenados.length > 0 ? `
              <div class="resp-envolvimento-grupo">
                <div class="resp-envolvimento-titulo">
                  <i class="fas fa-folder"></i> Projetos
                  <span class="resp-grupo-contador">${projetosOrdenados.length}</span>
                </div>
                <div class="resp-envolvimento-lista">
                  ${projetosOrdenados.map(p => {
                    const prio = prioridadesResp.find(pr => pr.tipoItem === 'projeto' && pr.itemId === p.id)?.ordemPrioridade;
                    const setorProjeto = p.setor || 'Sem setor';
                    const etapasProj = etapasEnvolvidas.filter(e => e.projetoId === p.id);
                    const pendentesProj = etapasProj.filter(e => e.status !== 'Concluída').length;
                    
                    return `
                      <div class="resp-projeto-item-completo" onclick="navegarParaProjeto('${p.id}')">
                        <div class="resp-projeto-linha-principal">
                          ${prio ? `<span class="mini-badge-prioridade ${prio <= 3 ? 'p' + prio : ''}">${prio}</span>` : ''}
                          <span class="resp-projeto-nome">${escaparHtml(p.nome)}</span>
                          <i class="fas fa-arrow-right resp-item-seta"></i>
                        </div>
                        <div class="resp-projeto-meta">
                          <span class="resp-projeto-setor">
                            <i class="fas fa-building"></i> ${escaparHtml(setorProjeto)}
                          </span>
                          ${pendentesProj > 0 ? `
                            <span class="resp-projeto-pendentes">
                              <i class="fas fa-clock"></i> ${pendentesProj} pendente${pendentesProj !== 1 ? 's' : ''}
                            </span>
                          ` : `
                            <span class="resp-projeto-ok">
                              <i class="fas fa-check"></i> Em dia
                            </span>
                          `}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : `
              <div class="resp-sem-envolvimento">
                <i class="fas fa-folder"></i>
                <span>Nenhum projeto atribuído</span>
              </div>
            `}
          </div>
          
          <!-- SEÇÃO: ETAPAS (Colapsável) -->
          <div class="resp-secao-colapsavel ${secaoVisivel === 'etapas' ? 'visivel' : ''}" data-secao="etapas">
            ${etapasEnvolvidas.length > 0 ? `
              <div class="resp-envolvimento-grupo">
                <div class="resp-envolvimento-titulo">
                  <i class="fas fa-tasks"></i> Etapas Atribuídas
                  <span class="resp-grupo-contador">${etapasEnvolvidas.length}</span>
                </div>
                <div class="resp-envolvimento-lista">
                  ${etapasEnvolvidas.map(e => {
                    const prio = prioridadesResp.find(pr => pr.tipoItem === 'etapa' && pr.itemId === e.id)?.ordemPrioridade;
                    const corStatus = obterCorPorStatusEtapa(e.status);
                    const projeto = dadosDiagrama.projetos.find(p => p.id === e.projetoId);
                    const nomeProjeto = projeto ? projeto.nome : 'Desconhecido';
                    
                    return `
                      <div class="resp-etapa-item-completo" onclick="navegarParaEtapa('${e.id}')" style="border-left-color: ${corStatus.cor};">
                        <div class="resp-etapa-linha-principal">
                          ${prio ? `<span class="mini-badge-prioridade ${prio <= 3 ? 'p' + prio : ''}">${prio}</span>` : ''}
                          <span class="resp-etapa-nome">${escaparHtml(e.nome)}</span>
                          <span class="resp-etapa-status-mini" style="background: ${corStatus.bgCor}; color: ${corStatus.cor};">
                            ${e.status}
                          </span>
                        </div>
                        <div class="resp-etapa-meta">
                          <span class="resp-etapa-projeto">
                            <i class="fas fa-folder"></i> ${escaparHtml(nomeProjeto)}
                          </span>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : `
              <div class="resp-sem-envolvimento">
                <i class="fas fa-tasks"></i>
                <span>Nenhuma etapa atribuída</span>
              </div>
            `}
          </div>
          
          <!-- BOTÕES DE AÇÃO -->
          <div class="resp-acoes-container">
            <button class="btn-resp-acao" onclick="event.stopPropagation(); abrirEditorPrioridades('${resp.id}')" title="Editar prioridades">
              <i class="fas fa-sort-amount-up"></i>
              <span>Prioridades</span>
            </button>
            <button class="btn-resp-acao" onclick="event.stopPropagation(); abrirModalEnvioEmail('${resp.id}')" title="Enviar por email" ${!resp.email ? 'disabled' : ''}>
              <i class="fas fa-envelope"></i>
              <span>Enviar</span>
            </button>
            <button class="btn-resp-acao" onclick="event.stopPropagation(); editarResponsavel('${resp.id}')" title="Editar colaborador">
              <i class="fas fa-user-edit"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html || '<p class="painel-vazio">Nenhum responsável cadastrado</p>';
}

/**
 * Alterna expansão do colaborador (acordeão exclusivo - apenas um por vez)
 * @param {string} respId - ID do responsável
 */
function toggleColaboradorExpandido(respId) {
  const cardAtual = document.querySelector(`.resp-card-fixo[data-resp-id="${respId}"]`);
  const todosCards = document.querySelectorAll('.resp-card-fixo');
  
  // Se clicou no que já está expandido, recolhe ele
  if (estado.colaboradorExpandido === respId) {
    estado.colaboradorExpandido = null;
    
    // Recolhe o card atual
    cardAtual.classList.remove('expandido');
    cardAtual.classList.add('colapsado');
    cardAtual.querySelector('.resp-fixo-conteudo-expansivel')?.classList.remove('visivel');
    
    const icone = cardAtual.querySelector('.resp-expandir-icone');
    if (icone) icone.style.transform = 'rotate(0deg)';
    
    // Remove classe secundária de todos
    todosCards.forEach(card => {
      card.classList.remove('colapsado-secundario');
    });
    
  } else {
    // Expande o novo e recolhe o anterior
    estado.colaboradorExpandido = respId;
    
    todosCards.forEach(card => {
      const cardId = card.dataset.respId;
      const conteudo = card.querySelector('.resp-fixo-conteudo-expansivel');
      const icone = card.querySelector('.resp-expandir-icone');
      
      if (cardId === respId) {
        // Expande este
        card.classList.remove('colapsado', 'colapsado-secundario');
        card.classList.add('expandido');
        conteudo?.classList.add('visivel');
        if (icone) icone.style.transform = 'rotate(180deg)';
        
        // Scroll suave para o card expandido
        setTimeout(() => {
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
      } else {
        // Recolhe e marca como secundário
        card.classList.remove('expandido');
        card.classList.add('colapsado', 'colapsado-secundario');
        conteudo?.classList.remove('visivel');
        if (icone) icone.style.transform = 'rotate(0deg)';
      }
    });
  }
}

/**
 * Alterna a visibilidade de uma seção específica do colaborador (Setores/Projetos/Etapas)
 * @param {string} respId - ID do responsável
 * @param {string} secao - Nome da seção: 'setores', 'projetos' ou 'etapas'
 */
function toggleSecaoColaborador(respId, secao) {
  // Inicializa o Map se não existir
  if (!estado.secaoColaboradorVisivel) {
    estado.secaoColaboradorVisivel = new Map();
  }
  
  const secaoAtual = estado.secaoColaboradorVisivel.get(respId);
  
  // Se clicar na mesma seção, fecha. Se clicar em outra, troca.
  if (secaoAtual === secao) {
    estado.secaoColaboradorVisivel.set(respId, null);
  } else {
    estado.secaoColaboradorVisivel.set(respId, secao);
  }
  
  // Atualiza visualmente sem re-renderizar tudo (mais performático)
  const card = document.querySelector(`.resp-card-fixo[data-resp-id="${respId}"]`);
  if (!card) return;
  
  // Atualiza classes dos stats
  const stats = card.querySelectorAll('.resp-stat-item.clicavel');
  stats.forEach(stat => {
    const secaoDoStat = stat.textContent.toLowerCase().includes('setor') ? 'setores' 
                       : stat.textContent.toLowerCase().includes('projeto') ? 'projetos' 
                       : 'etapas';
    
    if (estado.secaoColaboradorVisivel.get(respId) === secaoDoStat) {
      stat.classList.add('ativo');
    } else {
      stat.classList.remove('ativo');
    }
  });
  
  // Atualiza visibilidade das seções
  const secoes = card.querySelectorAll('.resp-secao-colapsavel');
  secoes.forEach(secaoEl => {
    const nomeSec = secaoEl.dataset.secao;
    if (estado.secaoColaboradorVisivel.get(respId) === nomeSec) {
      secaoEl.classList.add('visivel');
    } else {
      secaoEl.classList.remove('visivel');
    }
  });
}

/**
 * Expande todos os colaboradores no painel
 */
function expandirTodosColaboradores() {
  dadosDiagrama.responsaveis.forEach(r => {
    if (r && r.id) estado.colaboradorExpandido .add(r.id);
  });
  renderizarPainelResponsaveisFixo();
}

/**
 * Recolhe todos os colaboradores no painel
 */
function recolherTodosColaboradores() {
  estado.colaboradorExpandido .clear();
  renderizarPainelResponsaveisFixo();
}

    // Toggle para o painel de responsáveis
    function togglePainelResponsaveis() {
       const painel = document.getElementById('painelResponsaveisFixo');
       if (painel) painel.classList.toggle('colapsado');
    }

    function toggleDetalhesSetor(nome) {
        if (estado.setoresDetalhesExpandidos.has(nome)) estado.setoresDetalhesExpandidos.delete(nome);
        else estado.setoresDetalhesExpandidos.add(nome);
        renderizarDiagrama();
    }

    function desenharLinhaTemp(e) {
       const svg = document.getElementById('svgConexoes');
       const idLinha = 'linha-temp';
       
       const rect = document.getElementById('areaDiagrama').getBoundingClientRect();
       const mouseX = (e.clientX - rect.left - estado.offsetX) / estado.zoom;
       const mouseY = (e.clientY - rect.top - estado.offsetY) / estado.zoom;
       const p1 = estado.pontoOrigem;
       const p2 = { x: mouseX, y: mouseY };
       
       const d = obterCaminhoOrtogonal(p1, p2, 'horizontal');
       
       upsertLinha(idLinha, d, 'linha-dependencia', {
           'style': 'stroke-dasharray: 5,5'
       });
    }
    
    function desenharLinhaTempResponsavel(e) {
       const idLinha = 'linha-temp-resp';
       const rect = document.getElementById('areaDiagrama').getBoundingClientRect();
       const mouseX = (e.clientX - rect.left - estado.offsetX) / estado.zoom;
       const mouseY = (e.clientY - rect.top - estado.offsetY) / estado.zoom;
       const p1 = estado.pontoRespOrigem;
       const p2 = { x: mouseX, y: mouseY };
       
       const d = obterCaminhoOrtogonal(p1, p2, 'horizontal');
       
       upsertLinha(idLinha, d, 'linha-vinculo', {
           'style': 'stroke-dasharray: 4,4; stroke: var(--cor-primaria)'
       });
    }

    function obterPosAnchor(el, anchor) {
      const left = parseFloat(el.style.left);
      const top = parseFloat(el.style.top);
      const w = el.offsetWidth;
      const h = el.offsetHeight;
      switch(anchor) {
         case 'topo': return { x: left + w/2, y: top };
         case 'baixo': return { x: left + w/2, y: top + h };
         case 'esquerda': return { x: left, y: top + h/2 };
         case 'direita': return { x: left + w, y: top + h/2 };
         default: return { x: left + w/2, y: top + h/2 };
      }
    }

    function normalizarStatus(status) {
        if (!status) return 'a-fazer';
        return status.toLowerCase().replace(/ /g, '-').replace(/á/g, 'a').replace(/í/g, 'i');
    }

    function etapaPassaNosFiltros(etapa) {
       if (!estado.filtroStatus.has(etapa.status)) return false;
       return true;
    }

    function obterEtapasRaiz(projetoId) {
        return dadosDiagrama.etapas.filter(e => e.projetoId === projetoId && !e.etapaPaiId);
    }
    
    function obterEtapasFilhas(etapaId) {
        return dadosDiagrama.etapas.filter(e => e.etapaPaiId === etapaId);
    }

    function montarArvoreEtapas(projetoId, paiId = null, nivel = 0) {
      const etapasDoNivel = dadosDiagrama.etapas
        .filter(e => {
          if (e.projetoId !== projetoId) return false;
          const ehRaiz = paiId === null && (!e.etapaPaiId || e.etapaPaiId === '');
          const ehFilha = paiId !== null && e.etapaPaiId === paiId;
          if (!ehRaiz && !ehFilha) return false;
          return etapaPassaNosFiltros(e);
        })
        .map(e => ({
          ...e,
          nivel,
          filhas: montarArvoreEtapas(projetoId, e.id, nivel + 1)
        }));
      return etapasDoNivel;
    }

    function renderizarListaEtapasProjeto(arvore) {
      return arvore.map(e => `
        <div 
          class="projeto-etapa-item nivel-${e.nivel}"
          onclick="navegarParaEtapa('${e.id}')"
          title="Ir para a etapa"
          onmousedown="event.stopPropagation()"
        >
          <i class="fas fa-tasks"></i>
          <span>${escaparHtml(e.nome)}</span>
        </div>
        ${e.filhas.length ? renderizarListaEtapasProjeto(e.filhas) : ''}
      `).join('');
    }

    // MODIFICADO: Aumentando largura das etapas
    function obterLarguraEtapaPorNivel(nivel) {
        if (nivel === 0) return 280;
        if (nivel === 1) return 260;
        if (nivel === 2) return 240;
        return 220;
    }

    function renderizarDashboardSetores() {
       const container = document.getElementById('dashboardSetores');
       if (!container) return;
       
       const setoresUnicos = [...new Set(dadosDiagrama.projetos.map(p => p.setor).filter(s => s))].sort();
       
       if (setoresUnicos.length === 0) {
          container.innerHTML = '<p class="dashboard-vazio">Nenhum setor cadastrado</p>';
          return;
       }
       
       let html = '';
       
       setoresUnicos.forEach(nomeSetor => {
          const projetosDoSetor = dadosDiagrama.projetos.filter(p => p.setor === nomeSetor);
          const totalProjetos = projetosDoSetor.length;
          
          let totalEtapas = 0;
          let etapasConcluidas = 0;
          
          projetosDoSetor.forEach(proj => {
             const etapasProj = dadosDiagrama.etapas.filter(e => e.projetoId === proj.id);
             totalEtapas += etapasProj.length;
             etapasConcluidas += etapasProj.filter(e => e.status === STATUS_ETAPAS.CONCLUIDA).length;
          });
          
          const percentualConclusao = totalEtapas > 0 
             ? Math.round((etapasConcluidas / totalEtapas) * 100) 
             : 0;
             
          let corProgresso = 'var(--status-a-fazer)';
          if (percentualConclusao === 100) corProgresso = 'var(--status-concluida)';
          else if (percentualConclusao >= 50) corProgresso = 'var(--status-em-andamento)';
          else if (percentualConclusao > 0) corProgresso = 'var(--cor-aviso)';
          
          html += `
             <div class="dashboard-setor-card" onclick="navegarParaSetor('${escaparHtml(nomeSetor.replace(/'/g, "\\'"))}')">
                <div class="dashboard-setor-header">
                   <i class="fas fa-building"></i>
                   <span class="dashboard-setor-nome">${escaparHtml(nomeSetor)}</span>
                </div>
                <div class="dashboard-setor-stats">
                   <div class="dashboard-stat">
                      <span class="dashboard-stat-valor">${totalProjetos}</span>
                      <span class="dashboard-stat-label">Projetos</span>
                   </div>
                   <div class="dashboard-stat">
                      <span class="dashboard-stat-valor">${totalEtapas}</span>
                      <span class="dashboard-stat-label">Etapas</span>
                   </div>
                   <div class="dashboard-stat destaque" style="color: ${corProgresso};">
                      <span class="dashboard-stat-valor">${percentualConclusao}%</span>
                      <span class="dashboard-stat-label">Concluído</span>
                   </div>
                </div>
                <div class="dashboard-setor-barra">
                   <div class="dashboard-setor-progresso" style="width: ${percentualConclusao}%; background: ${corProgresso};"></div>
                </div>
             </div>
          `;
       });
       
       container.innerHTML = html;
    }


/**
 * Expande/colapsa etapas de um projeto no modal de prioridades
 */
function toggleEtapasProjeto(projetoId) {
  const containerEtapas = document.getElementById(`etapas-${projetoId}`);
  const btn = event.target.closest('.btn-expandir-etapas');
  
  if (containerEtapas && btn) {
    const estaExpandido = containerEtapas.style.display !== 'none';
    containerEtapas.style.display = estaExpandido ? 'none' : 'block';
    btn.querySelector('i').className = estaExpandido ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
  }
}

/**
 * Inicializa o sistema de drag and drop para ordenação de prioridades
 */
function inicializarDragAndDropPrioridades() {
  const itens = document.querySelectorAll('.item-prioridade, .subitem-etapa');
  
  itens.forEach(item => {
    item.addEventListener('dragstart', function(e) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.classList.add('arrastando-prioridade');
    });
    
    item.addEventListener('dragend', function() {
      this.classList.remove('arrastando-prioridade');
    });
    
    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const itemArrastando = document.querySelector('.arrastando-prioridade');
      if (itemArrastando && itemArrastando !== this) {
        const rect = this.getBoundingClientRect();
        const meio = rect.top + rect.height / 2;
        
        if (e.clientY < meio) {
          this.parentNode.insertBefore(itemArrastando, this);
        } else {
          this.parentNode.insertBefore(itemArrastando, this.nextSibling);
        }
      }
    });
  });
  
  // Atualizar números de prioridade após cada mudança
  atualizarNumerosPrioridade();
}

/**
 * Atualiza os números de prioridade visuais após reordenação
 */
function atualizarNumerosPrioridade() {
  const container = document.getElementById('listaPrioridadesProjetos');
  if (!container) return;
  
  // Atualizar números dos projetos
  let contadorProjetos = 1;
  const itensProjeto = container.querySelectorAll('.item-prioridade[data-tipo="projeto"]');
  
  itensProjeto.forEach(item => {
    const numElement = item.querySelector('.item-prioridade-numero');
    if (numElement) {
      numElement.textContent = contadorProjetos;
      contadorProjetos++;
    }
  });
  
  // Atualizar números das etapas por projeto
  const containersEtapas = container.querySelectorAll('.etapas-prioridade-container');
  
  containersEtapas.forEach(containerEtapas => {
    let contadorEtapas = 1;
    const etapas = containerEtapas.querySelectorAll('.item-etapa-prioridade');
    
    etapas.forEach(etapa => {
      const numEtapa = etapa.querySelector('.item-etapa-numero');
      if (numEtapa) {
        numEtapa.textContent = contadorEtapas;
        contadorEtapas++;
      }
    });
  });
}

</script>