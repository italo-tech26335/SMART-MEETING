<script>
/* =====================================================================
 *  SMART MEETING - JS COMPLETO (PaginaProjetoDetalhe-JS)
 *  Tema: Vintage Creme | Apps Script + Google Sheets
 *  Corre√ß√µes: modal editar, filtros, busca, drag&drop, status Aguardando,
 *  mem√≥ria projeto, spinner inline, renomear Etapa‚ÜíAtividade, etc.
 * ===================================================================== */

// ========================= DADOS PRINCIPAIS =========================
// Abas da planilha (refer√™ncia ‚Äî o backend j√° sabe os nomes)
const ABAS = {
  projetos:      'Projetos',
  etapas:        'Etapas',
  responsaveis:  'Responsaveis',
  setores:       'Setores',
  prioridades:   'Prioridades'
};

// Status dispon√≠veis no sistema (inclui "Aguardando Setor")
const LISTA_STATUS = ['A Fazer', 'Em Andamento', 'Aguardando Setor', 'Conclu√≠da'];

// Mapa status ‚Üí classe CSS
const MAPA_CLASSE_STATUS = {
  'A Fazer':          'afazer',
  'Em Andamento':     'andamento',
  'Aguardando Setor': 'aguardando',
  'Conclu√≠da':        'concluida'
};

// Mapa status ‚Üí √≠cone FontAwesome
const MAPA_ICONE_STATUS = {
  'A Fazer':          'clipboard-list',
  'Em Andamento':     'spinner',
  'Aguardando Setor': 'hourglass-half',
  'Conclu√≠da':        'check-circle'
};

// Cores do gr√°fico por status
const CORES_STATUS = {
  'A Fazer':          { cor: '#b8860b', bg: '#fef3c7' },
  'Em Andamento':     { cor: '#4a6fa5', bg: '#dbeafe' },
  'Aguardando Setor': { cor: '#c2855a', bg: '#fde8d8' },
  'Conclu√≠da':        { cor: '#5a7247', bg: '#d1fae5' }
};

// Pesos GUT ‚Äî Tipo de Projeto (Corre√ß√£o=5, Nova Impl=4, Melhoria=3)
const PESOS_TIPO = { 'Corre√ß√£o': 5, 'Nova Implementa√ß√£o': 4, 'Melhoria': 3 };

// Escala de prioridade GUT
const ESCALA_PRIORIDADE = { alta: 2102, media: 1078 };

// ========================= ESTADO GLOBAL =========================
let ESTADO = {
  projeto: null,
  listaProjetos: [],
  etapas: [],
  responsaveis: [],
  setores: [],
  historicoChat: [],
  pessoasParaQuem: {},
  configCalculoPrioridade: null,
  prioridadesProjetos: [],
  responsaveisEmail: [],
  emailsCcSelecionados: [],

  chatVisivel: false,
  abaSidebarAtiva: 'assistente',
  carregando: false,
  textoBusca: '',

  // ‚òÖ FILTROS ‚Äî tipoProjeto adicionado ‚òÖ
  filtrosGlobais: {
    responsavelId: 'TODOS',
    statusSelecionado: null,
    setorSelecionado: null,
    tipoProjeto: null          // ‚Üê NOVO
  },
  modoFocoAberto: false,
  graficoStatusAtivos: ['A Fazer', 'Em Andamento', 'Aguardando Setor', 'Conclu√≠da'],
  cardsExpandidos: {},
  detalhesExpandidos: {},
  ordemProjetosModificada: false,
  ordemAtividadesModificada: false,
  calculoAtual: {
    projetoId: null,
    gravidade: 0, gravidadeLabel: '',
    urgencia: 0, urgenciaLabel: '',
    quemSolicita: 0, quemSolicitaLabel: '',
    tipoProjeto: 0, tipoProjetoLabel: '',
    esforco: 0, esforcoLabel: ''
  },
  novoProjetoCalculo: {
    tipoProjeto: 0, tipoProjetoLabel: '',
    paraQuem: 0, paraQuemLabel: '',
    gravidade: 0, gravidadeLabel: '',
    urgencia: 0, urgenciaLabel: '',
    esforco: 0, esforcoLabel: ''
  },
  filtroStatusAtividades: 'todos',
  statusAnteriorAtividades: {},

  textoBuscaAtividades: '',
ordenacaoAtividades: 'manual',
todasAtividadesExpandidas: false,

  graficoDonut: null,
  graficoSetor: null,         // mantido por compatibilidade

  filtroSetor: null,
  projetoExpandidoDiagrama: false,

  graficos: {}                // ‚Üê inst√¢ncias Chart.js: setor, tipo, responsaveisChart
};

// Vari√°veis de grava√ß√£o de √°udio
let mediaRecorder;
let audioChunks = [];

// ========================= INICIALIZA√á√ÉO =========================
document.addEventListener('DOMContentLoaded', function() {
  atualizarStatusCarregamento('Conectando ao servidor...');
  setTimeout(function() { atualizarStatusCarregamento('Carregando dados...'); }, 500);
  inicializarLayoutPagina();
  carregarTudo();
});

/** Configura o layout inicial (chat oculto) */
function inicializarLayoutPagina() {
  var mainLayout = document.getElementById('mainLayout');
  var btnToggle = document.getElementById('btnToggleChat');
  if (!ESTADO.chatVisivel) {
    mainLayout.classList.add('chat-oculto');
    if (btnToggle) btnToggle.classList.remove('ativo');
  }
}

/** Carrega todos os dados do servidor */
function carregarTudo() {
  atualizarStatusCarregamento('Carregando dados do projeto...');

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(dados) {
        esconderTelaCarregamento();
        if (!dados.sucesso) {
          mostrarToast(dados.mensagem, 'erro');
          return;
        }
        preencherEstado(dados);
        renderizarTudo();
      })
      .withFailureHandler(function(erro) {
        esconderTelaCarregamento();
        mostrarToast('Erro: ' + erro, 'erro');
      })
      .carregarDadosEditorProjeto();
  } else {
    setTimeout(function() {
      esconderTelaCarregamento();
      carregarDadosDemo();
      renderizarTudo();
    }, 1500);
  }
}

/** Preenche o ESTADO com dados recebidos do servidor */
function preencherEstado(dados) {
  ESTADO.setores = dados.setores || [];
  ESTADO.responsaveis = dados.responsaveis || [];
  ESTADO.listaProjetos = dados.listaProjetos || [];
  ESTADO.etapas = dados.etapas || [];
  ESTADO.projeto = dados.projeto || null;
  ESTADO.prioridadesProjetos = dados.prioridadesProjetos || [];
  ESTADO.pessoasParaQuem = dados.pessoasParaQuem || {};
  ESTADO.configCalculoPrioridade = dados.configCalculoPrioridade || null;

  // ‚Üê NOVO: aplicar tema vindo do servidor
  if (dados.tema === 'azul') {
    _injetarCssAzul();
    _atualizarBotaoTema(true);
  } else {
    _removerCssAzul();
    _atualizarBotaoTema(false);
  }
}

/** Recarrega dados do servidor SEM tela de carregamento (usa spinner inline) */
function recarregarDadosSemTela() {
  if (typeof google === 'undefined' || !google.script) return;

  google.script.run
    .withSuccessHandler(function(dados) {
      if (!dados.sucesso) return;
      var projetoSelecionadoId = ESTADO.projeto ? ESTADO.projeto.id : null;
      preencherEstado(dados);

      // Restaurar projeto selecionado
      if (projetoSelecionadoId) {
        ESTADO.projeto = ESTADO.listaProjetos.find(function(p) { return p.id === projetoSelecionadoId; }) || null;
      }
      renderizarTudo();

      // Recarregar atividades se h√° projeto selecionado
      if (ESTADO.projeto) {
        carregarAtividadesDoProjeto(ESTADO.projeto.id);
      }
    })
    .withFailureHandler(function() { /* silencioso */ })
    .carregarDadosEditorProjeto();
}

/** Renderiza toda a interface */
function renderizarTudo() {
  popularSelectsModais();
  renderizarFiltroHeader();
  renderizarDashboard();
  renderizarProjetosCards();
  renderizarDiagrama();
  atualizarContadorProjetos();
  configurarBuscaHeader();
  configurarNavegacao();
}

// ========================= TELA DE CARREGAMENTO =========================
function atualizarStatusCarregamento(texto) {
  var el = document.getElementById('loadingStatus');
  if (el) el.textContent = texto;
}

function esconderTelaCarregamento() {
  var el = document.getElementById('loadingScreen');
  if (el) el.classList.add('hidden');
}

function mostrarTelaCarregamento(texto) {
  var el = document.getElementById('loadingScreen');
  if (el) {
    atualizarStatusCarregamento(texto || 'Processando...');
    el.classList.remove('hidden');
  }
}

// ========================= SPINNER INLINE =========================
/** Mostra spinner dentro de um elemento (sem tela de carregamento global) */
function mostrarSpinner(elemento) {
  if (!elemento) return;
  var overlay = document.createElement('div');
  overlay.className = 'spinner-overlay';
  overlay.innerHTML = '<div class="spinner-inline"></div>';
  elemento.style.position = 'relative';
  elemento.appendChild(overlay);
}

/** Remove spinner de um elemento */
function esconderSpinner(elemento) {
  if (!elemento) return;
  var overlay = elemento.querySelector('.spinner-overlay');
  if (overlay) overlay.remove();
}

// ========================= TOAST =========================
function mostrarToast(mensagem, tipo) {
  var icones = {
    sucesso: '<i class="fas fa-check-circle"></i>',
    erro:    '<i class="fas fa-exclamation-circle"></i>',
    aviso:   '<i class="fas fa-info-circle"></i>'
  };
  var toast = document.createElement('div');
  toast.className = 'toast ' + (tipo || 'aviso');
  toast.innerHTML = (icones[tipo] || '') + ' ' + mensagem;
  document.body.appendChild(toast);
  setTimeout(function() {
    toast.style.animation = 'slideInToast 0.3s reverse';
    setTimeout(function() { toast.remove(); }, 300);
  }, 3000);
}

// ========================= UTILIT√ÅRIOS =========================
/** Retorna a classe CSS correspondente ao status */
function obterClasseStatus(status) {
  return MAPA_CLASSE_STATUS[status] || 'afazer';
}

/** Retorna o √≠cone FA correspondente ao status */
function obterIconeStatus(status) {
  return MAPA_ICONE_STATUS[status] || 'circle';
}

/** Retorna a categoria de prioridade: 'alta', 'media', 'baixa' ou 'nenhuma' */
function obterCategoriaPrioridade(valor) {
  if (!valor || valor === 0) return 'nenhuma';
  if (valor >= ESCALA_PRIORIDADE.alta) return 'alta';
  if (valor >= ESCALA_PRIORIDADE.media) return 'media';
  return 'baixa';
}

/** Retorna classe CSS do tipo de projeto */
function obterClasseTipo(tipo) {
  var mapa = { 'Melhoria': 'melhoria', 'Corre√ß√£o': 'correcao', 'Nova Implementa√ß√£o': 'nova-implementacao' };
  return mapa[tipo] || '';
}

/** Retorna nomes dos respons√°veis a partir de IDs */
function obterNomesResponsaveis(ids) {
  if (!ids || !Array.isArray(ids) || ids.length === 0) return [];
  return ids.map(function(id) {
    var resp = ESTADO.responsaveis.find(function(r) { return r.id === id; });
    return resp ? { id: resp.id, nome: resp.nome } : null;
  }).filter(function(r) { return r !== null; });
}

/** Retorna nome do primeiro respons√°vel (para card minimizado) */
function obterPrimeiroResponsavel(ids) {
  var nomes = obterNomesResponsaveis(ids);
  return nomes.length > 0 ? nomes[0].nome : 'Sem respons√°vel';
}

/** Renderiza chips de respons√°veis em HTML */
function renderizarChipsResponsaveisHTML(ids) {
  if (!ids || !Array.isArray(ids) || ids.length === 0) {
    return '<span class="resp-chip vazio"><i class="fas fa-user-slash"></i> Nenhum respons√°vel</span>';
  }
  return ids.map(function(id) {
    var resp = ESTADO.responsaveis.find(function(r) { return r.id === id; });
    if (!resp) return '';
    return '<span class="resp-chip"><i class="fas fa-user"></i> ' + resp.nome + '</span>';
  }).filter(function(h) { return h !== ''; }).join('');
}

/** Popula checkboxes de respons√°veis em um container */
function popularCheckboxesResponsaveis(containerId, selecionados) {
  var container = document.getElementById(containerId);
  if (!container) return;
  selecionados = selecionados || [];
  container.innerHTML = '';

  if (!ESTADO.responsaveis || ESTADO.responsaveis.length === 0) {
    container.innerHTML = '<p style="color:var(--cor-texto-secundario);text-align:center;padding:12px;">Nenhum respons√°vel cadastrado</p>';
    return;
  }

  ESTADO.responsaveis.forEach(function(resp) {
    var marcado = selecionados.includes(resp.id);
    var div = document.createElement('div');
    div.className = 'responsavel-checkbox-item';
    div.innerHTML =
      '<input type="checkbox" id="' + containerId + '_' + resp.id + '" value="' + resp.id + '" ' + (marcado ? 'checked' : '') + '>' +
      '<label for="' + containerId + '_' + resp.id + '">' + resp.nome + (resp.cargo ? ' - ' + resp.cargo : '') + '</label>';
    div.addEventListener('click', function(e) {
      if (e.target.tagName !== 'INPUT') {
        var cb = div.querySelector('input');
        cb.checked = !cb.checked;
      }
    });
    container.appendChild(div);
  });
}

/** Obt√©m IDs dos respons√°veis selecionados (checkboxes) */
function obterResponsaveisSelecionados(containerId) {
  var container = document.getElementById(containerId);
  if (!container) return [];
  var cbs = container.querySelectorAll('input[type="checkbox"]:checked');
  return Array.from(cbs).map(function(cb) { return cb.value; });
}

/** Calcula dura√ß√£o em dias entre duas datas ISO (yyyy-MM-dd) */
/** 
 * Retorna a dura√ß√£o formatada do projeto (vem pr√©-calculada do servidor).
 * Fallback: c√°lculo simples de dias corridos caso o dado n√£o exista.
 */
function calcularDuracaoDias(dataInicio, dataFim) {
  if (!dataInicio || !dataFim) return null;
  var inicio = new Date(dataInicio + 'T00:00:00');
  var fim    = new Date(dataFim   + 'T00:00:00');
  if (isNaN(inicio.getTime()) || isNaN(fim.getTime())) return null;
  var diff = Math.round((fim - inicio) / (1000 * 60 * 60 * 24));
  return diff >= 0 ? diff : null;
}

/**
 * Retorna o texto de dura√ß√£o formatado do projeto (dias √∫teis + horas).
 * Usa o campo pr√©-calculado pelo servidor.
 * @param {Object} projeto - Objeto do projeto com duracaoFormatada
 * @returns {string|null} Texto formatado ou null
 */
function obterDuracaoFormatada(projeto) {
  if (!projeto) return null;
  if (projeto.duracaoFormatada && projeto.duracaoFormatada.trim()) {
    return projeto.duracaoFormatada;
  }
  // Fallback: c√°lculo simples (dias corridos) se servidor n√£o enviou
  var dias = calcularDuracaoDias(projeto.dataInicio, projeto.dataFim);
  return dias !== null ? dias + ' dias (corridos)' : null;
}

/** Formata data ISO (yyyy-MM-dd) para exibi√ß√£o brasileira (dd/mm/yyyy) */
function formatarData(dataIso) {
  if (!dataIso) return '';
  var partes = dataIso.split('-');
  if (partes.length !== 3) return dataIso;
  return partes[2] + '/' + partes[1] + '/' + partes[0];
}

/** Badge de valor de prioridade */
function renderizarBadgeValorPrioridade(valor, categoria) {
  if (!valor || valor === 0) {
    return '<span class="badge-valor-prioridade nenhuma"><i class="fas fa-question-circle"></i> N√£o calculado</span>';
  }
  var icones = { alta: 'exclamation-circle', media: 'minus-circle', baixa: 'check-circle' };
  var labels = { alta: 'ALTA', media: 'M√âDIA', baixa: 'BAIXA' };
  return '<span class="badge-valor-prioridade ' + categoria + '">' +
    '<i class="fas fa-' + (icones[categoria] || 'circle') + '"></i> ' +
    valor + ' - ' + (labels[categoria] || 'N/A') + '</span>';
}

/** Abre modal no topo (scroll reset) */
function abrirModal(idModal) {
  var modal = document.getElementById(idModal);
  if (!modal) return;
  modal.classList.add('visible');
  // For√ßar scroll no topo do modal
  var conteudo = modal.querySelector('.modal-content');
  if (conteudo) conteudo.scrollTop = 0;
  var body = modal.querySelector('.modal-body');
  if (body) body.scrollTop = 0;
}

/** Fecha modal */
function fecharModal(idModal) {
  var modal = document.getElementById(idModal);
  if (modal) modal.classList.remove('visible');
}

/** Popula os selects dos modais (Setor, Para Quem, Gravidade, Urg√™ncia) */
function popularSelectsModais() {
  // Setor
  ['itemSetor', 'novoProjetoSetor'].forEach(function(selId) {
    var sel = document.getElementById(selId);
    if (!sel) return;
    sel.innerHTML = '<option value="">Selecione...</option>';
    ESTADO.setores.forEach(function(s) { sel.add(new Option(s.nome, s.nome)); });
  });

  popularSelectParaQuem();
  popularSelectGravidadeUrgencia();
  popularSelectEsforco();   // ‚Üê novo
}

function selecionarSelectPorLabel(selectEl, labelSalvo) {
  if (!selectEl || !labelSalvo) return;
  var labelNorm = String(labelSalvo).trim().toLowerCase();

  for (var i = 0; i < selectEl.options.length; i++) {
    var textoOpcao = selectEl.options[i].text.trim().toLowerCase();
    // Tenta correspond√™ncia exata primeiro, depois parcial (in√≠cio do texto)
    if (textoOpcao === labelNorm || textoOpcao.startsWith(labelNorm) || labelNorm.startsWith(textoOpcao.split(' - ')[0])) {
      selectEl.value = selectEl.options[i].value;
      return;
    }
  }
  // Fallback: manter vazio se nenhuma op√ß√£o bater
  selectEl.value = '';
}

/** Popula select "Para Quem" no modal de edi√ß√£o com valor num√©rico como value */
function popularSelectParaQuem() {
  var sel = document.getElementById('itemParaQuem');
  if (!sel) return;
  sel.innerHTML = '<option value="">Selecione...</option>';

  // Usar config se dispon√≠vel (mais completo), sen√£o usar pessoasParaQuem
  var config = ESTADO.configCalculoPrioridade;
  if (config && config.quemSolicita && config.quemSolicita.opcoes && config.quemSolicita.opcoes.length > 0) {
    config.quemSolicita.opcoes.forEach(function(op) {
      var opt = document.createElement('option');
      opt.value = op.valor;       // ‚Üê valor NUM√âRICO como value
      opt.textContent = op.label;
      opt.dataset.label = op.label;
      sel.appendChild(opt);
    });
    return;
  }


  // Fallback: pessoasParaQuem (mantido para compatibilidade)
  var pessoasOrdenadas = Object.entries(ESTADO.pessoasParaQuem)
    .sort(function(a, b) { return b[1].peso - a[1].peso; });

  pessoasOrdenadas.forEach(function(entry) {
    var nome = entry[0];
    var cfg  = entry[1];
    var opt  = document.createElement('option');
    opt.value = cfg.peso;         // ‚Üê valor NUM√âRICO como value
    opt.textContent = cfg.label + ' - ' + nome;
    opt.dataset.label = nome;
    sel.appendChild(opt);
  });
}

function obterCorPeso(valor, pesoMax) {
  var proporcao = pesoMax > 1 ? (valor - 1) / (pesoMax - 1) : 1;
  if (proporcao >= 0.8) return 'linear-gradient(135deg, #dc2626, #991b1b)'; // vermelho ‚Äî cr√≠tico
  if (proporcao >= 0.6) return 'linear-gradient(135deg, #c2410c, #9a3412)'; // laranja escuro
  if (proporcao >= 0.4) return 'linear-gradient(135deg, #b45309, #92400e)'; // √¢mbar
  if (proporcao >= 0.2) return 'linear-gradient(135deg, #4a6fa5, #3a5a8c)'; // azul
  return 'linear-gradient(135deg, #9ca3af, #6b7280)';                        // cinza ‚Äî baixo
}

/** Popula selects de Tipo, Gravidade, Urg√™ncia e Para Quem usando valor num√©rico como value */
function popularSelectGravidadeUrgencia() {
  var config = ESTADO.configCalculoPrioridade;
  if (!config) return;

  // Helper interno: popula um select com valor num√©rico
  function preencherSelect(idSelect, opcoes) {
    var sel = document.getElementById(idSelect);
    if (!sel || !opcoes) return;
    var valorAtual = sel.value; // preservar sele√ß√£o atual se j√° populado
    sel.innerHTML = '<option value="">Selecione...</option>';
    opcoes.forEach(function(op) {
      var opt = document.createElement('option');
      opt.value = op.valor;       // ‚Üê NUM√âRICO como value
      opt.textContent = op.label;
      opt.dataset.label = op.label;
      sel.appendChild(opt);
    });
    // Restaurar sele√ß√£o anterior (se ainda v√°lida)
    if (valorAtual) sel.value = valorAtual;
  }

  preencherSelect('itemTipoProjeto', config.tipoProjeto?.opcoes);
  preencherSelect('itemGravidade',   config.gravidade?.opcoes);
  preencherSelect('itemUrgenciaSelect', config.urgencia?.opcoes);
  // Para Quem √© tratado por popularSelectParaQuem() que tamb√©m foi corrigido
}

/** Popula o select de Esfor√ßo no modal de edi√ß√£o */
function popularSelectEsforco() {
  var sel = document.getElementById('itemEsforco');
  if (!sel) return;

  var config = ESTADO.configCalculoPrioridade;
  if (!config || !config.esforco || !config.esforco.opcoes) return;

  var valorAtual = sel.value;
  sel.innerHTML = '<option value="">Selecione...</option>';

  config.esforco.opcoes.forEach(function(op) {
    var opt = document.createElement('option');
    opt.value = op.valor;         // ‚Üê valor num√©rico
    opt.textContent = op.label;
    opt.dataset.label = op.label;
    sel.appendChild(opt);
  });

  if (valorAtual) sel.value = valorAtual;
}

/** Garante que uma option existe no select antes de setar o valor */
function garantirOptionExiste(selectEl, valor) {
  if (!selectEl || !valor) return;
  var valorStr = String(valor).trim();
  if (!valorStr) return;

  for (var i = 0; i < selectEl.options.length; i++) {
    if (selectEl.options[i].value === valorStr) return;
  }
  selectEl.add(new Option(valorStr, valorStr));
}

// ========================= FILTROS GLOBAIS (CROSS-FILTERING) =========================
/** Aplica um filtro e atualiza todos os componentes */
function aplicarFiltroGlobal(tipo, valor) {
  switch (tipo) {
    case 'responsavel':
      ESTADO.filtrosGlobais.responsavelId = valor || 'TODOS';
      break;
    case 'status':
      // Toggle: se j√° selecionado, desmarca
      ESTADO.filtrosGlobais.statusSelecionado =
        (ESTADO.filtrosGlobais.statusSelecionado === valor) ? null : valor;
      break;
    case 'projeto':
      if (valor) carregarEstruturaProjetoSelecionado(valor);
      return; // carregarEstrutura j√° vai re-renderizar o diagrama
  }
  atualizarTodosComponentes();
}

/** Limpa todos os filtros */
function limparFiltrosGlobais() {
  ESTADO.filtrosGlobais = {
    responsavelId:     'TODOS',
    statusSelecionado: null,
    setorSelecionado:  null,
    tipoProjeto:       null   // ‚Üê NOVO
  };
  ESTADO.filtroSetor = null;

  // Remove todos os avisos de filtro ativos
  ['avisoFiltroSetor', 'avisoFiltroTipo'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.remove();
  });

  atualizarTodosComponentes();
}

function obterProjetosFiltrados() {
  var projetos = ESTADO.listaProjetos.slice();
  var filtros = ESTADO.filtrosGlobais;

  // Filtro por respons√°vel
  if (filtros.responsavelId && filtros.responsavelId !== 'TODOS') {
    if (filtros.responsavelId === 'sem-responsavel') {
      projetos = projetos.filter(function(p) { return !p.responsaveisIds || p.responsaveisIds.length === 0; });
    } else {
      projetos = projetos.filter(function(p) {
        return p.responsaveisIds && p.responsaveisIds.includes(filtros.responsavelId);
      });
    }
  }

  // Filtro por status
  if (filtros.statusSelecionado) {
    projetos = projetos.filter(function(p) { return p.status === filtros.statusSelecionado; });
  }

  // Filtro por setor (vindo do gr√°fico de barras)
  if (filtros.setorSelecionado) {
    projetos = projetos.filter(function(p) {
      return (p.setor || 'Sem Setor') === filtros.setorSelecionado;
    });
  }

  // ‚òÖ NOVO ‚Äî Filtro por tipo de projeto ‚òÖ
  if (filtros.tipoProjeto) {
    projetos = projetos.filter(function(p) {
      return (p.tipo || 'Sem Tipo') === filtros.tipoProjeto;
    });
  }

  // Filtro por busca textual
  if (ESTADO.textoBusca) {
    var termo = ESTADO.textoBusca.toLowerCase();
    projetos = projetos.filter(function(p) {
      return p.nome.toLowerCase().includes(termo);
    });
  }

  return projetos;
}

/** Atualiza todos os componentes da p√°gina */
function atualizarTodosComponentes() {
  renderizarFiltroHeader();
  renderizarDashboard();
  renderizarProjetosCards();
  atualizarContadorProjetos();
  // N√ÉO chamar renderizarDiagrama() aqui ‚Äî o filtro de atividades √© independente
}

// ========================= BUSCA NO HEADER =========================
function configurarBuscaHeader() {
  // Criar campo de busca se n√£o existe no HTML
  var colunaProjetos = document.querySelector('.coluna-projetos .coluna-header');
  if (!colunaProjetos) return;

  // Verificar se j√° criou
  if (document.getElementById('campoBuscaProjetos')) return;

  var wrapper = document.createElement('div');
  wrapper.className = 'campo-busca-wrapper';
  wrapper.innerHTML =
    '<div class="campo-busca">' +
      '<i class="fas fa-search"></i>' +
      '<input type="text" id="campoBuscaProjetos" placeholder="Buscar projeto...">' +
    '</div>';

  // Inserir ap√≥s o header da coluna
  colunaProjetos.insertAdjacentElement('afterend', wrapper);

  document.getElementById('campoBuscaProjetos').addEventListener('input', function() {
    ESTADO.textoBusca = this.value.trim();
    renderizarProjetosCards();
    atualizarContadorProjetos();
  });
}

// ========================= FILTRO RESPONS√ÅVEL NO HEADER =========================
function renderizarFiltroHeader() {
  var container = document.getElementById('headerFiltroChips');
  if (!container) return;

  if (!ESTADO.responsaveis || ESTADO.responsaveis.length === 0) {
    container.innerHTML = '<span style="color:rgba(255,255,255,0.6);font-size:0.8rem;">Carregando...</span>';
    return;
  }

  var filtroAtivo = ESTADO.filtrosGlobais.responsavelId;

  // Contar projetos por respons√°vel
  var contagem = {};
  ESTADO.responsaveis.forEach(function(r) { contagem[r.id] = 0; });
  contagem['sem-responsavel'] = 0;

  ESTADO.listaProjetos.forEach(function(p) {
    var ids = p.responsaveisIds || [];
    if (ids.length === 0) {
      contagem['sem-responsavel']++;
    } else {
      ids.forEach(function(id) {
        if (contagem[id] !== undefined) contagem[id]++;
      });
    }
  });

  var html = '';

  // Chip "Todos"
  html += '<div class="header-chip ' + (filtroAtivo === 'TODOS' ? 'ativo' : '') + '" ' +
    'onclick="filtrarPorResponsavelHeader(\'TODOS\')">Todos <span class="qtd">' + ESTADO.listaProjetos.length + '</span></div>';

  // Chips de respons√°veis com projetos
  ESTADO.responsaveis.forEach(function(resp) {
    var qtd = contagem[resp.id] || 0;
    if (qtd > 0) {
      html += '<div class="header-chip ' + (filtroAtivo === resp.id ? 'ativo' : '') + '" ' +
        'onclick="filtrarPorResponsavelHeader(\'' + resp.id + '\')">' +
        resp.nome + ' <span class="qtd">' + qtd + '</span></div>';
    }
  });

  // Chip sem respons√°vel
  if (contagem['sem-responsavel'] > 0) {
    html += '<div class="header-chip ' + (filtroAtivo === 'sem-responsavel' ? 'ativo' : '') + '" ' +
      'onclick="filtrarPorResponsavelHeader(\'sem-responsavel\')">Sem Resp. <span class="qtd">' + contagem['sem-responsavel'] + '</span></div>';
  }

  // Bot√£o limpar filtros
  if (ESTADO.filtrosGlobais.statusSelecionado) {
    html += '<div class="header-chip" style="background:rgba(166,61,64,0.3);border-color:rgba(166,61,64,0.5);" onclick="limparFiltrosGlobais()">' +
      '<i class="fas fa-times"></i> Limpar</div>';
  }

  container.innerHTML = html;
}

function filtrarPorResponsavelHeader(responsavelId) {
  aplicarFiltroGlobal('responsavel', responsavelId);
}

// ========================= DASHBOARD =========================
function renderizarDashboard() {
  renderizarMetricas();
  renderizarFiltrosGrafico();
  renderizarGraficoDonut();
  renderizarLegendaGrafico();
  renderizarBarrasPrioridade();
  renderizarProjetosCriticos();
  renderizarGraficoSetor();
  renderizarGraficoTipoProjeto();    // ‚Üê NOVO
  renderizarGraficoResponsaveis();   // ‚Üê NOVO
  equalizarAlturasGraficos();
}

/** M√©tricas (cards num√©ricos) */
function renderizarMetricas() {
  var container = document.getElementById('dashboardMetricas');
  if (!container) return;

  var statusSel = ESTADO.filtrosGlobais.statusSelecionado;

  // ‚îÄ‚îÄ Para CONTAGENS: aplica todos os filtros EXCETO o de status ‚îÄ‚îÄ
  // Assim os cards mostram sempre os totais reais de cada categoria
  var projetosParaContar = ESTADO.listaProjetos.filter(function(p) {
    var filtros = ESTADO.filtrosGlobais;

    // Filtro respons√°vel
    if (filtros.responsavelId && filtros.responsavelId !== 'TODOS') {
      if (filtros.responsavelId === 'sem-responsavel') {
        if (p.responsaveisIds && p.responsaveisIds.length > 0) return false;
      } else {
        if (!p.responsaveisIds || !p.responsaveisIds.includes(filtros.responsavelId)) return false;
      }
    }
    // Filtro setor
    if (filtros.setorSelecionado && (p.setor || 'Sem Setor') !== filtros.setorSelecionado) return false;
    // Filtro tipo
    if (filtros.tipoProjeto && (p.tipo || 'Sem Tipo') !== filtros.tipoProjeto) return false;
    // Filtro busca textual
    if (ESTADO.textoBusca) {
      if (!p.nome.toLowerCase().includes(ESTADO.textoBusca.toLowerCase())) return false;
    }
    // ‚Üê N√ÉO aplica filtro de status aqui
    return true;
  });

  var total = projetosParaContar.length;

  // Contagem por status (sem filtro de status aplicado)
  var contagens = {};
  LISTA_STATUS.forEach(function(s) { contagens[s] = 0; });
  projetosParaContar.forEach(function(p) {
    if (contagens[p.status] !== undefined) contagens[p.status]++;
  });

  var html = '';

  // Card TOTAL ‚Äî selecionado quando nenhum status est√° filtrado
  html += '<div class="metrica-card total ' + (statusSel === null ? 'selecionado' : '') + '" ' +
    'onclick="aplicarFiltroGlobal(\'status\', null)">' +
    '<div class="metrica-card-content">' +
    '<div class="metrica-icone"><i class="fas fa-folder"></i></div>' +
    '<div class="metrica-info">' +
    '<div class="metrica-valor">' + total + '</div>' +
    '<div class="metrica-label">Total</div>' +
    '</div></div></div>';

  // Cards por status ‚Äî contagem sempre real, destaque apenas no selecionado
  LISTA_STATUS.forEach(function(status) {
    var classe = obterClasseStatus(status);
    var icone  = obterIconeStatus(status);
    var sel    = statusSel === status ? ' selecionado' : '';

    html += '<div class="metrica-card ' + classe + sel + '" ' +
      'onclick="aplicarFiltroGlobal(\'status\', \'' + status + '\')">' +
      '<div class="metrica-card-content">' +
      '<div class="metrica-icone"><i class="fas fa-' + icone + '"></i></div>' +
      '<div class="metrica-info">' +
      '<div class="metrica-valor">' + contagens[status] + '</div>' +
      '<div class="metrica-label">' + status + '</div>' +
      '</div></div></div>';
  });

  container.innerHTML = html;
}

/** Filtros de status para o gr√°fico donut */
function renderizarFiltrosGrafico() {
  var container = document.getElementById('graficoFiltrosStatus');
  if (!container) return;

  var projetos = obterProjetosFiltrados();
  var html = '';

  LISTA_STATUS.forEach(function(status) {
    var ativo = ESTADO.graficoStatusAtivos.includes(status);
    var count = projetos.filter(function(p) { return p.status === status; }).length;
    var classe = obterClasseStatus(status);

    html += '<div class="grafico-filtro-chip ' + classe + (ativo ? ' ativo' : '') + '" ' +
      'onclick="alternarStatusGrafico(\'' + status + '\')">' +
      '<i class="fas fa-' + (ativo ? 'check-circle' : 'circle') + '"></i> ' +
      status + ' (' + count + ')</div>';
  });

  container.innerHTML = html;
}

function alternarStatusGrafico(status) {
  var idx = ESTADO.graficoStatusAtivos.indexOf(status);
  if (idx > -1) {
    if (ESTADO.graficoStatusAtivos.length > 1) {
      ESTADO.graficoStatusAtivos.splice(idx, 1);
    } else {
      mostrarToast('Mantenha pelo menos um status', 'aviso');
      return;
    }
  } else {
    ESTADO.graficoStatusAtivos.push(status);
  }
  renderizarFiltrosGrafico();
  atualizarGraficoDonut();
  renderizarLegendaGrafico();
}

/** Gr√°fico Donut (Chart.js) */
function renderizarGraficoDonut() {
  var canvas = document.getElementById('graficoStatusProjetos');
  if (!canvas) return;

  if (ESTADO.graficoDonut) ESTADO.graficoDonut.destroy();

  var projetos = obterProjetosFiltrados();
  var dados = prepararDadosDonut(projetos);
  atualizarCentroGrafico(dados.total);

  ESTADO.graficoDonut = new Chart(canvas.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: dados.labels,
      datasets: [{ data: dados.valores, backgroundColor: dados.cores, borderColor: '#fffdf8', borderWidth: 3, hoverOffset: 8 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(61,43,31,0.9)', titleFont: { size: 13 }, bodyFont: { size: 12 },
          padding: 10, cornerRadius: 6,
          callbacks: {
            label: function(ctx) {
              var t = ctx.dataset.data.reduce(function(a, b) { return a + b; }, 0);
              var perc = t > 0 ? Math.round((ctx.raw / t) * 100) : 0;
              return ' ' + ctx.raw + ' projeto(s) (' + perc + '%)';
            }
          }
        }
      },
      animation: { duration: 600, easing: 'easeOutQuart' },
      onClick: function(evt, elements) {
        if (elements.length > 0) {
          var status = dados.labels[elements[0].index];
          aplicarFiltroGlobal('status', status);
        }
      }
    }
  });
}

function prepararDadosDonut(projetos) {
  var labels = [], valores = [], cores = [], total = 0;
  ESTADO.graficoStatusAtivos.forEach(function(status) {
    var count = projetos.filter(function(p) { return p.status === status; }).length;
    labels.push(status);
    valores.push(count);
    cores.push(CORES_STATUS[status]?.cor || '#9ca3af');
    total += count;
  });
  return { labels: labels, valores: valores, cores: cores, total: total };
}

function atualizarGraficoDonut() {
  if (!ESTADO.graficoDonut) return;
  var projetos = obterProjetosFiltrados();
  var dados = prepararDadosDonut(projetos);
  ESTADO.graficoDonut.data.labels = dados.labels;
  ESTADO.graficoDonut.data.datasets[0].data = dados.valores;
  ESTADO.graficoDonut.data.datasets[0].backgroundColor = dados.cores;
  ESTADO.graficoDonut.update('active');
  atualizarCentroGrafico(dados.total);
}

function atualizarCentroGrafico(total) {
  var valorEl = document.getElementById('graficoCentroValor');
  var labelEl = document.getElementById('graficoCentroLabel');
  if (valorEl) valorEl.textContent = total;
  if (labelEl) labelEl.textContent = total === 1 ? 'Projeto' : 'Projetos';
}

function renderizarLegendaGrafico() {
  var container = document.getElementById('graficoLegenda');
  if (!container) return;

  var projetos = obterProjetosFiltrados();
  var html = '';

  LISTA_STATUS.forEach(function(status) {
    var count = projetos.filter(function(p) { return p.status === status; }).length;
    var ativo = ESTADO.graficoStatusAtivos.includes(status);
    var corObj = CORES_STATUS[status];

    html += '<div class="legenda-item ' + (!ativo ? 'inativo' : '') + '" onclick="alternarStatusGrafico(\'' + status + '\')">' +
      '<span class="legenda-cor" style="background:' + (corObj?.cor || '#9ca3af') + ';"></span>' +
      '<span>' + status + '</span><span class="legenda-valor">' + count + '</span></div>';
  });

  container.innerHTML = html;
}

/** Lista de projetos no dashboard (respeita TODOS os filtros) */
function renderizarListaProjetosStatus() {
  var container = document.getElementById('listaProjetosStatus');
  var tituloEl = document.getElementById('listaTituloStatus');
  var contadorEl = document.getElementById('listaContador');
  if (!container) return;

  var projetos = obterProjetosFiltrados();
  var statusFiltro = ESTADO.filtrosGlobais.statusSelecionado;

  if (tituloEl) tituloEl.textContent = statusFiltro || 'Todos os Projetos';
  if (contadorEl) contadorEl.textContent = projetos.length;

  if (projetos.length === 0) {
    container.innerHTML = '<div class="lista-vazia"><i class="fas fa-inbox"></i><p>Nenhum projeto encontrado</p></div>';
    return;
  }

  projetos.sort(function(a, b) { return (b.valorPrioridade || 0) - (a.valorPrioridade || 0); });

  var projetoSelId = ESTADO.projeto ? ESTADO.projeto.id : null;
  var html = '';

  projetos.forEach(function(proj) {
    var classe = obterClasseStatus(proj.status);
    var catPrio = obterCategoriaPrioridade(proj.valorPrioridade);
    var primeiroResp = obterPrimeiroResponsavel(proj.responsaveisIds || []);
    var sel = proj.id === projetoSelId ? ' selecionado' : '';

    html += '<div class="lista-projeto-item ' + classe + sel + '" onclick="selecionarProjeto(\'' + proj.id + '\')">' +
      '<div class="lista-projeto-icone ' + classe + '"><i class="fas fa-' + obterIconeStatus(proj.status) + '"></i></div>' +
      '<div class="lista-projeto-info"><div class="lista-projeto-nome">' + proj.nome + '</div>' +
      '<div class="lista-projeto-meta"><i class="fas fa-user"></i> ' + primeiroResp +
      (proj.setor ? ' ‚Ä¢ ' + proj.setor : '') + '</div></div>' +
      (proj.valorPrioridade ? '<span class="lista-projeto-prioridade ' + catPrio + '">' + proj.valorPrioridade + '</span>' : '') +
      '</div>';
  });

  container.innerHTML = html;
}

/** Barras de distribui√ß√£o por prioridade */
function renderizarBarrasPrioridade() {
  var container = document.getElementById('dashboardPrioridadeBars');
  if (!container) return;

  var projetos = obterProjetosFiltrados();
  var total = projetos.length || 1;

  var categorias = [
    { chave: 'alta', label: 'üî¥ Alta', classe: 'alta' },
    { chave: 'media', label: 'üü° M√©dia', classe: 'media' },
    { chave: 'baixa', label: 'üü¢ Baixa', classe: 'baixa' },
    { chave: 'nenhuma', label: '‚ö™ Sem c√°lculo', classe: 'nenhuma' }
  ];

  var html = '';
  categorias.forEach(function(cat) {
    var qtd = projetos.filter(function(p) { return obterCategoriaPrioridade(p.valorPrioridade) === cat.chave; }).length;
    var perc = Math.round((qtd / total) * 100);

    html += '<div class="prioridade-bar-item"><span class="prioridade-bar-label">' + cat.label + '</span>' +
      '<div class="prioridade-bar-container"><div class="prioridade-bar-fill ' + cat.classe + '" style="width:' + perc + '%;">' +
      (perc > 10 ? '<span class="prioridade-bar-valor">' + perc + '%</span>' : '') +
      '</div></div><span class="prioridade-bar-count">' + qtd + '</span></div>';
  });

  container.innerHTML = html;
}

/** Projetos cr√≠ticos (prioridade alta, n√£o conclu√≠dos) */
function renderizarProjetosCriticos() {
  var container = document.getElementById('dashboardCriticos');
  if (!container) return;

  var projetos = obterProjetosFiltrados();
  var criticos = projetos.filter(function(p) {
    return obterCategoriaPrioridade(p.valorPrioridade) === 'alta' &&
      p.status !== 'Conclu√≠da';
  }).sort(function(a, b) { return (b.valorPrioridade || 0) - (a.valorPrioridade || 0); });

  if (criticos.length === 0) {
    container.innerHTML = '<div class="dashboard-vazio"><i class="fas fa-check-circle"></i><p>Nenhum projeto cr√≠tico!</p></div>';
    return;
  }

  var html = '';
  criticos.slice(0, 5).forEach(function(proj) {
    var resp = obterPrimeiroResponsavel(proj.responsaveisIds || []);
    html += '<div class="critico-item" onclick="selecionarProjeto(\'' + proj.id + '\')">' +
      '<div class="critico-icone"><i class="fas fa-exclamation"></i></div>' +
      '<div class="critico-info"><div class="critico-nome">' + proj.nome + '</div>' +
      '<div class="critico-meta"><span><i class="fas fa-user"></i> ' + resp + '</span> ‚Ä¢ ' +
      '<span><i class="fas fa-' + obterIconeStatus(proj.status) + '"></i> ' + proj.status + '</span></div></div>' +
      '<div class="critico-valor">' + (proj.valorPrioridade || 0) + '</div></div>';
  });

  container.innerHTML = html;
}

function renderizarGraficoSetor() {
  var canvas = document.getElementById('graficoSetorCanvas');
  if (!canvas) return;
  if (!ESTADO.graficos) ESTADO.graficos = {};
  if (ESTADO.graficos.setor) ESTADO.graficos.setor.destroy();

  // ‚îÄ‚îÄ Projetos com todos os filtros EXCETO setor (para contagem dos chips) ‚îÄ‚îÄ
  // O usu√°rio precisa ver quantos projetos cada setor tem dentro do contexto atual
  var projetosSemFiltroSetor = ESTADO.listaProjetos.filter(function(p) {
    var filtros = ESTADO.filtrosGlobais;

    if (filtros.responsavelId && filtros.responsavelId !== 'TODOS') {
      if (filtros.responsavelId === 'sem-responsavel') {
        if (p.responsaveisIds && p.responsaveisIds.length > 0) return false;
      } else {
        if (!p.responsaveisIds || !p.responsaveisIds.includes(filtros.responsavelId)) return false;
      }
    }
    if (filtros.statusSelecionado && p.status !== filtros.statusSelecionado) return false;
    if (filtros.tipoProjeto && (p.tipo || 'Sem Tipo') !== filtros.tipoProjeto) return false;
    if (ESTADO.textoBusca) {
      if (!p.nome.toLowerCase().includes(ESTADO.textoBusca.toLowerCase())) return false;
    }
    return true;
  });

  // ‚îÄ‚îÄ Contagem por setor (sem filtro de setor ‚Äî para os chips) ‚îÄ‚îÄ
  var contagemTotal = {};
  projetosSemFiltroSetor.forEach(function(p) {
    var s = p.setor || 'Sem Setor';
    contagemTotal[s] = (contagemTotal[s] || 0) + 1;
  });

  var setoresOrdenados = Object.keys(contagemTotal).sort(function(a, b) {
    return contagemTotal[b] - contagemTotal[a];
  });

  // ‚îÄ‚îÄ Chips de filtro por setor ‚îÄ‚îÄ
  var chipContainerId = 'graficoSetorChips';
  var graficoWrapper  = canvas.closest('.grafico-setor-container');
  var chipContainer   = document.getElementById(chipContainerId);

  if (!chipContainer && graficoWrapper) {
    var headerEl = graficoWrapper.querySelector('.grafico-header');
    chipContainer = document.createElement('div');
    chipContainer.id = chipContainerId;
    chipContainer.className = 'grafico-setor-chips';
    headerEl.insertAdjacentElement('afterend', chipContainer);
  }

  if (chipContainer) {
    var filtroAtivo = ESTADO.filtroSetor;
    var html = '<span class="setor-chip ' + (!filtroAtivo ? 'ativo' : '') + '" onclick="filtrarPorSetor(null)">' +
      'Todos <span class="setor-chip-qtd">' + projetosSemFiltroSetor.length + '</span></span>';

    setoresOrdenados.forEach(function(setor) {
      var ativo = filtroAtivo === setor;
      html += '<span class="setor-chip ' + (ativo ? 'ativo' : '') + '" ' +
        'onclick="filtrarPorSetor(\'' + setor.replace(/'/g, "\\'") + '\')">' +
        setor + ' <span class="setor-chip-qtd">' + contagemTotal[setor] + '</span></span>';
    });
    chipContainer.innerHTML = html;
  }

  // ‚îÄ‚îÄ Dados do gr√°fico: usa obterProjetosFiltrados() ‚Äî respeita TODOS os filtros ‚îÄ‚îÄ
  var projetosFiltrados = obterProjetosFiltrados();
  var modoFiltrado = !!ESTADO.filtroSetor;

  var contagem = {};
  if (modoFiltrado) {
    // Setor ativo: exibe distribui√ß√£o por STATUS dentro do setor
    projetosFiltrados.forEach(function(p) {
      var s = p.status || 'A Fazer';
      contagem[s] = (contagem[s] || 0) + 1;
    });
  } else {
    // Sem filtro de setor: exibe quantidade por setor
    projetosFiltrados.forEach(function(p) {
      var s = p.setor || 'Sem Setor';
      contagem[s] = (contagem[s] || 0) + 1;
    });
  }

  var pares = Object.keys(contagem)
    .map(function(k) { return { label: k, valor: contagem[k] }; })
    .sort(function(a, b) { return b.valor - a.valor; });

  var labels  = pares.map(function(p) { return p.label; });
  var valores = pares.map(function(p) { return p.valor; });

  var paletaCores = [
    'rgba(107,76,59,0.75)',  'rgba(74,111,165,0.75)',
    'rgba(85,107,75,0.75)',  'rgba(202,138,4,0.75)',
    'rgba(166,61,64,0.75)',  'rgba(121,92,142,0.75)',
    'rgba(52,121,121,0.75)', 'rgba(184,115,51,0.75)'
  ];

  var cores;
  if (modoFiltrado) {
    cores = labels.map(function(label) {
      var corObj = CORES_STATUS[label];
      return corObj ? corObj.cor : paletaCores[0];
    });
  } else {
    cores = labels.map(function(_, i) { return paletaCores[i % paletaCores.length]; });
  }

ESTADO.graficos.setor = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: modoFiltrado ? 'Projetos por Status' : 'Projetos por Setor',
        data: valores,
        backgroundColor: cores,
        borderRadius: 5,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      layout: {
        padding: { left: 4, right: 8, top: 4, bottom: 4 }
      },
      plugins: {
        legend: { display: false },
        title: modoFiltrado ? {
          display: true,
          text: 'üìÇ Setor: ' + ESTADO.filtroSetor,
          color: '#6b4c3b',
          font: { size: 11, weight: '600' },
          padding: { bottom: 4 }
        } : { display: false },
        tooltip: {
          backgroundColor: 'rgba(61,43,31,0.9)',
          callbacks: {
            label: function(ctx) {
              return ' ' + ctx.raw + ' projeto(s)' + (modoFiltrado ? ' ‚Äî ' + ctx.label : '');
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { color: '#9a8a78', font: { size: 11 }, stepSize: 1 },
          grid: { color: 'rgba(107,76,59,0.08)' }
        },
        y: {
          // ‚Üê afterFit garante largura m√≠nima para que os r√≥tulos n√£o sejam cortados
          afterFit: function(eixo) {
            eixo.width = Math.max(eixo.width, 100);
          },
          ticks: {
            color: '#6b4c3b',
            font: { size: 11 },
            autoSkip: false,    // nunca pular r√≥tulos
            maxRotation: 0      // r√≥tulos sempre horizontais
          },
          grid: { display: false }
        }
      },
      onClick: function(evt, elements) {
        if (elements.length > 0 && !modoFiltrado) {
          filtrarPorSetor(labels[elements[0].index]);
        }
      }
    }
  });
}
/** Renderiza o gr√°fico de barras "Projetos por Tipo de Projeto" */
function renderizarGraficoTipoProjeto() {
  var canvas = document.getElementById('graficoTipoCanvas');
  if (!canvas) return;
  if (!ESTADO.graficos) ESTADO.graficos = {};
  if (ESTADO.graficos.tipo) ESTADO.graficos.tipo.destroy();

  var filtroAtivo = ESTADO.filtrosGlobais.tipoProjeto;

  // ‚îÄ‚îÄ Chips de filtro (contagem do total de projetos ‚Äî sem filtro de tipo) ‚îÄ‚îÄ
  var contagemTodos = {};
  ESTADO.listaProjetos.forEach(function(p) {
    var t = p.tipo && p.tipo.trim() ? p.tipo : 'Sem Tipo';
    contagemTodos[t] = (contagemTodos[t] || 0) + 1;
  });

  var chipContainerId = 'graficoTipoChips';
  var graficoWrapper  = canvas.closest('.grafico-setor-container');
  var chipContainer   = document.getElementById(chipContainerId);

  if (!chipContainer && graficoWrapper) {
    var headerEl = graficoWrapper.querySelector('.grafico-header');
    chipContainer = document.createElement('div');
    chipContainer.id = chipContainerId;
    chipContainer.className = 'grafico-setor-chips';
    headerEl.insertAdjacentElement('afterend', chipContainer);
  }

  if (chipContainer) {
    var html = '<span class="setor-chip ' + (!filtroAtivo ? 'ativo' : '') + '" onclick="filtrarPorTipoProjeto(null)">' +
      'Todos <span class="setor-chip-qtd">' + ESTADO.listaProjetos.length + '</span></span>';

    Object.keys(contagemTodos).sort().forEach(function(tipo) {
      var ativo = filtroAtivo === tipo;
      html += '<span class="setor-chip ' + (ativo ? 'ativo' : '') + '" ' +
        'onclick="filtrarPorTipoProjeto(\'' + tipo.replace(/'/g, "\\'") + '\')">' +
        tipo + ' <span class="setor-chip-qtd">' + contagemTodos[tipo] + '</span></span>';
    });
    chipContainer.innerHTML = html;
  }

  // ‚îÄ‚îÄ Dados do gr√°fico: projetos com filtros ativos ‚îÄ‚îÄ
  var projetos = obterProjetosFiltrados();
  var contagem = {};
  projetos.forEach(function(p) {
    var t = p.tipo && p.tipo.trim() ? p.tipo : 'Sem Tipo';
    contagem[t] = (contagem[t] || 0) + 1;
  });

  var pares = Object.keys(contagem)
    .map(function(k) { return { label: k, valor: contagem[k] }; })
    .sort(function(a, b) { return b.valor - a.valor; });

  var labels  = pares.map(function(p) { return p.label; });
  var valores = pares.map(function(p) { return p.valor; });

  // Cores fixas por tipo (mesma paleta usada nos badges)
  var coresTipo = {
    'Corre√ß√£o':            'rgba(166,61,64,0.75)',
    'Nova Implementa√ß√£o':  'rgba(74,111,165,0.75)',
    'Melhoria':            'rgba(85,107,75,0.75)',
    'Sem Tipo':            'rgba(176,160,144,0.60)'
  };
  var cores = labels.map(function(l) { return coresTipo[l] || 'rgba(107,76,59,0.75)'; });

  ESTADO.graficos.tipo = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Projetos por Tipo',
        data: valores,
        backgroundColor: cores,
        borderRadius: 5,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(61,43,31,0.9)',
          callbacks: { label: function(ctx) { return ' ' + ctx.raw + ' projeto(s)'; } }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { color: '#9a8a78', font: { size: 11 }, stepSize: 1 },
          grid: { color: 'rgba(107,76,59,0.08)' }
        },
        y: {
          ticks: { color: '#6b4c3b', font: { size: 11 } },
          grid: { display: false }
        }
      },
      onClick: function(evt, elements) {
        if (elements.length > 0) {
          filtrarPorTipoProjeto(labels[elements[0].index]);
        }
      }
    }
  });
}

/** Renderiza o gr√°fico de barras "Projetos por Respons√°vel" */
function renderizarGraficoResponsaveis() {
  var canvas = document.getElementById('graficoResponsaveisCanvas');
  if (!canvas) return;
  if (!ESTADO.graficos) ESTADO.graficos = {};
  if (ESTADO.graficos.responsaveisChart) ESTADO.graficos.responsaveisChart.destroy();

  var filtroAtivo = ESTADO.filtrosGlobais.responsavelId; // 'TODOS' ou id espec√≠fico
  var projetos    = obterProjetosFiltrados();

  // ‚îÄ‚îÄ Contar projetos por respons√°vel (um projeto pode ter m√∫ltiplos) ‚îÄ‚îÄ
  var contagemResp = {};
  ESTADO.responsaveis.forEach(function(r) { contagemResp[r.id] = 0; });

  projetos.forEach(function(p) {
    (p.responsaveisIds || []).forEach(function(id) {
      if (contagemResp[id] !== undefined) contagemResp[id]++;
    });
  });

  // Ordenar por contagem decrescente, filtrar os que t√™m projetos
  var pares = ESTADO.responsaveis
    .map(function(r) { return { id: r.id, label: r.nome, valor: contagemResp[r.id] || 0 }; })
    .filter(function(p) { return p.valor > 0; })
    .sort(function(a, b) { return b.valor - a.valor; });

  var labels  = pares.map(function(p) { return p.label; });
  var ids     = pares.map(function(p) { return p.id; });
  var valores = pares.map(function(p) { return p.valor; });

  // Destaque visual: barra do respons√°vel filtrado fica mais opaca
  var cores = ids.map(function(id) {
    if (filtroAtivo === 'TODOS' || !filtroAtivo) return 'rgba(107,76,59,0.75)';
    return filtroAtivo === id ? 'rgba(107,76,59,0.95)' : 'rgba(107,76,59,0.25)';
  });

  ESTADO.graficos.responsaveisChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Projetos',
        data: valores,
        backgroundColor: cores,
        borderRadius: 5,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(61,43,31,0.9)',
          callbacks: {
            label: function(ctx) {
              var ativo = ids[ctx.dataIndex] === filtroAtivo;
              return ' ' + ctx.raw + ' projeto(s)' + (ativo ? ' ‚úì filtrado' : '');
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { color: '#9a8a78', font: { size: 11 }, stepSize: 1 },
          grid: { color: 'rgba(107,76,59,0.08)' }
        },
        y: {
          ticks: { color: '#6b4c3b', font: { size: 11 } },
          grid: { display: false }
        }
      },
      onClick: function(evt, elements) {
        if (elements.length > 0) {
          var respId = ids[elements[0].index];
          // Toggle: clicar no j√° ativo remove o filtro
          filtrarPorResponsavelHeader(filtroAtivo === respId ? 'TODOS' : respId);
        }
      }
    }
  });
}

/** Aplica ou remove o filtro por tipo de projeto (toggle) */
function filtrarPorTipoProjeto(tipo) {
  // Toggle: clicar no tipo j√° ativo remove o filtro
  if (tipo !== null && ESTADO.filtrosGlobais.tipoProjeto === tipo) {
    tipo = null;
  }
  ESTADO.filtrosGlobais.tipoProjeto = tipo;

  // Aviso visual na coluna de projetos (stacked com o aviso de setor, se existir)
  var avisoCont = document.getElementById('avisoFiltroTipo');
  if (tipo) {
    if (!avisoCont) {
      avisoCont = document.createElement('div');
      avisoCont.id = 'avisoFiltroTipo';
      avisoCont.className = 'setor-filtro-ativo-aviso';
      var lista = document.getElementById('projetosCardsLista');
      if (lista) lista.parentNode.insertBefore(avisoCont, lista);
    }
    avisoCont.innerHTML =
      '<i class="fas fa-tag"></i> Filtrando por tipo: <strong>' + tipo + '</strong>' +
      '<span class="setor-filtro-limpar" onclick="filtrarPorTipoProjeto(null)">' +
        '<i class="fas fa-times"></i> Limpar' +
      '</span>';
  } else {
    if (avisoCont) avisoCont.remove();
  }

  // Atualiza todos os componentes (cross-filtering)
  atualizarTodosComponentes();
}

/** Filtra projetos pelo setor selecionado no gr√°fico */
function filtrarPorSetor(setor) {
  // Toggle: clicar no setor j√° ativo remove o filtro
  if (ESTADO.filtroSetor === setor && setor !== null) {
    setor = null;
  }

  ESTADO.filtroSetor = setor;
  ESTADO.filtrosGlobais.setorSelecionado = setor;

  // Aviso visual na coluna de projetos
  var avisoCont = document.getElementById('avisoFiltroSetor');
  if (setor) {
    if (!avisoCont) {
      avisoCont = document.createElement('div');
      avisoCont.id = 'avisoFiltroSetor';
      avisoCont.className = 'setor-filtro-ativo-aviso';
      var lista = document.getElementById('projetosCardsLista');
      if (lista) lista.parentNode.insertBefore(avisoCont, lista);
    }
    avisoCont.innerHTML =
      '<i class="fas fa-filter"></i> Filtrando por setor: <strong>' + setor + '</strong>' +
      '<span class="setor-filtro-limpar" onclick="filtrarPorSetor(null)">' +
        '<i class="fas fa-times"></i> Limpar' +
      '</span>';
  } else {
    if (avisoCont) avisoCont.remove();
  }

  // ‚òÖ Atualiza TODOS os componentes (cross-filtering correto) ‚òÖ
  atualizarTodosComponentes();
}

function renderizarProjetosCards() {
  var container = document.getElementById('projetosCardsLista');
  if (!container) return;

  var projetosFiltrados = obterProjetosFiltrados();

  if (projetosFiltrados.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>Nenhum projeto encontrado</p></div>';
    return;
  }

  projetosFiltrados.sort(function(a, b) { return (b.valorPrioridade || 0) - (a.valorPrioridade || 0); });

  var projetoSelId = ESTADO.projeto ? ESTADO.projeto.id : null;
  var html = '';

  projetosFiltrados.forEach(function(proj, idx) {
    var valorPrio    = proj.valorPrioridade || 0;
    var catPrio      = obterCategoriaPrioridade(valorPrio);
    var classeStatus = obterClasseStatus(proj.status);
    var expandido    = ESTADO.cardsExpandidos[proj.id] === true;
    var selecionado  = proj.id === projetoSelId;
    var primeiroResp = obterPrimeiroResponsavel(proj.responsaveisIds || []);
    var nomesResp    = obterNomesResponsaveis(proj.responsaveisIds || []);
    var textoResp    = nomesResp.length > 0 ? nomesResp.map(function(r) { return r.nome; }).join(', ') : 'Sem respons√°vel';

    // ‚òÖ DATAS E DURA√á√ÉO ‚òÖ
    var textoInicio     = formatarData(proj.dataInicio);
    var textoFim        = formatarData(proj.dataFim);
    var textoDuracaoCard = obterDuracaoFormatada(proj);

    var classCard = 'projeto-card-completo' +
      (expandido ? '' : ' minimizado') +
      ' prioridade-' + catPrio +
      (selecionado ? ' selecionado' : '');

    html += '<div class="' + classCard + '" draggable="true" data-projeto-id="' + proj.id + '" ' +
      'ondragstart="iniciarArrastarProjeto(event)" ondragend="finalizarArrastarProjeto(event)" ' +
      'ondragover="arrastarSobreProjeto(event)" ondragleave="sairArrastarProjeto(event)" ondrop="soltarProjeto(event)">';

    // Header do card
    html += '<div class="projeto-card-header" onclick="selecionarProjeto(\'' + proj.id + '\')">';
    html += '<span class="projeto-card-ordem">' + (idx + 1) + '</span>';
    html += '<div class="projeto-card-titulo-area">';
    html += '<div class="projeto-card-titulo">' + proj.nome + '</div>';
    html += '<div class="projeto-card-resp-mini"><i class="fas fa-user"></i> ' + primeiroResp + '</div>';
    html += '<div class="projeto-card-badges">';
    html += '<span class="badge badge-' + classeStatus + '">' + (proj.status || 'A Fazer') + '</span>';
    html += renderizarBadgeValorPrioridade(valorPrio, catPrio);
    if (proj.tipo) html += '<span class="badge-tipo ' + obterClasseTipo(proj.tipo) + '">' + proj.tipo + '</span>';
    // ‚òÖ Badge de dura√ß√£o no header (quando dispon√≠vel) ‚òÖ
    if (textoDuracaoCard) {
      html += '<span class="badge-duracao"><i class="fas fa-hourglass-half"></i> ' + textoDuracaoCard + '</span>';
    }

    html += '</div></div>';

    // A√ß√µes
    html += '<div class="projeto-card-acoes">';
    html += '<button class="btn-calcular-prioridade ' + (valorPrio > 0 ? 'tem-valor' : '') + '" ' +
      'onclick="abrirModalCalculoPrioridade(\'' + proj.id + '\', event)" title="Calcular Prioridade GUT">' +
      '<i class="fas fa-calculator"></i></button>';
    html += '<button class="btn-expandir-card" onclick="alternarExpansaoCard(\'' + proj.id + '\', event)" title="' + (expandido ? 'Minimizar' : 'Expandir') + '">' +
      '<i class="fas fa-chevron-down"></i></button>';
    html += '<i class="fas fa-grip-vertical projeto-card-handle"></i>';
    html += '</div></div>';

    // Corpo (expand√≠vel)
    html += '<div class="projeto-card-corpo"><div class="projeto-card-grid">';

    // Descri√ß√£o
    html += '<div class="projeto-card-campo full"><div class="projeto-card-campo-label"><i class="fas fa-align-left"></i> Descri√ß√£o</div>' +
      '<div class="projeto-card-campo-valor ' + (!proj.descricao ? 'vazio' : '') + '">' + (proj.descricao || 'N√£o informada') + '</div></div>';

    // ‚òÖ BLOCO DE DATAS E DURA√á√ÉO ‚òÖ
    html += '<div class="projeto-card-campo full">' +
      '<div class="projeto-card-campo-label"><i class="fas fa-calendar-alt"></i> Per√≠odo do Projeto</div>' +
      '<div class="projeto-card-datas-wrapper">';

    html += '<span class="projeto-card-data-item ' + (!textoInicio ? 'vazio' : '') + '">' +
      '<i class="fas fa-play-circle" style="color:var(--cor-sucesso);"></i> ' +
      '<strong>In√≠cio:</strong> ' + (textoInicio || 'N√£o definida') + '</span>';

    html += '<span class="projeto-card-data-sep">‚Üí</span>';

    html += '<span class="projeto-card-data-item ' + (!textoFim ? 'vazio' : '') + '">' +
      '<i class="fas fa-stop-circle" style="color:var(--cor-perigo);"></i> ' +
      '<strong>Fim:</strong> ' + (textoFim || 'N√£o definida') + '</span>';

    if (textoDuracaoCard) {
      html += '<span class="projeto-card-duracao">' +
        '<i class="fas fa-hourglass-half"></i> <strong>' + textoDuracaoCard + '</strong></span>';
    }

    html += '</div></div>';

    // Tipo e Para Quem
    html += '<div class="projeto-card-campo"><div class="projeto-card-campo-label"><i class="fas fa-tag"></i> Tipo</div>' +
      '<div class="projeto-card-campo-valor ' + (!proj.tipo ? 'vazio' : '') + '">' + (proj.tipo || 'N√£o informado') + '</div></div>';
    html += '<div class="projeto-card-campo"><div class="projeto-card-campo-label"><i class="fas fa-user"></i> Para Quem</div>' +
      '<div class="projeto-card-campo-valor ' + (!proj.paraQuem ? 'vazio' : '') + '">' + (proj.paraQuem || 'N√£o informado') + '</div></div>';

    // Gravidade e Urg√™ncia
    html += '<div class="projeto-card-campo"><div class="projeto-card-campo-label"><i class="fas fa-exclamation-triangle"></i> Gravidade</div>' +
      '<div class="projeto-card-campo-valor ' + (!proj.gravidade ? 'vazio' : '') + '">' + (proj.gravidade || 'N√£o definida') + '</div></div>';
    html += '<div class="projeto-card-campo"><div class="projeto-card-campo-label"><i class="fas fa-clock"></i> Urg√™ncia</div>' +
      '<div class="projeto-card-campo-valor ' + (!proj.urgencia ? 'vazio' : '') + '">' + (proj.urgencia || 'N√£o definida') + '</div></div>';

    // Respons√°veis e Setor
    html += '<div class="projeto-card-campo"><div class="projeto-card-campo-label"><i class="fas fa-user-tie"></i> Respons√°veis</div>' +
      '<div class="projeto-card-campo-valor ' + (nomesResp.length === 0 ? 'vazio' : '') + '">' + textoResp + '</div></div>';
    html += '<div class="projeto-card-campo"><div class="projeto-card-campo-label"><i class="fas fa-building"></i> Setor</div>' +
      '<div class="projeto-card-campo-campo-valor ' + (!proj.setor ? 'vazio' : '') + '">' + (proj.setor || 'N√£o informado') + '</div></div>';

    // Link
    if (proj.link) {
      html += '<div class="projeto-card-campo full"><div class="projeto-card-campo-label"><i class="fas fa-folder-open"></i> Documentos do Projeto</div>' +
        '<div class="campo-link-wrapper"><input type="text" readonly class="campo-link-readonly" value="' + proj.link + '">' +
        '<a href="' + proj.link + '" target="_blank" class="btn-abrir-link" title="Abrir no Drive"><i class="fas fa-external-link-alt"></i></a></div></div>';
    }

    html += '</div></div></div>';
  });

  container.innerHTML = html;
}

function alternarExpansaoCard(projetoId, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }
  ESTADO.cardsExpandidos[projetoId] = !ESTADO.cardsExpandidos[projetoId];
  var card = document.querySelector('.projeto-card-completo[data-projeto-id="' + projetoId + '"]');
  if (card) card.classList.toggle('minimizado', !ESTADO.cardsExpandidos[projetoId]);
}

function atualizarContadorProjetos() {
  var el = document.getElementById('contadorProjetosPriorizacao');
  if (el) el.textContent = obterProjetosFiltrados().length;
}
// ========================= LIXEIRA DE PROJETOS =========================

// ========================= EXCLUS√ÉO COM MODAL =========================

var _projetoParaExcluir = null;

function confirmarExcluirProjeto(projetoId, nomeProjeto, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }

  _projetoParaExcluir = { id: projetoId, nome: nomeProjeto };

  document.getElementById('exclusaoNomeProjeto').textContent = nomeProjeto;
  abrirModal('modalConfirmarExclusao');
}

/** Fecha o modal de confirma√ß√£o de exclus√£o e limpa o estado */
function fecharModalConfirmarExclusao() {
  fecharModal('modalConfirmarExclusao');
  _projetoParaExcluir = null;
}

/** Executa a exclus√£o ap√≥s confirma√ß√£o no modal */
function executarExclusaoProjeto() {
  if (!_projetoParaExcluir) return;

  var projetoId   = _projetoParaExcluir.id;
  var btn         = document.getElementById('btnConfirmarExclusao');
  var textoOrig   = btn.innerHTML;

  // Feedback visual no bot√£o
  btn.disabled    = true;
  btn.innerHTML   = '<i class="fas fa-spinner fa-spin"></i> Movendo...';

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        btn.disabled  = false;
        btn.innerHTML = textoOrig;
        fecharModalConfirmarExclusao();

        if (res.sucesso) {
          mostrarToast(res.mensagem, 'sucesso');
          ESTADO.listaProjetos = ESTADO.listaProjetos.filter(function(p) { return p.id !== projetoId; });
          if (ESTADO.projeto && ESTADO.projeto.id === projetoId) {
            ESTADO.projeto = null;
            ESTADO.etapas  = [];
          }
          renderizarTudo();
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        btn.disabled  = false;
        btn.innerHTML = textoOrig;
        fecharModalConfirmarExclusao();
        mostrarToast('Erro: ' + e, 'erro');
      })
      .excluirProjeto(projetoId);
  } else {
    // Demo
    setTimeout(function() {
      btn.disabled  = false;
      btn.innerHTML = textoOrig;
      fecharModalConfirmarExclusao();
      ESTADO.listaProjetos = ESTADO.listaProjetos.filter(function(p) { return p.id !== projetoId; });
      if (ESTADO.projeto && ESTADO.projeto.id === projetoId) { ESTADO.projeto = null; ESTADO.etapas = []; }
      mostrarToast('Projeto movido para lixeira (demo)', 'sucesso');
      renderizarTudo();
    }, 800);
  }
}

/** Abre o modal da lixeira e carrega os projetos exclu√≠dos */
function abrirModalLixeira() {
  var corpo = document.getElementById('lixeiraCorpo');
  corpo.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Carregando lixeira...</p></div>';
  abrirModal('modalLixeira');

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (res.sucesso) renderizarLixeira(res.projetos);
        else corpo.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro: ' + res.mensagem + '</p></div>';
      })
      .withFailureHandler(function(e) {
        corpo.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro: ' + e + '</p></div>';
      })
      .listarLixeira();
  } else {
    // Demo
    setTimeout(function() { renderizarLixeira([]); }, 500);
  }
}

/** Renderiza a lista de projetos na lixeira */
function renderizarLixeira(projetos) {
  var corpo = document.getElementById('lixeiraCorpo');

  if (!projetos || projetos.length === 0) {
    corpo.innerHTML =
      '<div class="empty-state" style="padding:32px;">' +
        '<i class="fas fa-check-circle" style="color:var(--cor-sucesso);font-size:2.5rem;"></i>' +
        '<p style="margin-top:12px;">A lixeira est√° vazia!</p>' +
      '</div>';
    return;
  }

  var html = '<div class="lixeira-aviso"><i class="fas fa-info-circle"></i> ' +
    projetos.length + ' projeto(s) na lixeira. Projetos aqui <strong>n√£o aparecem</strong> na gest√£o.</div>';

  projetos.forEach(function(proj) {
    var catPrio  = obterCategoriaPrioridade(proj.valorPrioridade || 0);
    var classeStatus = obterClasseStatus(proj.status);
    var dataExcl = proj.dataExclusao ? new Date(proj.dataExclusao).toLocaleDateString('pt-BR') : 'Data desconhecida';

    html +=
      '<div class="lixeira-item">' +
        '<div class="lixeira-item-info">' +
          '<div class="lixeira-item-nome">' + proj.nome + '</div>' +
          '<div class="lixeira-item-meta">' +
            '<span class="badge badge-' + classeStatus + '">' + (proj.status || 'A Fazer') + '</span>' +
            (proj.setor ? '<span class="lixeira-setor"><i class="fas fa-building"></i> ' + proj.setor + '</span>' : '') +
            '<span class="lixeira-data"><i class="fas fa-calendar-times"></i> Exclu√≠do em ' + dataExcl + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lixeira-item-acoes">' +
          '<button class="btn-lixeira-restaurar" onclick="restaurarProjeto(\'' + proj.id + '\')" title="Restaurar projeto">' +
            '<i class="fas fa-undo"></i> Restaurar' +
          '</button>' +
          '<button class="btn-lixeira-excluir" onclick="excluirPermanente(\'' + proj.id + '\', \'' + proj.nome.replace(/'/g, "\\'") + '\')" title="Excluir permanentemente">' +
            '<i class="fas fa-times"></i>' +
          '</button>' +
        '</div>' +
      '</div>';
  });

  corpo.innerHTML = html;
}

/** Restaura um projeto da lixeira */
function restaurarProjeto(projetoId) {
  var corpo = document.getElementById('lixeiraCorpo');
  mostrarSpinner(corpo);

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderSpinner(corpo);
        if (res.sucesso) {
          mostrarToast(res.mensagem, 'sucesso');
          // Recarregar dados em background
          recarregarDadosSemTela();
          // Reabrir lixeira atualizada
          abrirModalLixeira();
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderSpinner(corpo);
        mostrarToast('Erro: ' + e, 'erro');
      })
      .restaurarDaLixeira(projetoId);
  } else {
    setTimeout(function() {
      esconderSpinner(corpo);
      mostrarToast('Projeto restaurado (demo)', 'sucesso');
      fecharModalLixeira();
    }, 600);
  }
}

/** Exclui permanentemente um projeto da lixeira */
function excluirPermanente(projetoId, nomeProjeto) {
  if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nExcluir "' + nomeProjeto + '" permanentemente?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!')) return;

  var corpo = document.getElementById('lixeiraCorpo');
  mostrarSpinner(corpo);

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderSpinner(corpo);
        if (res.sucesso) {
          mostrarToast(res.mensagem, 'sucesso');
          abrirModalLixeira(); // Recarrega
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderSpinner(corpo);
        mostrarToast('Erro: ' + e, 'erro');
      })
      .excluirDefinitivamente(projetoId);
  } else {
    setTimeout(function() {
      esconderSpinner(corpo);
      mostrarToast('Exclu√≠do permanentemente (demo)', 'sucesso');
      fecharModalLixeira();
    }, 600);
  }
}

function fecharModalLixeira() {
  fecharModal('modalLixeira');
}

// ========================= SELE√á√ÉO DE PROJETO =========================
function selecionarProjeto(projetoId) {
  carregarEstruturaProjetoSelecionado(projetoId);
}

function carregarEstruturaProjetoSelecionado(projetoId) {
  var projeto = ESTADO.listaProjetos.find(function(p) { return p.id === projetoId; });
  if (!projeto) return;

  ESTADO.projeto = projeto;

  // ‚òÖ RESET: ao trocar de projeto, o filtro de atividades volta ao padr√£o
  ESTADO.filtroStatusAtividades = 'todos';

  document.getElementById('headerTitulo').textContent = 'Gest√£o de Projetos';

  // Destacar card selecionado
  document.querySelectorAll('.projeto-card-completo.selecionado').forEach(function(el) { el.classList.remove('selecionado'); });
  var card = document.querySelector('.projeto-card-completo[data-projeto-id="' + projetoId + '"]');
  if (card) {
    card.classList.add('selecionado');
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  carregarAtividadesDoProjeto(projetoId);
}

function equalizarAlturasGraficos() {
  requestAnimationFrame(function() {
    if (ESTADO.graficoDonut) ESTADO.graficoDonut.resize();
    if (ESTADO.graficos) {
      if (ESTADO.graficos.setor)            ESTADO.graficos.setor.resize();
      if (ESTADO.graficos.tipo)             ESTADO.graficos.tipo.resize();
      if (ESTADO.graficos.responsaveisChart) ESTADO.graficos.responsaveisChart.resize();
    }
  });
}

function carregarAtividadesDoProjeto(projetoId) {
  var containerDiagrama = document.getElementById('diagramaArvore');
  mostrarSpinner(containerDiagrama);

  // Garante reset do filtro ao trocar de projeto
  ESTADO.filtroStatusAtividades = ESTADO.filtroStatusAtividades || 'todos';

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(etapas) {
        ESTADO.etapas = etapas || [];
        esconderSpinner(containerDiagrama);
        renderizarDiagrama();
      })
      .withFailureHandler(function(erro) {
        esconderSpinner(containerDiagrama);
        containerDiagrama.innerHTML =
          '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro: ' + erro + '</p></div>';
      })
      .listarEtapasPorProjetoOrdenadas(projetoId); // ‚Üê usa a nova fun√ß√£o com ordem salva
  } else {
    setTimeout(function() {
      ESTADO.etapas = ESTADO.etapas || [];
      esconderSpinner(containerDiagrama);
      renderizarDiagrama();
    }, 500);
  }
}

/** Gera as iniciais de um nome para uso em avatars */
function gerarIniciais(nome) {
  if (!nome) return '?';
  var partes = nome.trim().split(/\s+/);
  if (partes.length === 1) return partes[0].charAt(0).toUpperCase();
  return (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
}

function renderizarDiagrama() {
  var container = document.getElementById('diagramaArvore');
  if (!ESTADO.projeto || !ESTADO.projeto.id) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-hand-pointer"></i><p>Selecione um projeto para visualizar sua estrutura</p></div>';
    return;
  }

  var proj            = ESTADO.projeto;
  var etapasDoProjeto = ESTADO.etapas.filter(function(e) { return e.projetoId === proj.id; });
  var valorPrio       = proj.valorPrioridade || 0;
  var catPrio         = obterCategoriaPrioridade(valorPrio);
  var classeStatus    = obterClasseStatus(proj.status);
  var respsObj        = obterNomesResponsaveis(proj.responsaveisIds || []);
  var labelsCat       = { alta: 'üî¥ Prioridade Alta', media: 'üü° Prioridade M√©dia', baixa: 'üü¢ Prioridade Baixa', nenhuma: '‚Äî Sem c√°lculo' };

  var textoInicio      = formatarData(proj.dataInicio);
  var textoFim         = formatarData(proj.dataFim);
  var textoDuracao     = obterDuracaoFormatada(proj);
  var duracaoParaBadge = textoDuracao; // para o badge no hero

  var totalAtividades      = etapasDoProjeto.length;
  var concluidasAtividades = etapasDoProjeto.filter(function(e) { return e.status === 'Conclu√≠da'; }).length;
  var percentualConcluido  = totalAtividades > 0 ? Math.round((concluidasAtividades / totalAtividades) * 100) : 0;
  var corProgresso = percentualConcluido === 100 ? 'var(--cor-sucesso)' : percentualConcluido >= 50 ? 'var(--cor-aviso)' : 'var(--cor-primaria)';

  var expandido = ESTADO.projetoExpandidoDiagrama;
  var html = '<div class="arvore-raiz">';

  // ‚îÄ‚îÄ Card do Projeto (mantido sem altera√ß√£o) ‚îÄ‚îÄ
  html += '<div class="diagrama-proj-card">';

  html += '<div class="diagrama-proj-hero">';
  html += '<div class="diagrama-proj-hero-icone"><i class="fas fa-folder-open"></i></div>';
  html += '<div class="diagrama-proj-hero-info">';
  html += '<div class="diagrama-proj-hero-nome">' + proj.nome + '</div>';
  html += '<div class="diagrama-proj-hero-badges">';
  html += '<span class="badge-hero ' + classeStatus + '"><i class="fas fa-' + obterIconeStatus(proj.status) + '"></i> ' + (proj.status || 'A Fazer') + '</span>';
  if (valorPrio > 0) html += '<span class="badge-gut-hero ' + catPrio + '">‚ö° ' + valorPrio + '</span>';
  else html += '<span class="badge-gut-hero nenhuma">‚ö° Sem Score</span>';
  if (proj.tipo) html += '<span class="badge-hero"><i class="fas fa-tag"></i> ' + proj.tipo + '</span>';
  if (textoDuracao) html += '<span class="badge-hero"><i class="fas fa-hourglass-half"></i> ' + textoDuracao + '</span>';;
  html += '</div></div>';
  html += '<div class="diagrama-proj-hero-acoes">';
  html += '<button class="btn-diagrama expandir-metricas ' + (expandido ? 'ativo' : '') + '" onclick="alternarExpansaoDiagrama(event)" title="' + (expandido ? 'Recolher' : 'Expandir') + ' detalhes"><i class="fas fa-chevron-down"></i></button>';
  html += '<button class="btn-diagrama" onclick="abrirModalEdicao(\'projeto\', \'' + proj.id + '\')" title="Editar projeto"><i class="fas fa-edit"></i></button>';
  html += '<button class="btn-diagrama btn-diagrama-excluir" onclick="confirmarExcluirProjeto(\'' + proj.id + '\', \'' + proj.nome.replace(/'/g, "\\'") + '\', event)" title="Mover para Lixeira"><i class="fas fa-trash-alt"></i></button>';
  html += '</div></div>';

  html += '<div class="diagrama-proj-descricao-fixa ' + (!proj.descricao || !proj.descricao.trim() ? 'vazia' : '') + '">';
  html += proj.descricao && proj.descricao.trim()
    ? '<i class="fas fa-align-left" style="color:var(--cor-primaria-clara);margin-right:5px;font-size:0.72rem;"></i>' + proj.descricao
    : '<i class="fas fa-align-left" style="margin-right:5px;font-size:0.72rem;"></i>Sem descri√ß√£o cadastrada.';
  html += '</div>';

  var metricas = [
    { label: 'Para Quem', icon: 'building',            valor: proj.paraQuem },
    { label: 'Setor',     icon: 'layer-group',          valor: proj.setor },
    { label: 'Gravidade', icon: 'exclamation-triangle', valor: proj.gravidade },
    { label: 'Urg√™ncia',  icon: 'clock',                valor: proj.urgencia },
    { label: 'In√≠cio',    icon: 'calendar-alt',         valor: textoInicio },
    { label: 'Fim',       icon: 'calendar-check',       valor: textoFim },
    { label: 'Dura√ß√£o',   icon: 'hourglass-half',       valor: textoDuracao }
  ];
  if (proj.pilar) metricas.push({ label: 'Pilar', icon: 'columns', valor: proj.pilar });

  html += '<div class="diagrama-proj-metricas-wrapper' + (expandido ? ' visivel' : '') + '">';
  html += '<div class="diagrama-proj-metricas">';
  metricas.forEach(function(m) {
    html += '<div class="diagrama-proj-metrica">';
    html += '<div class="diagrama-proj-metrica-label"><i class="fas fa-' + m.icon + '"></i>' + m.label + '</div>';
    html += '<div class="diagrama-proj-metrica-valor ' + (!m.valor ? 'vazio' : '') + '">' + (m.valor || 'N√£o informado') + '</div>';
    html += '</div>';
  });
  html += '</div></div>';

  if (totalAtividades > 0) {
    html += '<div class="diagrama-progresso-wrapper">';
    html += '<div class="diagrama-progresso-header">';
    html += '<span class="diagrama-progresso-titulo"><i class="fas fa-tasks"></i> Progresso</span>';
    html += '<span class="diagrama-progresso-contagem">' + concluidasAtividades + ' de ' + totalAtividades + ' conclu√≠das</span>';
    html += '</div>';
    html += '<div class="diagrama-progresso-barra-bg"><div class="diagrama-progresso-barra-fill" style="width:' + percentualConcluido + '%;background:' + corProgresso + ';"></div></div>';
    html += '<div class="diagrama-progresso-pct" style="color:' + corProgresso + ';">' + percentualConcluido + '%</div>';
    html += '</div>';
  }

  html += '<div class="diagrama-proj-gut">';
  html += '<div class="diagrama-gut-score">';
  html += '<div class="diagrama-gut-numero ' + catPrio + '">' + (valorPrio > 0 ? valorPrio : '‚Äî') + '</div>';
  html += '<div class="diagrama-gut-info"><div class="diagrama-gut-descr">Score</div>';
  html += '<div class="diagrama-gut-categoria ' + catPrio + '">' + (labelsCat[catPrio] || '‚Äî') + '</div></div>';
  html += '</div>';
  if (valorPrio > 0) {
    html += '<div class="diagrama-gut-divisor"></div>';
    html += '<div class="diagrama-gut-formula">';
    html += '<span class="gut-chip">' + (proj.tipo || 'Tipo') + '</span><span class="gut-op">√ó</span>';
    html += '<span class="gut-chip">' + (proj.paraQuem || 'Para Quem') + '</span><span class="gut-op">√ó</span>';
    html += '<span class="gut-chip">' + (proj.gravidade ? proj.gravidade.split(' - ')[0] : 'Gravidade') + '</span><span class="gut-op">√ó</span>';
    html += '<span class="gut-chip">' + (proj.urgencia ? proj.urgencia.split(' - ')[0] : 'Urg√™ncia') + '</span><span class="gut-op">=</span>';
    html += '<strong class="gut-resultado">' + valorPrio + '</strong>';
    html += '</div>';
  } else {
    html += '<div class="diagrama-gut-formula" style="font-style:italic;color:#c0b0a0;">Clique em <i class="fas fa-calculator" style="margin:0 3px;"></i> no card do projeto para calcular a prioridade</div>';
  }
  html += '</div>';

  html += '<div class="diagrama-proj-rodape">';
  if (respsObj.length > 0) {
    html += '<span class="diagrama-proj-resp-label"><i class="fas fa-users"></i> Respons√°veis</span>';
    html += '<div class="resp-avatar-group">';
    respsObj.slice(0, 5).forEach(function(r) {
      html += '<div class="resp-avatar" title="' + r.nome + '">' + gerarIniciais(r.nome) + '</div>';
    });
    html += '</div>';
    html += '<span class="resp-avatar-nomes">' + respsObj.map(function(r) { return r.nome; }).join(', ') + '</span>';
  } else {
    html += '<span style="font-size:0.78rem;color:#c0b0a0;font-style:italic;"><i class="fas fa-user-slash"></i> Sem respons√°veis</span>';
  }
  if (proj.link) {
    html += '<a href="' + proj.link + '" target="_blank" class="btn-link-documentos" style="margin-left:auto;"><i class="fas fa-folder-open"></i> Documentos</a>';
  }
  html += '</div>';
  html += '</div>'; // /diagrama-proj-card

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  LISTA DE ATIVIDADES (PLANA)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if (etapasDoProjeto.length === 0) {
    html += '<div class="atividades-empty-proj">' +
      '<i class="fas fa-clipboard-list"></i>' +
      '<p>Nenhuma atividade cadastrada</p>' +
      '<button class="btn-acao" onclick="novaAtividade()" style="margin-top:10px;font-size:0.8rem;padding:7px 14px;">' +
        '<i class="fas fa-plus"></i> Adicionar Primeira Atividade' +
      '</button>' +
    '</div>';
  } else {
    html += renderizarToolbarAtividades(etapasDoProjeto);

    var filtro      = ESTADO.filtroStatusAtividades || 'todos';
    var termoBusca  = (ESTADO.textoBuscaAtividades  || '').toLowerCase().trim();
    var ordenacao   = ESTADO.ordenacaoAtividades    || 'manual';
    var isDraggable = (ordenacao === 'manual') && !termoBusca && (filtro === 'todos');

    var atividadesFiltradas = etapasDoProjeto.slice();

    if (filtro !== 'todos') {
      atividadesFiltradas = atividadesFiltradas.filter(function(a) { return (a.status || 'A Fazer') === filtro; });
    }
    if (termoBusca) {
      atividadesFiltradas = atividadesFiltradas.filter(function(a) {
        return (a.nome      || '').toLowerCase().includes(termoBusca) ||
               (a.oQueFazer || '').toLowerCase().includes(termoBusca);
      });
    }
    if (ordenacao === 'nome-az') {
      atividadesFiltradas.sort(function(a, b) { return a.nome.localeCompare(b.nome, 'pt-BR'); });
    } else if (ordenacao === 'nome-za') {
      atividadesFiltradas.sort(function(a, b) { return b.nome.localeCompare(a.nome, 'pt-BR'); });
    } else if (ordenacao === 'status') {
      var ordemStatus = { 'Em Andamento': 0, 'A Fazer': 1, 'Aguardando Setor': 2, 'Conclu√≠da': 3 };
      atividadesFiltradas.sort(function(a, b) {
        return (ordemStatus[a.status] || 9) - (ordemStatus[b.status] || 9);
      });
    }

    html += '<div class="arvore-filhos-novo" id="arvoreAtividades">';

    if (atividadesFiltradas.length === 0) {
      var msgVazia = termoBusca
        ? 'Nenhuma atividade encontrada para "<strong>' + ESTADO.textoBuscaAtividades + '</strong>"'
        : 'Nenhuma atividade com este status';
      html += '<div class="empty-state" style="padding:20px;">' +
        '<i class="fas fa-' + (termoBusca ? 'search' : 'filter') + '" style="font-size:1.6rem;color:#c0b0a0;"></i>' +
        '<p style="margin-top:10px;font-size:0.82rem;">' + msgVazia + '</p>' +
        (termoBusca ? '<button class="btn-acao-pequeno" onclick="limparBuscaAtividades()" style="margin-top:8px;">Limpar busca</button>' : '') +
        '</div>';
    } else {
      atividadesFiltradas.forEach(function(atividade, idx) {
        html += renderizarAtividade(atividade, etapasDoProjeto, idx, isDraggable);
      });
    }

    html += '</div>'; // /arvoreAtividades
  }

  html += '</div>'; // /arvore-raiz
  container.innerHTML = html;
  configurarDragDropAtividades();
  sincronizarModoFoco();
}

/**
 * Gera o HTML da toolbar completa das atividades:
 * busca, ordena√ß√£o, filtros de status, contador, salvar ordem
 */
function renderizarToolbarAtividades(todasAtividades) {
  var filtroAtivo    = ESTADO.filtroStatusAtividades || 'todos';
  var termoBusca     = ESTADO.textoBuscaAtividades   || '';
  var ordenacaoAtiva = ESTADO.ordenacaoAtividades    || 'manual';

  // Contagens por status
  var contadores = { todos: todasAtividades.length };
  todasAtividades.forEach(function(a) {
    var s = a.status || 'A Fazer';
    contadores[s] = (contadores[s] || 0) + 1;
  });

  // Qtd exibida com filtros
  var termoBuscaNorm = termoBusca.toLowerCase();
  var qtdExibida = todasAtividades.filter(function(a) {
    var passaStatus = filtroAtivo === 'todos' || (a.status || 'A Fazer') === filtroAtivo;
    var passaBusca  = !termoBusca || (a.nome || '').toLowerCase().includes(termoBuscaNorm);
    return passaStatus && passaBusca;
  }).length;

  var html = '<div class="atividades-toolbar">';

  // ‚îÄ‚îÄ Linha 1: Busca + Ordena√ß√£o + Expandir + Salvar Ordem ‚îÄ‚îÄ
  html += '<div class="atividades-toolbar-linha1">';

  // Campo de busca
  html += '<div class="campo-busca-atv ' + (termoBusca ? 'com-valor' : '') + '">' +
    '<i class="fas fa-search icone-busca-atv"></i>' +
    '<input type="text" id="campoBuscaAtividades" placeholder="Buscar atividade por nome..." ' +
      'value="' + termoBusca.replace(/"/g, '&quot;') + '" ' +
      'oninput="buscarAtividades(this.value)">' +
    (termoBusca
      ? '<button class="btn-limpar-busca-atv" onclick="limparBuscaAtividades()" title="Limpar busca"><i class="fas fa-times"></i></button>'
      : '') +
  '</div>';

  // Modos de ordena√ß√£o
  var modoOrdenacao = [
    { valor: 'manual',  icone: 'arrows-alt-v',     titulo: 'Arrastar para ordenar manualmente' },
    { valor: 'status',  icone: 'layer-group',       titulo: 'Ordenar por status' },
    { valor: 'nome-az', icone: 'sort-alpha-down',   titulo: 'Nome A ‚Üí Z' },
    { valor: 'nome-za', icone: 'sort-alpha-up-alt', titulo: 'Nome Z ‚Üí A' }
  ];
  html += '<div class="atividades-ordenacao-grupo">';
  modoOrdenacao.forEach(function(op) {
    html += '<button class="btn-ord-atv ' + (ordenacaoAtiva === op.valor ? 'ativo' : '') + '" ' +
      'onclick="alternarOrdenacao(\'' + op.valor + '\')" title="' + op.titulo + '">' +
      '<i class="fas fa-' + op.icone + '"></i></button>';
  });
  html += '</div>';

  // Expandir/Recolher todas
  var todasExp = ESTADO.todasAtividadesExpandidas;
  html += '<button class="btn-expandir-todas-atv" onclick="alternarExpandirTodas()" ' +
    'title="' + (todasExp ? 'Recolher Todas' : 'Expandir Todas') + '">' +
    '<i class="fas fa-' + (todasExp ? 'compress-alt' : 'expand-alt') + '"></i>' +
  '</button>';

  // Bot√£o salvar ordem (s√≥ aparece com altera√ß√£o pendente)
  html += '<button class="btn-salvar-ordem-atv" id="btnSalvarOrdemAtividades" ' +
    'onclick="salvarOrdemAtividades()" ' +
    'style="display:' + (ESTADO.ordemAtividadesModificada ? 'inline-flex' : 'none') + ';" ' +
    'title="Salvar ordem na planilha">' +
    '<i class="fas fa-cloud-upload-alt"></i> <span>Salvar Ordem</span>' +
  '</button>';

  html += '</div>'; // /toolbar-linha1

  // ‚îÄ‚îÄ Linha 2: Filtros de status + Contador ‚îÄ‚îÄ
  html += '<div class="atividades-toolbar-linha2">';

  var opcoesFiltro = [
    { valor: 'todos',            label: 'Todas',        icone: 'th-list',        classe: 'todos' },
    { valor: 'A Fazer',          label: 'A Fazer',      icone: 'circle',         classe: 'afazer' },
    { valor: 'Em Andamento',     label: 'Andamento',    icone: 'spinner',        classe: 'andamento' },
    { valor: 'Aguardando Setor', label: 'Aguardando',   icone: 'hourglass-half', classe: 'aguardando' },
    { valor: 'Conclu√≠da',        label: 'Conclu√≠das',   icone: 'check-circle',   classe: 'concluida' }
  ];

  html += '<div class="atividades-filtros-chips">';
  opcoesFiltro.forEach(function(op) {
    var qtd = op.valor === 'todos' ? todasAtividades.length : (contadores[op.valor] || 0);
    if (op.valor !== 'todos' && qtd === 0) return;
    html += '<button class="btn-filtro-status ' + op.classe + ' ' + (filtroAtivo === op.valor ? 'ativo' : '') + '" ' +
      'onclick="filtrarAtividades(\'' + op.valor + '\')">' +
      '<i class="fas fa-' + op.icone + '"></i> ' + op.label +
      '<span class="filtro-qtd">' + qtd + '</span>' +
    '</button>';
  });
  html += '</div>';

  // Indicador de ordena√ß√£o ativa
  if (ordenacaoAtiva === 'manual') {
    html += '<span class="atividades-dica-drag"><i class="fas fa-hand-pointer"></i> Arraste para reordenar</span>';
  }

  // Contador
  var totalTexto   = todasAtividades.length + ' atividade' + (todasAtividades.length !== 1 ? 's' : '');
  var exibidoTexto = qtdExibida === todasAtividades.length ? totalTexto : qtdExibida + ' de ' + totalTexto;

  html += '<span class="atividades-contador">' +
    '<i class="fas fa-tasks"></i> ' + exibidoTexto +
  '</span>';

  html += '</div>'; // /toolbar-linha2
  html += '</div>'; // /atividades-toolbar

  return html;
}

function sincronizarModoFoco() {
  if (!ESTADO.modoFocoAberto) return;
  var body   = document.getElementById('modoFocoBody');
  var origem = document.getElementById('diagramaArvore');
  if (!body || !origem) return;

  var scrollAntes = body.scrollTop;
  body.innerHTML  = origem.innerHTML;
  body.scrollTop  = scrollAntes;

  // Re-aplica drag & drop dentro do Modo Foco
  configurarDragDropAtividadesFoco(body);
}

/** Alterna a visibilidade do grid de m√©tricas detalhadas no card do projeto */
function alternarExpansaoDiagrama(event) {
  if (event) event.stopPropagation();
  ESTADO.projetoExpandidoDiagrama = !ESTADO.projetoExpandidoDiagrama;

  // Toggle no wrapper de m√©tricas (sem re-renderizar tudo)
  var wrapper = document.querySelector('.diagrama-proj-metricas-wrapper');
  if (wrapper) wrapper.classList.toggle('visivel', ESTADO.projetoExpandidoDiagrama);

  // Toggle visual do bot√£o
  var btn = document.querySelector('.btn-diagrama.expandir-metricas');
  if (btn) {
    btn.classList.toggle('ativo', ESTADO.projetoExpandidoDiagrama);
    btn.title = ESTADO.projetoExpandidoDiagrama ? 'Recolher detalhes' : 'Expandir detalhes';
  }

  // Sincronizar Modo Foco se estiver aberto
  var wrapperFoco = document.querySelector('#modoFocoBody .diagrama-proj-metricas-wrapper');
  if (wrapperFoco) wrapperFoco.classList.toggle('visivel', ESTADO.projetoExpandidoDiagrama);
}

/** Abre o Modo Foco com o projeto selecionado em overlay fullscreen */
function abrirModoFoco() {
  if (!ESTADO.projeto || !ESTADO.projeto.id) {
    mostrarToast('Selecione um projeto primeiro', 'aviso');
    return;
  }

  var overlay = document.getElementById('modalModoFoco');
  var titulo  = document.getElementById('modoFocoTitulo');
  if (!overlay) return;

  ESTADO.modoFocoAberto = true;

  if (titulo) titulo.textContent = ESTADO.projeto.nome;

  overlay.classList.add('visivel');
  document.body.style.overflow = 'hidden';

  // Sincroniza o conte√∫do ap√≥s abrir (renderizarDiagrama j√° chama sincronizarModoFoco no final)
  renderizarDiagrama();
}

/** Fecha o Modo Foco */
function fecharModoFoco() {
  ESTADO.modoFocoAberto = false;
  var overlay = document.getElementById('modalModoFoco');
  if (overlay) overlay.classList.remove('visivel');
  document.body.style.overflow = '';
}

/** Abre modal de nova atividade a partir do Modo Foco */
function novaAtividadeModoFoco() {
  novaAtividade();
}

/** Configura drag & drop dentro do Modo Foco (opcional, sem salvar ordem) */
function configurarDragDropAtividadesFoco(containerPai) {
  if (!containerPai) return;

  var container = containerPai.querySelector('#arvoreAtividades');
  if (!container) return;

  var itens = container.querySelectorAll(':scope > .atividade-node[draggable="true"]');
  if (itens.length === 0) return;

  itens.forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      e.stopPropagation();
      item.classList.add('arrastando');
      e.dataTransfer.setData('text/plain', item.dataset.atividadeId);
      e.dataTransfer.effectAllowed = 'move';
    });

    item.addEventListener('dragend', function() {
      item.classList.remove('arrastando');
      container.querySelectorAll('.atividade-node.drag-over').forEach(function(el) {
        el.classList.remove('drag-over');
      });
    });

    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var itemArrastando = container.querySelector('.arrastando');
      if (itemArrastando && itemArrastando !== item) {
        item.classList.add('drag-over');
      }
    });

    item.addEventListener('dragleave', function(e) {
      if (!item.contains(e.relatedTarget)) {
        item.classList.remove('drag-over');
      }
    });

    item.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      item.classList.remove('drag-over');

      var idOrigem  = e.dataTransfer.getData('text/plain');
      var idDestino = item.dataset.atividadeId;
      if (!idOrigem || !idDestino || idOrigem === idDestino) return;

      // Aplicar a reordena√ß√£o no DOM principal (fonte da verdade)
      var containerPrincipal = document.querySelector('#diagramaArvore #arvoreAtividades');
      if (!containerPrincipal) return;

      var itemOrigemPrincipal  = containerPrincipal.querySelector(':scope > .atividade-node[data-atividade-id="' + idOrigem + '"]');
      var itemDestinoPrincipal = containerPrincipal.querySelector(':scope > .atividade-node[data-atividade-id="' + idDestino + '"]');
      if (!itemOrigemPrincipal || !itemDestinoPrincipal) return;

      var rect = item.getBoundingClientRect();
      if (e.clientY < rect.top + rect.height / 2) {
        containerPrincipal.insertBefore(itemOrigemPrincipal, itemDestinoPrincipal);
      } else {
        containerPrincipal.insertBefore(itemOrigemPrincipal, itemDestinoPrincipal.nextSibling);
      }

      // Sincroniza ESTADO.etapas com a nova ordem
      var nosAtuais = containerPrincipal.querySelectorAll(':scope > .atividade-node[data-atividade-id]');
      var idsNovosOrdem = Array.from(nosAtuais).map(function(n) { return n.dataset.atividadeId; });

      var etapasRaizOrdenadas = [];
      idsNovosOrdem.forEach(function(id) {
        var et = ESTADO.etapas.find(function(e) { return e.id === id; });
        if (et) etapasRaizOrdenadas.push(et);
      });
      var etapasNaoRaiz = ESTADO.etapas.filter(function(e) {
        return e.etapaPaiId && e.etapaPaiId !== '';
      });
      ESTADO.etapas = etapasRaizOrdenadas.concat(etapasNaoRaiz);

      ESTADO.ordemAtividadesModificada = true;

      // Re-sincroniza o Modo Foco para refletir a nova ordem
      sincronizarModoFoco();

      var btnSalvar = document.getElementById('btnSalvarOrdemAtividades');
      if (btnSalvar) btnSalvar.style.display = 'inline-flex';
    });
  });
}

function renderizarAtividade(atividade, todasAtividades, idx, isDraggable) {
  var classeStatus  = obterClasseStatus(atividade.status);
  var estaConcluida = atividade.status === 'Conclu√≠da';
  var respsObj      = obterNomesResponsaveis(atividade.responsaveisIds || []);
  var expandido     = ESTADO.detalhesExpandidos[atividade.id] || ESTADO.todasAtividadesExpandidas;

  var html = '<div class="atividade-node' +
    (estaConcluida ? ' atividade-concluida' : '') +
    '" data-atividade-id="' + atividade.id + '" ' +
    (isDraggable ? 'draggable="true"' : '') + '>';

  html += '<div class="atividade-card">';

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  html += '<div class="atividade-card-header">';

  // N√∫mero de ordem + handle de drag
  if (isDraggable) {
    html += '<div class="atividade-ordem-drag" title="Arrastar para reordenar">' +
      '<span class="atividade-numero">' + (idx + 1) + '</span>' +
      '<i class="fas fa-grip-vertical atividade-drag-handle"></i>' +
    '</div>';
  } else {
    html += '<span class="atividade-numero-fixo">' + (idx + 1) + '</span>';
  }

  // Bot√£o checklist
  html += '<button class="btn-checklist ' + (estaConcluida ? 'concluida' : '') + '" ' +
    'onclick="alternarConclusaoAtividade(\'' + atividade.id + '\', event)" ' +
    'title="' + (estaConcluida ? 'Desmarcar conclus√£o' : 'Marcar como conclu√≠da') + '">' +
    '<i class="fas fa-' + (estaConcluida ? 'check-circle' : 'circle') + '"></i>' +
  '</button>';

  // Conte√∫do principal
  html += '<div class="atividade-card-titulo-area">';
  html += '<div class="atividade-card-titulo' + (estaConcluida ? ' riscado' : '') + '">' + atividade.nome + '</div>';

  // Badges: status + respons√°veis
  html += '<div class="atividade-card-badges">';

  // Badge status clic√°vel
  html += '<span class="badge badge-' + classeStatus + ' badge-status-clicavel" ' +
    'onclick="ciclarStatusAtividade(\'' + atividade.id + '\', event)" ' +
    'title="Clique para alterar o status">' +
    '<i class="fas fa-' + obterIconeStatus(atividade.status) + '"></i> ' +
    (atividade.status || 'A Fazer') + '</span>';

  // Respons√°veis como avatars
  if (respsObj.length > 0) {
    html += '<span class="atividade-resp-avatar-group">';
    respsObj.slice(0, 3).forEach(function(r) {
      html += '<span class="atividade-resp-avatar" title="' + r.nome + '">' + gerarIniciais(r.nome) + '</span>';
    });
    if (respsObj.length > 3) {
      html += '<span class="atividade-resp-avatar mais" title="' + respsObj.slice(3).map(function(r){return r.nome;}).join(', ') + '">+' + (respsObj.length - 3) + '</span>';
    }
    html += '</span>';
  } else {
    html += '<span class="atividade-sem-resp" title="Sem respons√°vel"><i class="fas fa-user-slash"></i></span>';
  }

  html += '</div>'; // /badges
  html += '</div>'; // /titulo-area

  // Bot√µes de a√ß√£o
  html += '<div class="atividade-card-acoes">';
  // Bot√£o expandir/recolher (s√≥ se tem oQueFazer)
  if (atividade.oQueFazer && atividade.oQueFazer.trim()) {
    html += '<button class="btn-acao-icone btn-expandir-atv ' + (expandido ? 'ativo' : '') + '" ' +
      'onclick="alternarDetalhesAtividade(\'' + atividade.id + '\', event)" ' +
      'title="' + (expandido ? 'Recolher' : 'Expandir') + '">' +
      '<i class="fas fa-chevron-' + (expandido ? 'up' : 'down') + '"></i></button>';
  }
  html += '<button class="btn-acao-icone" onclick="abrirModalEdicao(\'etapa\', \'' + atividade.id + '\')" title="Editar atividade">' +
    '<i class="fas fa-edit"></i></button>';
  html += '<button class="btn-acao-icone btn-acao-perigo" onclick="excluirEtapa(\'' + atividade.id + '\')" title="Excluir atividade">' +
    '<i class="fas fa-times"></i></button>';
  html += '</div>'; // /acoes

  html += '</div>'; // /atividade-card-header

  // ‚îÄ‚îÄ Conte√∫do expand√≠vel: "O Que Fazer" (SEM "Ver detalhes" toggle) ‚îÄ‚îÄ
  if (atividade.oQueFazer && atividade.oQueFazer.trim()) {
    html += '<div class="atividade-conteudo-corpo' + (expandido ? ' visivel' : '') + '" id="detalhes-' + atividade.id + '">' +
      '<div class="atividade-oQueFazer">' +
        '<i class="fas fa-list-ul"></i>' +
        '<span>' + atividade.oQueFazer + '</span>' +
      '</div>' +
    '</div>';
  }

  html += '</div>'; // /atividade-card
  html += '</div>'; // /atividade-node
  return html;
}

// ========================= CHECKLIST DE ATIVIDADES =========================

function alternarConclusaoAtividade(atividadeId, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }

  var atividade = ESTADO.etapas.find(function(e) { return e.id === atividadeId; });
  if (!atividade || !ESTADO.projeto) return;

  var statusAnterior = atividade.status || 'A Fazer';
  var novoStatus;

  if (statusAnterior === 'Conclu√≠da') {
    // Desfazer: volta ao status salvo no mapa, ou 'A Fazer' como fallback
    novoStatus = ESTADO.statusAnteriorAtividades[atividadeId] || 'A Fazer';
    delete ESTADO.statusAnteriorAtividades[atividadeId];
  } else {
    // Marcar como conclu√≠da: salva o status atual para poder desfazer
    ESTADO.statusAnteriorAtividades[atividadeId] = statusAnterior;
    novoStatus = 'Conclu√≠da';
  }

  // Atualiza localmente de imediato (UX responsivo)
  atividade.status = novoStatus;
  renderizarDiagrama();

  // Montar objeto completo para salvar (mesmo formato do modal de edi√ß√£o)
  var dadosParaSalvar = {
    id:              atividade.id,
    projetoId:       atividade.projetoId || ESTADO.projeto.id,
    nome:            atividade.nome      || '',
    oQueFazer:       atividade.oQueFazer || '',
    status:          novoStatus,
    responsaveisIds: atividade.responsaveisIds || []
  };
  // Persistir no backend (segundo plano, sem tela de carregamento)
  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (res.sucesso) {
          // Sucesso silencioso ‚Äî j√° atualizamos a tela antes
          var textoAcao = novoStatus === 'Conclu√≠da' ? 'conclu√≠da' : 'reaberta';
          mostrarToast('Atividade ' + textoAcao + '!', 'sucesso');
        } else {
          // Rollback completo em caso de erro do servidor
          rollbackChecklist(atividade, atividadeId, statusAnterior, novoStatus);
          mostrarToast('Erro ao salvar: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(erro) {
        // Rollback completo em caso de falha de rede/servidor
        rollbackChecklist(atividade, atividadeId, statusAnterior, novoStatus);
        mostrarToast('Erro de conex√£o: ' + erro, 'erro');
      })
      .salvarEtapaCompleta(dadosParaSalvar);
  }
}

function rollbackChecklist(atividade, atividadeId, statusAnterior, novoStatusQuefalhou) {
  // Reverter para o status que estava ANTES do clique
  atividade.status = statusAnterior;

  if (novoStatusQuefalhou === 'Conclu√≠da') {
    // Tentamos concluir e falhou ‚Üí remove o registro do mapa
    delete ESTADO.statusAnteriorAtividades[atividadeId];
  } else {
    // Tentamos desfazer e falhou ‚Üí restaura o registro no mapa
    ESTADO.statusAnteriorAtividades[atividadeId] = novoStatusQuefalhou;
  }

  renderizarDiagrama();
}

function filtrarAtividades(status) {
  ESTADO.filtroStatusAtividades = status;
  renderizarDiagrama(); // ‚Üê apenas o diagrama, nunca atualizarTodosComponentes()
}

function alternarDetalhesAtividade(atividadeId, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }
  ESTADO.detalhesExpandidos[atividadeId] = !ESTADO.detalhesExpandidos[atividadeId];
  renderizarDiagrama();
}

function excluirEtapa(atividadeId) {
  confirmarExcluirAtividade(atividadeId);
}

// ========================= DRAG & DROP ATIVIDADES =========================
function configurarDragDropAtividades() {
  var container = document.getElementById('arvoreAtividades');
  if (!container) return;

  var itens = container.querySelectorAll(':scope > .atividade-node[draggable="true"]');
  if (itens.length === 0) return;

  itens.forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      e.stopPropagation();
      item.classList.add('arrastando');
      e.dataTransfer.setData('text/plain', item.dataset.atividadeId);
      e.dataTransfer.effectAllowed = 'move';
    });

    item.addEventListener('dragend', function() {
      item.classList.remove('arrastando');
      container.querySelectorAll('.atividade-node.drag-over').forEach(function(el) {
        el.classList.remove('drag-over');
      });
    });

    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var itemArrastando = container.querySelector('.arrastando');
      if (itemArrastando && itemArrastando !== item) {
        item.classList.add('drag-over');
      }
    });

    item.addEventListener('dragleave', function(e) {
      if (!item.contains(e.relatedTarget)) {
        item.classList.remove('drag-over');
      }
    });

    item.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      item.classList.remove('drag-over');

      var idOrigem  = e.dataTransfer.getData('text/plain');
      var idDestino = item.dataset.atividadeId;
      if (!idOrigem || !idDestino || idOrigem === idDestino) return;

      var itemOrigem = container.querySelector(':scope > .atividade-node[data-atividade-id="' + idOrigem + '"]');
      if (!itemOrigem) return;

      // Inserir acima ou abaixo do alvo com base na posi√ß√£o do mouse
      var rect = item.getBoundingClientRect();
      if (e.clientY < rect.top + rect.height / 2) {
        container.insertBefore(itemOrigem, item);
      } else {
        container.insertBefore(itemOrigem, item.nextSibling);
      }

      // ‚îÄ‚îÄ Sincroniza ESTADO.etapas com a nova ordem do DOM ‚îÄ‚îÄ
      var nosAtuais = container.querySelectorAll(':scope > .atividade-node[data-atividade-id]');
      var idsNovosOrdem = Array.from(nosAtuais).map(function(n) { return n.dataset.atividadeId; });

      var etapasRaizOrdenadas = [];
      idsNovosOrdem.forEach(function(id) {
        var et = ESTADO.etapas.find(function(e) { return e.id === id; });
        if (et) etapasRaizOrdenadas.push(et);
      });
      var etapasNaoRaiz = ESTADO.etapas.filter(function(e) {
        return e.etapaPaiId && e.etapaPaiId !== '';
      });
      ESTADO.etapas = etapasRaizOrdenadas.concat(etapasNaoRaiz);

      // Marca altera√ß√£o pendente e exibe o bot√£o Salvar
      ESTADO.ordemAtividadesModificada = true;
      var btnSalvar = document.getElementById('btnSalvarOrdemAtividades');
      if (btnSalvar) {
        btnSalvar.style.display = 'inline-flex';
      }
    });
  });
}

/**
 * Salva a ordem atual das atividades raiz na planilha via Prioridades.
 * L√™ a ordem de ESTADO.etapas (sincronizado pelo drag & drop).
 */
function salvarOrdemAtividades() {
  if (!ESTADO.projeto || !ESTADO.projeto.id) return;

  var atividadesRaiz = ESTADO.etapas.filter(function(e) {
    return e.projetoId === ESTADO.projeto.id && (!e.etapaPaiId || e.etapaPaiId === '');
  });
  var idsOrdenados = atividadesRaiz.map(function(e) { return e.id; });

  if (idsOrdenados.length === 0) return;

  var btn = document.getElementById('btnSalvarOrdemAtividades');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Salvando...</span>'; }

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (btn) {
          btn.disabled  = false;
          btn.innerHTML = '<i class="fas fa-save"></i> <span>Salvar Ordem</span>';
        }
        if (res.sucesso) {
          ESTADO.ordemAtividadesModificada = false;
          if (btn) btn.style.display = 'none';
          mostrarToast('Ordem das atividades salva!', 'sucesso');
        } else {
          mostrarToast('Erro ao salvar ordem: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        if (btn) {
          btn.disabled  = false;
          btn.innerHTML = '<i class="fas fa-save"></i> <span>Salvar Ordem</span>';
        }
        mostrarToast('Erro: ' + e, 'erro');
      })
      .salvarOrdemAtividades(ESTADO.projeto.id, idsOrdenados);
  } else {
    // Demo / ambiente sem Google
    setTimeout(function() {
      if (btn) { btn.disabled = false; btn.style.display = 'none'; }
      ESTADO.ordemAtividadesModificada = false;
      mostrarToast('Ordem salva! (demo)', 'sucesso');
    }, 600);
  }
}

// Timer para debounce da busca
var _timerBuscaAtv = null;

/** Filtra atividades em tempo real pelo nome (debounce 150ms) */
function buscarAtividades(valor) {
  ESTADO.textoBuscaAtividades = valor || '';
  clearTimeout(_timerBuscaAtv);
  _timerBuscaAtv = setTimeout(function() {
    renderizarDiagrama();
    // Restaurar foco + posi√ß√£o do cursor ap√≥s re-render
    var campo = document.getElementById('campoBuscaAtividades');
    if (campo) {
      campo.focus();
      var pos = campo.value.length;
      campo.setSelectionRange(pos, pos);
    }
  }, 150);
}

/** Limpa o campo de busca */
function limparBuscaAtividades() {
  ESTADO.textoBuscaAtividades = '';
  renderizarDiagrama();
}

/**
 * Altera o modo de ordena√ß√£o das atividades.
 * Se clicar no modo j√° ativo, volta para 'manual'.
 */
function alternarOrdenacao(modo) {
  if (ESTADO.ordenacaoAtividades === modo && modo !== 'manual') {
    ESTADO.ordenacaoAtividades = 'manual';
  } else {
    ESTADO.ordenacaoAtividades = modo;
  }
  renderizarDiagrama();
}

function alternarExpandirTodas() {
  ESTADO.todasAtividadesExpandidas = !ESTADO.todasAtividadesExpandidas;
  
  // Aplica a todos os IDs de atividades do projeto atual
  ESTADO.etapas.forEach(function(e) {
    if (e.projetoId === (ESTADO.projeto && ESTADO.projeto.id)) {
      ESTADO.detalhesExpandidos[e.id] = ESTADO.todasAtividadesExpandidas;
    }
  });
  
  renderizarDiagrama();
}

/**
 * Cicla o status da atividade ao clicar no badge:
 * A Fazer ‚Üí Em Andamento ‚Üí Aguardando Setor ‚Üí Conclu√≠da ‚Üí A Fazer
 */
function ciclarStatusAtividade(atividadeId, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }

  var atividade = ESTADO.etapas.find(function(e) { return e.id === atividadeId; });
  if (!atividade || !ESTADO.projeto) return;

  var statusAnterior = atividade.status || 'A Fazer';
  var idx            = LISTA_STATUS.indexOf(statusAnterior);
  var novoStatus     = LISTA_STATUS[(idx + 1) % LISTA_STATUS.length];

  // Atualiza localmente de imediato (UX responsivo)
  atividade.status = novoStatus;
  renderizarDiagrama();
  mostrarToast(novoStatus, 'info');

  var dadosParaSalvar = {
    id:              atividade.id,
    projetoId:       atividade.projetoId || ESTADO.projeto.id,
    nome:            atividade.nome      || '',
    oQueFazer:       atividade.oQueFazer || '',
    status:          novoStatus,
    responsaveisIds: atividade.responsaveisIds || []
  };

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (!res.sucesso) {
          atividade.status = statusAnterior; // rollback
          renderizarDiagrama();
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function() {
        atividade.status = statusAnterior;
        renderizarDiagrama();
        mostrarToast('Erro ao salvar status', 'erro');
      })
      .salvarEtapaCompleta(dadosParaSalvar);
  }
}

// ========================= DRAG & DROP PROJETOS =========================
function iniciarArrastarProjeto(event) {
  var card = event.target.closest('.projeto-card-completo');
  if (!card) return;
  card.classList.add('arrastando');
  event.dataTransfer.setData('text/plain', card.dataset.projetoId);
  event.dataTransfer.effectAllowed = 'move';
}

function finalizarArrastarProjeto(event) {
  var card = event.target.closest('.projeto-card-completo');
  if (card) card.classList.remove('arrastando');
  document.querySelectorAll('.projeto-card-completo.drag-over').forEach(function(el) { el.classList.remove('drag-over'); });
}

function arrastarSobreProjeto(event) {
  event.preventDefault();
  var card = event.target.closest('.projeto-card-completo');
  if (card && !card.classList.contains('arrastando')) card.classList.add('drag-over');
}

function sairArrastarProjeto(event) {
  var card = event.target.closest('.projeto-card-completo');
  if (card) card.classList.remove('drag-over');
}

function soltarProjeto(event) {
  event.preventDefault();
  var cardDestino = event.target.closest('.projeto-card-completo');
  if (!cardDestino) return;
  cardDestino.classList.remove('drag-over');

  var idOrigem = event.dataTransfer.getData('text/plain');
  var idDestino = cardDestino.dataset.projetoId;
  if (idOrigem === idDestino) return;

  var container = document.getElementById('projetosCardsLista');
  var cards = Array.from(container.querySelectorAll('.projeto-card-completo'));
  var iOrigem = cards.findIndex(function(c) { return c.dataset.projetoId === idOrigem; });
  var iDestino = cards.findIndex(function(c) { return c.dataset.projetoId === idDestino; });
  if (iOrigem === -1 || iDestino === -1) return;

  var cardOrigem = cards[iOrigem];
  if (iOrigem < iDestino) {
    cardDestino.parentNode.insertBefore(cardOrigem, cardDestino.nextSibling);
  } else {
    cardDestino.parentNode.insertBefore(cardOrigem, cardDestino);
  }

  // Atualizar n√∫meros
  container.querySelectorAll('.projeto-card-completo').forEach(function(c, i) {
    var num = c.querySelector('.projeto-card-ordem');
    if (num) num.textContent = i + 1;
  });
  ESTADO.ordemProjetosModificada = true;
}

function salvarOrdemProjetos() {
  mostrarToast('Ordem salva!', 'sucesso');
  ESTADO.ordemProjetosModificada = false;
}

// ========================= MODAL EDI√á√ÉO (PROJETO / ATIVIDADE) =========================
function abrirModalEdicao(tipo, id) {
  document.getElementById('itemTipoRegistro').value = tipo;
  document.getElementById('itemId').value = id;

  document.querySelectorAll('.campos-projeto').forEach(function(el) { el.style.display = tipo === 'projeto' ? 'block' : 'none'; });
  document.querySelectorAll('.campos-etapa').forEach(function(el) { el.style.display = tipo === 'etapa' ? 'block' : 'none'; });

  if (tipo === 'projeto') {
    document.getElementById('modalTitulo').textContent = 'Editar Projeto';
    document.getElementById('modalIcon').className = 'fas fa-folder-open';

    var proj = ESTADO.listaProjetos.find(function(p) { return p.id === id; }) || ESTADO.projeto;
    if (!proj) { mostrarToast('Projeto n√£o encontrado', 'erro'); return; }

    popularSelectsModais();

    document.getElementById('itemNome').value       = proj.nome      || '';
    document.getElementById('itemDescricao').value  = proj.descricao || ''; 
    document.getElementById('itemPilar').value      = proj.pilar     || '';
    document.getElementById('itemLink').value       = proj.link  || '';
    document.getElementById('itemStatus').value     = proj.status || 'A Fazer';
    document.getElementById('itemDataInicio').value = proj.dataInicio || '';
    document.getElementById('itemDataFim').value    = proj.dataFim    || '';

    selecionarSelectPorLabel(document.getElementById('itemTipoProjeto'),    proj.tipo);
    selecionarSelectPorLabel(document.getElementById('itemParaQuem'),       proj.paraQuem);
    selecionarSelectPorLabel(document.getElementById('itemGravidade'),      proj.gravidade);
    selecionarSelectPorLabel(document.getElementById('itemUrgenciaSelect'), proj.urgencia);

    popularSelectEsforco();
    var selEsf = document.getElementById('itemEsforco');
    if (selEsf) {
      var config = ESTADO.configCalculoPrioridade;
      if (config && config.esforco && proj.esforco) {
        var opcEsf = config.esforco.opcoes.find(function(o) { return o.label.trim() === proj.esforco.trim(); });
        selEsf.value = opcEsf ? opcEsf.valor : '';
      } else {
        selEsf.value = '';
      }
    }

    var selSetor = document.getElementById('itemSetor');
    if (selSetor) { garantirOptionExiste(selSetor, proj.setor); selSetor.value = proj.setor || ''; }

    popularCheckboxesResponsaveis('itemResponsaveisContainer', proj.responsaveisIds || []);
    document.getElementById('btnExcluirItem').style.display = 'none';

  } else if (tipo === 'etapa') {
    var atividade = ESTADO.etapas.find(function(e) { return e.id === id; });
    if (!atividade) { mostrarToast('Atividade n√£o encontrada', 'erro'); return; }

    document.getElementById('modalTitulo').textContent = 'Editar Atividade';
    document.getElementById('modalIcon').className = 'fas fa-tasks';

    document.getElementById('itemNome').value      = atividade.nome      || '';
    document.getElementById('itemOQueFazer').value = atividade.oQueFazer || '';
    document.getElementById('itemStatus').value    = atividade.status    || 'A Fazer';

    popularCheckboxesResponsaveis('itemResponsaveisContainer', atividade.responsaveisIds || []);
    document.getElementById('btnExcluirItem').style.display = 'inline-flex';
  }

  abrirModal('modalEdicao');
}

function fecharModalEdicao() {
  fecharModal('modalEdicao');
}

// ========================= SALVAR ITEM =========================
function salvarItem() {
  var tipo = document.getElementById('itemTipoRegistro').value;
  var nome = document.getElementById('itemNome').value.trim();
  if (!nome) { mostrarToast('Nome √© obrigat√≥rio', 'aviso'); return; }

  if (tipo === 'projeto') salvarProjeto();
  else if (tipo === 'etapa') salvarAtividade();
}

function salvarProjeto() {
  var id = document.getElementById('itemId').value;
  var projetoExistente = ESTADO.listaProjetos.find(function(p) { return p.id === id; }) || {};

  var selTipo     = document.getElementById('itemTipoProjeto');
  var selParaQuem = document.getElementById('itemParaQuem');
  var selGrav     = document.getElementById('itemGravidade');
  var selUrg      = document.getElementById('itemUrgenciaSelect');
  var selEsf      = document.getElementById('itemEsforco');   // ‚Üê novo

  var pesoTipo      = parseInt(selTipo?.value)     || 0;
  var pesoParaQuem  = parseInt(selParaQuem?.value) || 0;
  var pesoGravidade = parseInt(selGrav?.value)     || 0;
  var pesoUrgencia  = parseInt(selUrg?.value)      || 0;
  var pesoEsforco   = parseInt(selEsf?.value)      || 0;      // ‚Üê novo

  var tipoLabel      = selTipo?.selectedIndex     > 0 ? selTipo.options[selTipo.selectedIndex].dataset.label     || selTipo.options[selTipo.selectedIndex].text : '';
  var paraQuemLabel  = selParaQuem?.selectedIndex > 0 ? selParaQuem.options[selParaQuem.selectedIndex].dataset.label || selParaQuem.options[selParaQuem.selectedIndex].text : '';
  var gravidadeLabel = selGrav?.selectedIndex     > 0 ? selGrav.options[selGrav.selectedIndex].dataset.label     || selGrav.options[selGrav.selectedIndex].text : '';
  var urgenciaLabel  = selUrg?.selectedIndex      > 0 ? selUrg.options[selUrg.selectedIndex].dataset.label      || selUrg.options[selUrg.selectedIndex].text : '';
  var esforcoLabel   = selEsf?.selectedIndex      > 0 ? selEsf.options[selEsf.selectedIndex].dataset.label      || selEsf.options[selEsf.selectedIndex].text : ''; // ‚Üê novo

  // Calcula apenas se todos os 5 campos preenchidos; sen√£o preserva valor existente
  var valorPrioridade = (pesoGravidade && pesoUrgencia && pesoTipo && pesoParaQuem && pesoEsforco)
    ? pesoGravidade * pesoUrgencia * pesoTipo * pesoParaQuem * pesoEsforco
    : projetoExistente.valorPrioridade || 0;

  var catPrio   = obterCategoriaPrioridade(valorPrioridade);
  var textoPrio = catPrio === 'alta' ? 'Alta' : catPrio === 'media' ? 'M√©dia' : 'Baixa';

  var dados = {
    id:              id,
    nome:            document.getElementById('itemNome').value.trim(),
    descricao: (document.getElementById('itemDescricao') || {value:''}).value.trim(),
    tipo:            tipoLabel,
    paraQuem:        paraQuemLabel,
    setor:           document.getElementById('itemSetor').value,
    pilar:           document.getElementById('itemPilar').value.trim(),
    link:            document.getElementById('itemLink').value.trim(),
    status:          document.getElementById('itemStatus').value,
    prioridade:      textoPrio,
    gravidade:       gravidadeLabel,
    urgencia:        urgenciaLabel,
    esforco:         esforcoLabel,                               // ‚Üê novo
    responsaveisIds: obterResponsaveisSelecionados('itemResponsaveisContainer'),
    valorPrioridade: valorPrioridade,
    dataInicio:      document.getElementById('itemDataInicio').value || '',
    dataFim:         document.getElementById('itemDataFim').value    || ''
  };

  var modalBody = document.querySelector('#modalEdicao .modal-body');
  mostrarSpinner(modalBody);

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderSpinner(modalBody);
        if (res.sucesso) {
          mostrarToast('Projeto atualizado!', 'sucesso');
          if (ESTADO.projeto && ESTADO.projeto.id === id) Object.assign(ESTADO.projeto, dados);
          var idx = ESTADO.listaProjetos.findIndex(function(p) { return p.id === id; });
          if (idx !== -1) Object.assign(ESTADO.listaProjetos[idx], dados);
          fecharModalEdicao();
          renderizarTudo();
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderSpinner(modalBody);
        mostrarToast('Erro: ' + e, 'erro');
      })
      .salvarProjetoCompleto(dados);
  } else {
    setTimeout(function() {
      esconderSpinner(modalBody);
      if (ESTADO.projeto && ESTADO.projeto.id === id) Object.assign(ESTADO.projeto, dados);
      var idx = ESTADO.listaProjetos.findIndex(function(p) { return p.id === id; });
      if (idx !== -1) Object.assign(ESTADO.listaProjetos[idx], dados);
      mostrarToast('Projeto atualizado (demo)', 'sucesso');
      fecharModalEdicao();
      renderizarTudo();
    }, 800);
  }
}

function salvarAtividade() {
  var id = document.getElementById('itemId').value;
  var dados = {
    id:              id,
    projetoId:       ESTADO.projeto.id,
    nome:            document.getElementById('itemNome').value.trim(),
    oQueFazer:       document.getElementById('itemOQueFazer').value.trim(),
    status:          document.getElementById('itemStatus').value,
    responsaveisIds: obterResponsaveisSelecionados('itemResponsaveisContainer')
  };

  if (!dados.nome) { mostrarToast('Nome √© obrigat√≥rio', 'aviso'); return; }

  var modalBody = document.querySelector('#modalEdicao .modal-body');
  mostrarSpinner(modalBody);

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderSpinner(modalBody);
        if (res.sucesso) {
          mostrarToast(id ? 'Atividade atualizada!' : 'Atividade criada!', 'sucesso');
          fecharModalEdicao();
          carregarAtividadesDoProjeto(ESTADO.projeto.id);
          recarregarDadosSemTela();
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderSpinner(modalBody);
        mostrarToast('Erro: ' + e, 'erro');
      })
      .salvarEtapaCompleta(dados);
  } else {
    setTimeout(function() {
      esconderSpinner(modalBody);
      if (id) {
        var at = ESTADO.etapas.find(function(e) { return e.id === id; });
        if (at) Object.assign(at, dados);
      } else {
        ESTADO.etapas.push(Object.assign({}, dados, { id: 'eta_demo_' + Date.now() }));
      }
      mostrarToast('Atividade salva (demo)', 'sucesso');
      fecharModalEdicao();
      renderizarDiagrama();
    }, 800);
  }
}

// ========================= NOVA ATIVIDADE =========================
function novaAtividade() {
  if (!ESTADO.projeto || !ESTADO.projeto.id) {
    mostrarToast('Selecione um projeto primeiro', 'aviso');
    return;
  }

  document.getElementById('itemTipoRegistro').value = 'etapa';
  document.getElementById('itemId').value = '';

  document.querySelectorAll('.campos-projeto').forEach(function(el) { el.style.display = 'none'; });
  document.querySelectorAll('.campos-etapa').forEach(function(el) { el.style.display = 'block'; });

  document.getElementById('modalTitulo').textContent = 'Nova Atividade';
  document.getElementById('modalIcon').className = 'fas fa-plus-circle';

  document.getElementById('itemNome').value = '';
  document.getElementById('itemOQueFazer').value = '';
  document.getElementById('itemStatus').value = 'A Fazer';

  popularCheckboxesResponsaveis('itemResponsaveisContainer', []);
  document.getElementById('btnExcluirItem').style.display = 'none';

  abrirModal('modalEdicao');
}

// Alias para manter compatibilidade com o bot√£o no HTML
function novaEtapa() { novaAtividade(); }


// ========================= EXCLUS√ÉO =========================
function confirmarExcluirItem() {
  var tipo = document.getElementById('itemTipoRegistro').value;
  var id = document.getElementById('itemId').value;
  if (tipo === 'etapa') confirmarExcluirAtividade(id);
}

function confirmarExcluirAtividade(atividadeId) {
  var at = ESTADO.etapas.find(function(e) { return e.id === atividadeId; });
  if (!at) return;

  if (!confirm('Excluir a atividade "' + at.nome + '"?\nEsta a√ß√£o n√£o pode ser desfeita.')) return;

  var containerDiagrama = document.getElementById('diagramaArvore');
  mostrarSpinner(containerDiagrama);

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderSpinner(containerDiagrama);
        if (res.sucesso) {
          mostrarToast('Atividade exclu√≠da!', 'sucesso');
          fecharModalEdicao();
          carregarAtividadesDoProjeto(ESTADO.projeto.id);
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderSpinner(containerDiagrama);
        mostrarToast('Erro: ' + e, 'erro');
      })
      .excluirEtapaCompleta(atividadeId);
  } else {
    setTimeout(function() {
      esconderSpinner(containerDiagrama);
      ESTADO.etapas = ESTADO.etapas.filter(function(e) { return e.id !== atividadeId; });
      mostrarToast('Atividade exclu√≠da (demo)', 'sucesso');
      fecharModalEdicao();
      renderizarDiagrama();
    }, 500);
  }
}

// Alias
function confirmarExcluirEtapa(id) { confirmarExcluirAtividade(id); }

// ========================= MODAL NOVO PROJETO =========================
function abrirModalNovoProjeto() {
  popularSelectsModais();

  document.getElementById('novoProjetoNome').value      = '';
  document.getElementById('novoProjetoDescricao').value = '';
  document.getElementById('novoProjetoPilar').value     = '';
  document.getElementById('novoProjetoLink').value      = '';
  if (document.getElementById('novoProjetoDataInicio')) document.getElementById('novoProjetoDataInicio').value = '';
  if (document.getElementById('novoProjetoDataFim'))    document.getElementById('novoProjetoDataFim').value    = '';

  ESTADO.novoProjetoCalculo = {
    tipoProjeto: 0, tipoProjetoLabel: '',
    paraQuem: 0,    paraQuemLabel: '',
    gravidade: 0,   gravidadeLabel: '',
    urgencia: 0,    urgenciaLabel: '',
    esforco: 0,     esforcoLabel: ''    // ‚Üê novo
  };

  renderizarOpcoesNovoProjeto('tipoProjeto',  'novoProjetoOpcoesTipo');
  renderizarOpcoesNovoProjeto('quemSolicita', 'novoProjetoOpcoesParaQuem');
  renderizarOpcoesNovoProjeto('gravidade',    'novoProjetoOpcoesGravidade');
  renderizarOpcoesNovoProjeto('urgencia',     'novoProjetoOpcoesUrgencia');
  renderizarOpcoesNovoProjeto('esforco',      'novoProjetoOpcoesEsforco');  // ‚Üê novo

  atualizarCalculoNovoProjeto();
  popularCheckboxesResponsaveis('novoProjetoResponsaveisContainer', []);
  abrirModal('modalNovoProjeto');
}

function fecharModalNovoProjeto() {
  fecharModal('modalNovoProjeto');
}

function renderizarOpcoesNovoProjeto(indicador, containerId) {
  var container = document.getElementById(containerId);
  if (!container || !ESTADO.configCalculoPrioridade) return;

  var config = ESTADO.configCalculoPrioridade[indicador];
  if (!config || !config.opcoes) { container.innerHTML = ''; return; }

  var pesos = config.opcoes.map(function(o) { return o.valor; });
  var pesoMax = Math.max.apply(null, pesos);
  var pesoMin = Math.min.apply(null, pesos);
  var amplitude = pesoMax - pesoMin || 1;

  var html = '';
  config.opcoes.forEach(function(op) {
    var proporcao    = (op.valor - pesoMin) / amplitude;
    var tamanhoFonte = (0.68 + proporcao * 0.14).toFixed(2) + 'rem';
    var opacidade    = (0.5 + proporcao * 0.5).toFixed(2);
    var pesoBorda    = proporcao > 0.6 ? '2px' : '1px';
    var corValor     = obterCorPeso(op.valor, pesoMax);
    var tamBadge     = Math.round(16 + proporcao * 6);

    html += '<label class="indicador-opcao-compact" ' +
      'style="opacity:' + opacidade + ';font-size:' + tamanhoFonte + ';border-width:' + pesoBorda + ';" ' +
      'onclick="selecionarIndicadorNovoProjeto(\'' + indicador + '\', ' + op.valor + ', \'' + op.label.replace(/'/g, "\\'") + '\', this)">' +
      '<input type="radio" name="novoProjeto_' + indicador + '" value="' + op.valor + '">' +
      '<span class="opcao-valor" style="background:' + corValor + ';width:' + tamBadge + 'px;height:' + tamBadge + 'px;font-size:' + (0.62 + proporcao * 0.12).toFixed(2) + 'rem;">' +
        op.valor +
      '</span>' +
      '<span class="opcao-label">' + op.label + '</span>' +
      '</label>';
  });
  container.innerHTML = html;
}

function selecionarIndicadorNovoProjeto(indicador, valor, label, elemento) {
  var mapa = {
    'tipoProjeto':  { campo: 'tipoProjeto', campoLabel: 'tipoProjetoLabel' },
    'quemSolicita': { campo: 'paraQuem',    campoLabel: 'paraQuemLabel'    },
    'gravidade':    { campo: 'gravidade',   campoLabel: 'gravidadeLabel'   },
    'urgencia':     { campo: 'urgencia',    campoLabel: 'urgenciaLabel'    },
    'esforco':      { campo: 'esforco',     campoLabel: 'esforcoLabel'     }  // ‚Üê novo
  };

  var cfg = mapa[indicador];
  if (cfg) {
    ESTADO.novoProjetoCalculo[cfg.campo]       = valor;
    ESTADO.novoProjetoCalculo[cfg.campoLabel]  = label;
  }

  var cont = elemento.closest('.indicador-opcoes-horizontal');
  cont.querySelectorAll('.indicador-opcao-compact').forEach(function(op) { op.classList.remove('selecionado'); });
  elemento.classList.add('selecionado');

  atualizarCalculoNovoProjeto();
}

function atualizarCalculoNovoProjeto() {
  var c = ESTADO.novoProjetoCalculo;
  var valor = c.tipoProjeto * c.paraQuem * c.gravidade * c.urgencia * c.esforco; // ‚Üê atualizado

  document.getElementById('novoProjetoFormulaT').textContent = c.tipoProjeto || 'T';
  document.getElementById('novoProjetoFormulaQ').textContent = c.paraQuem    || 'Q';
  document.getElementById('novoProjetoFormulaG').textContent = c.gravidade   || 'G';
  document.getElementById('novoProjetoFormulaU').textContent = c.urgencia    || 'U';
  document.getElementById('novoProjetoFormulaE').textContent = c.esforco     || 'E'; // ‚Üê novo
  document.getElementById('novoProjetoFormulaResultado').textContent = valor;
  document.getElementById('novoProjetoValorCalculado').textContent = valor;

  var cat   = obterCategoriaPrioridade(valor);
  var catEl = document.getElementById('novoProjetoCategoriaCalculada');
  catEl.className = 'calculo-resultado-categoria-compact ' + cat;

  if (valor === 0)           catEl.textContent = 'Preencha os indicadores';
  else if (cat === 'alta')   catEl.textContent = 'üî¥ ALTA';
  else if (cat === 'media')  catEl.textContent = 'üü° M√âDIA';
  else                       catEl.textContent = 'üü¢ BAIXA';
}

function salvarNovoProjeto() {
  var nome = document.getElementById('novoProjetoNome').value.trim();
  if (!nome) { mostrarToast('Nome √© obrigat√≥rio', 'erro'); return; }

  var c = ESTADO.novoProjetoCalculo;
  var valorPrioridade = c.tipoProjeto * c.paraQuem * c.gravidade * c.urgencia * c.esforco; // ‚Üê atualizado
  var catPrio   = obterCategoriaPrioridade(valorPrioridade);
  var textoPrio = catPrio === 'alta' ? 'Alta' : catPrio === 'media' ? 'M√©dia' : 'Baixa';

  var dados = {
    nome:            nome,
    descricao:       document.getElementById('novoProjetoDescricao').value.trim(),
    setor:           document.getElementById('novoProjetoSetor').value,
    pilar:           document.getElementById('novoProjetoPilar').value.trim(),
    link:            document.getElementById('novoProjetoLink').value.trim(),
    status:          'A Fazer',
    tipo:            c.tipoProjetoLabel || '',
    paraQuem:        c.paraQuemLabel    || '',
    gravidade:       c.gravidadeLabel   || '',
    urgencia:        c.urgenciaLabel    || '',
    esforco:         c.esforcoLabel     || '',  // ‚Üê novo
    prioridade:      textoPrio,
    valorPrioridade: valorPrioridade,
    responsaveisIds: obterResponsaveisSelecionados('novoProjetoResponsaveisContainer'),
    dataInicio:      document.getElementById('novoProjetoDataInicio')?.value || '',
    dataFim:         document.getElementById('novoProjetoDataFim')?.value    || ''
  };

  var modalBody = document.querySelector('#modalNovoProjeto .modal-body');
  mostrarSpinner(modalBody);

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderSpinner(modalBody);
        if (res.sucesso) {
          fecharModalNovoProjeto();
          mostrarToast('Projeto criado!', 'sucesso');
          var novoProjeto = Object.assign({}, dados, { id: res.id });
          ESTADO.listaProjetos.push(novoProjeto);
          renderizarTudo();
          selecionarProjeto(res.id);
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderSpinner(modalBody);
        mostrarToast('Erro: ' + e, 'erro');
      })
      .salvarProjetoCompleto(dados);
  } else {
    setTimeout(function() {
      esconderSpinner(modalBody);
      fecharModalNovoProjeto();
      var novoId = 'proj_demo_' + Date.now();
      ESTADO.listaProjetos.push(Object.assign({}, dados, { id: novoId }));
      mostrarToast('Projeto criado (demo)', 'sucesso');
      renderizarTudo();
    }, 800);
  }
}

// ========================= MODAL C√ÅLCULO DE PRIORIDADE GUT =========================
function abrirModalCalculoPrioridade(projetoId, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }

  var projeto = ESTADO.listaProjetos.find(function(p) { return p.id === projetoId; });
  if (!projeto) { mostrarToast('Projeto n√£o encontrado', 'erro'); return; }

  ESTADO.calculoAtual = {
    projetoId: projetoId,
    gravidade: 0, gravidadeLabel: '',
    urgencia: 0, urgenciaLabel: '',
    quemSolicita: 0, quemSolicitaLabel: '',
    tipoProjeto: 0, tipoProjetoLabel: '',
    esforco: 0, esforcoLabel: ''    // ‚Üê novo
  };

  document.getElementById('calculoProjetoId').value = projetoId;
  document.getElementById('tituloModalCalculo').textContent = 'Calcular Prioridade: ' + projeto.nome;

  renderizarOpcoesIndicador('gravidade',    'opcoesGravidade');
  renderizarOpcoesIndicador('urgencia',     'opcoesUrgencia');
  renderizarOpcoesIndicador('quemSolicita', 'opcoesQuemSolicita');
  renderizarOpcoesIndicador('tipoProjeto',  'opcoesTipoProjeto');
  renderizarOpcoesIndicador('esforco',      'opcoesEsforco');    // ‚Üê novo

  setTimeout(function() {
    preCarregarCalculoPrioridade(projeto);
    atualizarResultadoCalculo();
  }, 50);

  abrirModal('modalCalculoPrioridade');
}

function renderizarOpcoesIndicador(indicador, containerId) {
  var container = document.getElementById(containerId);
  if (!container || !ESTADO.configCalculoPrioridade) return;

  var config = ESTADO.configCalculoPrioridade[indicador];
  if (!config || !config.opcoes) return;

  // Encontra o maior e menor peso para calcular a escala visual
  var pesos = config.opcoes.map(function(o) { return o.valor; });
  var pesoMax = Math.max.apply(null, pesos);
  var pesoMin = Math.min.apply(null, pesos);
  var amplitude = pesoMax - pesoMin || 1;

  var html = '';
  config.opcoes.forEach(function(op) {
    // Propor√ß√£o de 0 a 1 (0 = menor peso, 1 = maior peso)
    var proporcao = (op.valor - pesoMin) / amplitude;

    // Escala visual baseada no peso
    var tamanhoFonte  = (0.76 + proporcao * 0.18).toFixed(2) + 'rem';  // 0.76 ‚Üí 0.94rem
    var opacidade     = (0.55 + proporcao * 0.45).toFixed(2);           // 0.55 ‚Üí 1.0
    var pesoBorda     = proporcao > 0.6 ? '2px' : '1px';
    var corValor      = obterCorPeso(op.valor, pesoMax);

    html += '<label class="indicador-opcao" ' +
      'style="opacity:' + opacidade + ';font-size:' + tamanhoFonte + ';border-width:' + pesoBorda + ';" ' +
      'onclick="selecionarIndicador(\'' + indicador + '\', ' + op.valor + ', this)">' +
      '<input type="radio" name="' + indicador + '" value="' + op.valor + '">' +
      '<span class="indicador-opcao-valor" style="background:' + corValor + ';width:' + (20 + proporcao * 8) + 'px;height:' + (20 + proporcao * 8) + 'px;font-size:' + (0.68 + proporcao * 0.14).toFixed(2) + 'rem;">' +
        op.valor +
      '</span>' +
      '<span class="indicador-opcao-label">' + op.label + '</span>' +
      '</label>';
  });
  container.innerHTML = html;
}

function selecionarIndicador(indicador, valor, elemento) {
  var labelEl = elemento.querySelector('.indicador-opcao-label');
  var label = labelEl ? labelEl.textContent : '';

  ESTADO.calculoAtual[indicador] = valor;
  ESTADO.calculoAtual[indicador + 'Label'] = label;

  var cont = elemento.closest('.indicador-opcoes');
  cont.querySelectorAll('.indicador-opcao').forEach(function(op) { op.classList.remove('selecionado'); });
  elemento.classList.add('selecionado');

  atualizarResultadoCalculo();
}

function preCarregarCalculoPrioridade(projeto) {
  var config = ESTADO.configCalculoPrioridade;
  if (!config) return;

  if (projeto.tipo) {
    var opcTipo = (config.tipoProjeto?.opcoes || []).find(function(o) {
      return o.label.toLowerCase().includes(projeto.tipo.toLowerCase());
    });
    if (opcTipo) selecionarIndicadorPorValor('tipoProjeto', opcTipo.valor);
  }
  if (projeto.paraQuem) {
    var opcQuem = (config.quemSolicita?.opcoes || []).find(function(o) {
      return o.label.toLowerCase().includes(projeto.paraQuem.toLowerCase());
    });
    if (opcQuem) selecionarIndicadorPorValor('quemSolicita', opcQuem.valor);
  }
  if (projeto.gravidade) {
    var opcGrav = (config.gravidade?.opcoes || []).find(function(o) {
      return o.label === projeto.gravidade || o.label.toLowerCase().includes(projeto.gravidade.toLowerCase().split(' ')[0]);
    });
    if (opcGrav) selecionarIndicadorPorValor('gravidade', opcGrav.valor);
  }
  if (projeto.urgencia) {
    var opcUrg = (config.urgencia?.opcoes || []).find(function(o) {
      return o.label === projeto.urgencia || o.label.toLowerCase().includes(projeto.urgencia.toLowerCase().split(' ')[0]);
    });
    if (opcUrg) selecionarIndicadorPorValor('urgencia', opcUrg.valor);
  }
  // ‚Üê novo: pr√©-carrega esfor√ßo
  if (projeto.esforco) {
    var opcEsf = (config.esforco?.opcoes || []).find(function(o) {
      return o.label.trim() === projeto.esforco.trim();
    });
    if (opcEsf) selecionarIndicadorPorValor('esforco', opcEsf.valor);
  }
}

function atualizarResultadoCalculo() {
  var c = ESTADO.calculoAtual;
  var valor = c.gravidade * c.urgencia * c.quemSolicita * c.tipoProjeto * (c.esforco || 1);
  // Nota: se esforco n√£o selecionado ainda, usa 1 para n√£o zerar o c√°lculo parcial
  // Mas o bot√£o Salvar s√≥ habilita quando todos os 5 est√£o preenchidos
  var valorReal = c.esforco > 0 ? valor : 0;

  document.getElementById('formulaG').textContent = c.gravidade    || 'G';
  document.getElementById('formulaU').textContent = c.urgencia     || 'U';
  document.getElementById('formulaQ').textContent = c.quemSolicita || 'Q';
  document.getElementById('formulaT').textContent = c.tipoProjeto  || 'T';
  document.getElementById('formulaE').textContent = c.esforco      || 'E';  // ‚Üê novo
  document.getElementById('formulaResultado').textContent = valorReal;
  document.getElementById('valorCalculado').textContent = valorReal;

  var cat = obterCategoriaPrioridade(valorReal);
  var catEl = document.getElementById('categoriaCalculada');
  catEl.className = 'calculo-resultado-categoria ' + cat;

  if (valorReal === 0) catEl.textContent = 'Selecione os indicadores';
  else if (cat === 'alta')  catEl.textContent = 'üî¥ PRIORIDADE ALTA';
  else if (cat === 'media') catEl.textContent = 'üü° PRIORIDADE M√âDIA';
  else catEl.textContent = 'üü¢ PRIORIDADE BAIXA';

  var btn = document.getElementById('btnSalvarCalculo');
  btn.disabled = !(c.gravidade > 0 && c.urgencia > 0 && c.quemSolicita > 0 && c.tipoProjeto > 0 && c.esforco > 0);  // ‚Üê novo
}

function fecharModalCalculoPrioridade() {
  fecharModal('modalCalculoPrioridade');
}

function salvarCalculoPrioridade() {
  var c = ESTADO.calculoAtual;
  if (!c.projetoId) { mostrarToast('Projeto n√£o identificado', 'erro'); return; }
  if (c.gravidade === 0 || c.urgencia === 0 || c.quemSolicita === 0 || c.tipoProjeto === 0 || c.esforco === 0) {
    mostrarToast('Preencha todos os indicadores (incluindo Esfor√ßo)', 'aviso'); return;
  }

  var valorCalculado = c.gravidade * c.urgencia * c.quemSolicita * c.tipoProjeto * c.esforco; // ‚Üê atualizado
  var dadosCalculo = {
    gravidade:        c.gravidade,
    urgencia:         c.urgencia,
    quemSolicita:     c.quemSolicita,
    tipoProjeto:      c.tipoProjeto,
    esforco:          c.esforco,                // ‚Üê novo
    gravidadeLabel:   c.gravidadeLabel,
    urgenciaLabel:    c.urgenciaLabel,
    paraQuemLabel:    c.quemSolicitaLabel,
    tipoProjetoLabel: c.tipoProjetoLabel,
    esforcoLabel:     c.esforcoLabel            // ‚Üê novo
  };

  var modalBody = document.querySelector('#modalCalculoPrioridade .modal-body');
  mostrarSpinner(modalBody);

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderSpinner(modalBody);
        if (res.sucesso) {
          mostrarToast(res.mensagem, 'sucesso');
          var proj = ESTADO.listaProjetos.find(function(p) { return p.id === c.projetoId; });
          if (proj) {
            proj.valorPrioridade = valorCalculado;
            proj.gravidade = dadosCalculo.gravidadeLabel;
            proj.urgencia  = dadosCalculo.urgenciaLabel;
            proj.paraQuem  = dadosCalculo.paraQuemLabel;
            proj.tipo      = dadosCalculo.tipoProjetoLabel;
            proj.esforco   = dadosCalculo.esforcoLabel;   // ‚Üê novo
            proj.prioridade = res.categoriaPrioridade;
          }
          if (ESTADO.projeto && ESTADO.projeto.id === c.projetoId) {
            Object.assign(ESTADO.projeto, {
              valorPrioridade: valorCalculado,
              gravidade: dadosCalculo.gravidadeLabel,
              urgencia:  dadosCalculo.urgenciaLabel,
              paraQuem:  dadosCalculo.paraQuemLabel,
              tipo:      dadosCalculo.tipoProjetoLabel,
              esforco:   dadosCalculo.esforcoLabel    // ‚Üê novo
            });
          }
          fecharModalCalculoPrioridade();
          renderizarTudo();
        } else {
          mostrarToast('Erro: ' + res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderSpinner(modalBody);
        mostrarToast('Erro: ' + e, 'erro');
      })
      .salvarValorPrioridadeProjeto(c.projetoId, valorCalculado, dadosCalculo);
  } else {
    setTimeout(function() {
      esconderSpinner(modalBody);
      var proj = ESTADO.listaProjetos.find(function(p) { return p.id === c.projetoId; });
      if (proj) {
        proj.valorPrioridade = valorCalculado;
        proj.gravidade = dadosCalculo.gravidadeLabel;
        proj.urgencia  = dadosCalculo.urgenciaLabel;
        proj.esforco   = dadosCalculo.esforcoLabel;
      }
      mostrarToast('Prioridade: ' + valorCalculado + ' (demo)', 'sucesso');
      fecharModalCalculoPrioridade();
      renderizarTudo();
    }, 500);
  }
}

// ========================= TOGGLE CHAT / SIDEBAR =========================
function toggleChat() {
  ESTADO.chatVisivel = !ESTADO.chatVisivel;
  var mainLayout = document.getElementById('mainLayout');
  var btn = document.getElementById('btnToggleChat');
  mainLayout.classList.toggle('chat-oculto', !ESTADO.chatVisivel);
  if (btn) btn.classList.toggle('ativo', ESTADO.chatVisivel);
}

function trocarAbaSidebar(nomeAba) {
  ESTADO.abaSidebarAtiva = nomeAba;
  document.querySelectorAll('.sidebar-aba').forEach(function(b) { b.classList.toggle('ativa', b.dataset.aba === nomeAba); });
  document.querySelectorAll('.sidebar-painel').forEach(function(p) { p.classList.remove('ativo'); });

  if (nomeAba === 'assistente') document.getElementById('painelAssistente').classList.add('ativo');
  else if (nomeAba === 'emails') {
    document.getElementById('painelEmails').classList.add('ativo');
    carregarResponsaveisParaEmail();
  }
}

// ========================= CHAT IA =========================
function checarEnter(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); enviarTexto(); }
}

function enviarTexto() {
  var inp = document.getElementById('inputChat');
  var txt = inp.value.trim();
  if (!txt) return;

  adicionarBalao(txt, 'user');
  inp.value = '';
  adicionarTypingIndicator();

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        removerTypingIndicator();
        adicionarBalao(res.sucesso ? res.resposta : 'Erro: ' + res.mensagem, 'ai');
      })
      .withFailureHandler(function(e) {
        removerTypingIndicator();
        adicionarBalao('Erro: ' + e, 'ai');
      })
      .enviarMensagemParaGemini(txt, ESTADO.historicoChat, ESTADO.projeto);
  } else {
    setTimeout(function() {
      removerTypingIndicator();
      adicionarBalao('Entendi! Posso ajudar a estruturar esse projeto.', 'ai');
    }, 1200);
  }
}

function adicionarBalao(texto, tipo) {
  var area = document.getElementById('chatArea');
  var div = document.createElement('div');
  div.className = 'balao balao-' + tipo;
  div.innerHTML = tipo === 'ai' ? formatarMarkdown(texto) : texto;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
  ESTADO.historicoChat.push({ role: tipo === 'ai' ? 'model' : 'user', texto: texto });
}

function formatarMarkdown(texto) {
  var html = texto;
  html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
  html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  html = html.replace(/\n/g, '<br>');
  return html;
}

function adicionarTypingIndicator() {
  var area = document.getElementById('chatArea');
  var div = document.createElement('div');
  div.id = 'typingIndicator';
  div.className = 'balao balao-ai balao-typing';
  div.innerHTML = '<span></span><span></span><span></span>';
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function removerTypingIndicator() {
  var el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

// ========================= GRAVA√á√ÉO DE √ÅUDIO =========================
async function iniciarGravacao() {
  if (!navigator.mediaDevices) { mostrarToast('Navegador n√£o suporta grava√ß√£o', 'erro'); return; }
  try {
    var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    audioChunks = [];
    mediaRecorder.ondataavailable = function(e) { audioChunks.push(e.data); };
    mediaRecorder.start();
    document.getElementById('btnMic').classList.add('gravando');
  } catch (e) {
    mostrarToast('Erro no microfone: ' + e.message, 'erro');
  }
}

function pararGravacao() {
  if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
  mediaRecorder.stop();
  document.getElementById('btnMic').classList.remove('gravando');
  mediaRecorder.onstop = function() {
    var blob = new Blob(audioChunks, { type: 'audio/webm' });
    var reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = function() { enviarAudioParaBackend(reader.result); };
  };
}

function enviarAudioParaBackend(base64) {
  adicionarBalao('üé§ √Åudio enviado', 'user');
  adicionarTypingIndicator();

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        removerTypingIndicator();
        adicionarBalao(res.sucesso ? res.resposta : 'Erro: ' + res.mensagem, 'ai');
      })
      .withFailureHandler(function(e) {
        removerTypingIndicator();
        adicionarBalao('Erro: ' + e, 'ai');
      })
      .processarAudioParaGemini(base64, 'audio/webm', ESTADO.projeto);
  } else {
    setTimeout(function() {
      removerTypingIndicator();
      adicionarBalao('Recebi seu √°udio! Posso ajudar a criar atividades.', 'ai');
    }, 1500);
  }
}

// ========================= PAINEL DE EMAILS =========================
function carregarResponsaveisParaEmail() {
  var container = document.getElementById('emailCorpo');
  if (!ESTADO.projeto || !ESTADO.projeto.id) {
    container.innerHTML = '<div class="email-vazio"><i class="fas fa-folder-open"></i><p>Selecione um projeto para ver os respons√°veis</p></div>';
    document.getElementById('btnEnviarEmails').disabled = true;
    return;
  }

  container.innerHTML = '<div class="email-vazio"><i class="fas fa-spinner fa-spin"></i><p>Carregando...</p></div>';

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        if (res.sucesso) {
          ESTADO.responsaveisEmail = res.responsaveis;
          renderizarPainelEmail();
        }
      })
      .withFailureHandler(function() {
        container.innerHTML = '<div class="email-vazio"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar</p></div>';
      })
      .obterResponsaveisComEtapasDoProjeto(ESTADO.projeto.id);
  }
}

function renderizarPainelEmail() {
  var container = document.getElementById('emailCorpo');
  var resps = ESTADO.responsaveisEmail;
  if (!resps || resps.length === 0) {
    container.innerHTML = '<div class="email-vazio"><i class="fas fa-user-slash"></i><p>Nenhum respons√°vel</p></div>';
    document.getElementById('btnEnviarEmails').disabled = true;
    return;
  }

  var html = '<div class="email-secao"><div class="email-secao-header"><span><i class="fas fa-users"></i> Destinat√°rios</span>' +
    '<button class="btn-selecionar-todos" onclick="toggleSelecionarTodosEmail()">Selecionar Todos</button></div><div class="email-secao-body">';

  resps.forEach(function(resp) {
    var temEmail = resp.email && resp.email.trim() !== '';
    html += '<div class="responsavel-email-item" onclick="toggleCheckboxEmail(\'' + resp.id + '\')">' +
      '<input type="checkbox" id="check_email_' + resp.id + '" value="' + resp.id + '" ' + (!temEmail ? 'disabled' : '') + '>' +
     '<div class="responsavel-email-info">' +
        '<div class="responsavel-email-nome">' + resp.nome +
          (resp.ehResponsavelProjeto ? ' <span class="tag-projeto">Respons√°vel</span>' : '') +
        '</div>' +
        '<div class="responsavel-email-meta">' +
          (temEmail ? resp.email : '<span style="color:var(--cor-perigo);">Sem email cadastrado</span>') +
          (resp.cargo ? ' ‚Ä¢ ' + resp.cargo : '') +
        '</div>' +
      '</div>' +
      (resp.quantidadeEtapas > 0 ? '<span class="responsavel-email-etapas">' + resp.quantidadeEtapas + ' atividade(s)</span>' : '') +
      '</div>';
  });

  html += '</div></div>';

  // Se√ß√£o CC (Com C√≥pia)
  var todosResponsaveisCC = ESTADO.responsaveis || [];

  html += '<div class="email-secao">' +
    '<div class="email-secao-header"><span><i class="fas fa-copy"></i> Com C√≥pia (CC)</span>' +
    '<span class="contador" id="contadorCC">0</span></div>' +
    '<div class="email-secao-body" style="max-height:none;">' +
    '<div class="email-cc-container">' +
    '<div class="email-cc-header"><label><i class="fas fa-users"></i> Selecione da lista:</label></div>' +
    '<div class="email-cc-lista" id="emailCcLista">';

  todosResponsaveisCC.forEach(function(resp) {
    if (resp.email && resp.email.trim() !== '') {
      html += '<span class="email-cc-chip" data-email="' + resp.email + '" ' +
        'onclick="alternarEmailCC(this, \'' + resp.email + '\')">' +
        '<i class="fas fa-user"></i> ' + resp.nome + '</span>';
    }
  });

  html += '</div>' +
    '<div class="email-cc-input-container">' +
    '<input type="email" id="emailCcCustom" placeholder="Ou digite um email...">' +
    '<button onclick="adicionarEmailCCCustom()"><i class="fas fa-plus"></i> Add</button>' +
    '</div>' +
    '<div id="emailsCcCustomLista" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;"></div>' +
    '</div></div></div>';

  // Campos do Email
  html += '<div class="email-secao">' +
    '<div class="email-secao-header"><span><i class="fas fa-edit"></i> Personalizar Email</span></div>' +
    '<div class="email-secao-body" style="max-height:none;">' +
    '<div class="email-campo"><label>Assunto (opcional)</label>' +
    '<input type="text" id="emailAssunto" placeholder="Deixe vazio para usar o padr√£o"></div>' +
    '<div class="email-campo" style="margin-top:12px;"><label>Mensagem Adicional (opcional)</label>' +
    '<textarea id="emailMensagem" placeholder="Mensagem personalizada no in√≠cio do email..."></textarea></div>' +
    '</div></div>';

  container.innerHTML = html;
  ESTADO.emailsCcSelecionados = [];
  atualizarBotaoEnviarEmail();
}

function toggleCheckboxEmail(respId) {
  var cb = document.getElementById('check_email_' + respId);
  if (cb && !cb.disabled) {
    cb.checked = !cb.checked;
    atualizarBotaoEnviarEmail();
  }
}

function toggleSelecionarTodosEmail() {
  var cbs = document.querySelectorAll('#emailCorpo input[type="checkbox"]:not(:disabled)');
  var todosChecados = Array.from(cbs).every(function(cb) { return cb.checked; });
  cbs.forEach(function(cb) { cb.checked = !todosChecados; });
  atualizarBotaoEnviarEmail();
}

function atualizarBotaoEnviarEmail() {
  var cbs = document.querySelectorAll('#emailCorpo input[type="checkbox"]:checked');
  var btn = document.getElementById('btnEnviarEmails');
  var qtd = cbs.length;
  btn.disabled = qtd === 0;
  btn.innerHTML = qtd > 0
    ? '<i class="fas fa-paper-plane"></i> Enviar para ' + qtd + ' pessoa(s)'
    : '<i class="fas fa-paper-plane"></i> Enviar Emails';
}

// ========================= FUN√á√ïES DE EMAIL CC =========================
function alternarEmailCC(chip, email) {
  chip.classList.toggle('selecionado');
  if (chip.classList.contains('selecionado')) {
    if (!ESTADO.emailsCcSelecionados.includes(email)) {
      ESTADO.emailsCcSelecionados.push(email);
    }
  } else {
    ESTADO.emailsCcSelecionados = ESTADO.emailsCcSelecionados.filter(function(e) { return e !== email; });
  }
  atualizarContadorCC();
}

function adicionarEmailCCCustom() {
  var input = document.getElementById('emailCcCustom');
  var email = input.value.trim();
  if (!email) { mostrarToast('Digite um email', 'aviso'); return; }
  if (!email.includes('@')) { mostrarToast('Email inv√°lido', 'erro'); return; }
  if (ESTADO.emailsCcSelecionados.includes(email)) { mostrarToast('Email j√° adicionado', 'aviso'); return; }

  ESTADO.emailsCcSelecionados.push(email);

  var listaCustom = document.getElementById('emailsCcCustomLista');
  var chip = document.createElement('span');
  chip.className = 'email-cc-chip selecionado';
  chip.dataset.email = email;
  chip.innerHTML = '<i class="fas fa-envelope"></i> ' + email +
    ' <i class="fas fa-times" style="margin-left:4px;cursor:pointer;" onclick="removerEmailCCCustom(this, \'' + email + '\')"></i>';
  listaCustom.appendChild(chip);

  input.value = '';
  atualizarContadorCC();
  mostrarToast('Email adicionado ao CC', 'sucesso');
}

function removerEmailCCCustom(icone, email) {
  var chip = icone.closest('.email-cc-chip');
  if (chip) chip.remove();
  ESTADO.emailsCcSelecionados = ESTADO.emailsCcSelecionados.filter(function(e) { return e !== email; });
  atualizarContadorCC();
}

function atualizarContadorCC() {
  var el = document.getElementById('contadorCC');
  if (el) el.textContent = ESTADO.emailsCcSelecionados.length;
}

// ========================= ENVIAR EMAILS =========================
function enviarEmailsSelecionados() {
  var cbs = document.querySelectorAll('#emailCorpo input[type="checkbox"]:checked');
  var idsSelecionados = Array.from(cbs).map(function(cb) { return cb.value; });

  if (idsSelecionados.length === 0) {
    mostrarToast('Selecione pelo menos um respons√°vel', 'aviso');
    return;
  }

  var assunto = (document.getElementById('emailAssunto') || {}).value || '';
  var mensagem = (document.getElementById('emailMensagem') || {}).value || '';
  var emailsCC = ESTADO.emailsCcSelecionados || [];

  // Confirma√ß√£o
  var nomes = idsSelecionados.map(function(id) {
    var resp = ESTADO.responsaveisEmail.find(function(r) { return r.id === id; });
    return resp ? resp.nome : id;
  });

  var msg = 'Enviar email para:\n\n' + nomes.join('\n');
  if (emailsCC.length > 0) msg += '\n\nCom c√≥pia (CC) para:\n' + emailsCC.join('\n');
  msg += '\n\nConfirmar?';

  if (!confirm(msg)) return;

  mostrarTelaCarregamento('Enviando emails...');

  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(res) {
        esconderTelaCarregamento();
        if (res.sucesso) {
          mostrarToast(res.mensagem, 'sucesso');
          // Limpar sele√ß√£o
          document.querySelectorAll('#emailCorpo input[type="checkbox"]').forEach(function(cb) { cb.checked = false; });
          document.querySelectorAll('.email-cc-chip.selecionado').forEach(function(chip) { chip.classList.remove('selecionado'); });
          var customLista = document.getElementById('emailsCcCustomLista');
          if (customLista) customLista.innerHTML = '';
          var elAssunto = document.getElementById('emailAssunto');
          if (elAssunto) elAssunto.value = '';
          var elMsg = document.getElementById('emailMensagem');
          if (elMsg) elMsg.value = '';
          ESTADO.emailsCcSelecionados = [];
          atualizarContadorCC();
          atualizarBotaoEnviarEmail();
        } else {
          mostrarToast(res.mensagem, 'erro');
        }
      })
      .withFailureHandler(function(e) {
        esconderTelaCarregamento();
        mostrarToast('Erro: ' + e, 'erro');
      })
      .enviarEmailParaResponsaveisComCopia(idsSelecionados, ESTADO.projeto.id, assunto.trim(), mensagem.trim(), emailsCC);
  } else {
    setTimeout(function() {
      esconderTelaCarregamento();
      mostrarToast(idsSelecionados.length + ' email(s) enviado(s) (demo)' + (emailsCC.length > 0 ? ' + ' + emailsCC.length + ' CC' : ''), 'sucesso');
    }, 1500);
  }
}

// ========================= NAVEGA√á√ÉO (LINKS ENTRE P√ÅGINAS) =========================
function configurarNavegacao() {
  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(urlBase) {
        var links = document.querySelectorAll('a[data-pagina]');
        links.forEach(function(link) {
          var pagina = link.getAttribute('data-pagina');
          var urlCompleta = urlBase + '?pagina=' + pagina;
          link.href = urlCompleta;
          link.addEventListener('click', function(evento) {
            evento.preventDefault();
            window.top.location.href = urlCompleta;
          });
        });
      })
      .withFailureHandler(function(erro) {
        console.error('Erro ao obter URL base:', erro);
      })
      .obterUrlBaseWebApp();
  }
}

// ========================= DADOS DEMO (FALLBACK SEM GOOGLE) =========================
function carregarDadosDemo() {
  ESTADO.setores = [
    { id: 'set_001', nome: 'Marketing', cor: '#8b5cf6' },
    { id: 'set_002', nome: 'Desenvolvimento', cor: '#3b82f6' },
    { id: 'set_003', nome: 'Financeiro', cor: '#10b981' }
  ];

  ESTADO.responsaveis = [
    { id: 'resp_001', nome: 'Jo√£o Silva', cargo: 'Gerente', email: 'joao@teste.com' },
    { id: 'resp_002', nome: 'Maria Santos', cargo: 'Analista', email: 'maria@teste.com' },
    { id: 'resp_003', nome: 'Carlos Lima', cargo: 'Dev', email: 'carlos@teste.com' }
  ];

  ESTADO.listaProjetos = [
    {
      id: 'proj_001', nome: 'Campanha de Natal', descricao: 'Campanha promocional',
      setor: 'Marketing', prioridade: 'Alta', status: 'Em Andamento', tipo: 'Melhoria',
      paraQuem: 'Diretoria', gravidade: 'Cr√≠tico - N√£o √© poss√≠vel cumprir as atividades',
      urgencia: 'Imediata - Executar imediatamente', pilar: 'Crescimento',
      responsaveisIds: ['resp_001'], valorPrioridade: 2500, link: ''
    },
    {
      id: 'proj_002', nome: 'Novo CRM', descricao: 'Sistema de CRM interno',
      setor: 'Desenvolvimento', prioridade: 'M√©dia', status: 'A Fazer', tipo: 'Nova Implementa√ß√£o',
      paraQuem: 'Demais √°reas', gravidade: 'Alto - √â poss√≠vel cumprir parcialmente',
      urgencia: 'Muito urgente - Prazo curto (5 dias)', pilar: 'Opera√ß√£o',
      responsaveisIds: ['resp_002'], valorPrioridade: 1200, link: ''
    },
    {
      id: 'proj_003', nome: 'Corre√ß√£o de Bugs', descricao: 'Corre√ß√µes gerais',
      setor: 'Desenvolvimento', prioridade: 'Baixa', status: 'Aguardando Setor', tipo: 'Corre√ß√£o',
      paraQuem: 'Demais √°reas', gravidade: '', urgencia: '', pilar: 'Manuten√ß√£o',
      responsaveisIds: ['resp_001', 'resp_002'], valorPrioridade: 0, link: ''
    },
    {
      id: 'proj_004', nome: 'Dashboard BI', descricao: 'Painel de indicadores',
      setor: 'Financeiro', prioridade: 'Alta', status: 'Em Andamento', tipo: 'Nova Implementa√ß√£o',
      paraQuem: 'Diretoria', gravidade: 'Alto - √â poss√≠vel cumprir parcialmente',
      urgencia: 'Urgente - Curto prazo (10 dias)', pilar: 'Dados',
      responsaveisIds: ['resp_003'], valorPrioridade: 1800, link: 'https://drive.google.com/example'
    },
    {
      id: 'proj_005', nome: 'Automa√ß√£o RH', descricao: 'Automatizar processos de RH',
      setor: 'Marketing', prioridade: 'Baixa', status: 'Conclu√≠da', tipo: 'Melhoria',
      paraQuem: 'Demais √°reas', gravidade: '', urgencia: '', pilar: 'Opera√ß√£o',
      responsaveisIds: ['resp_002', 'resp_003'], valorPrioridade: 500, link: ''
    }
  ];

  ESTADO.projeto = null;
  ESTADO.etapas = [
    { id: 'eta_001', projetoId: 'proj_001', nome: 'Levantamento de requisitos',   status: 'Conclu√≠da',        oQueFazer: 'Reunir com stakeholders e documentar os requisitos do sistema.',  responsaveisIds: ['resp_001'] },
    { id: 'eta_002', projetoId: 'proj_001', nome: 'Cria√ß√£o do briefing criativo', status: 'Em Andamento',     oQueFazer: 'Elaborar o briefing com identidade visual e tom de voz da campanha.', responsaveisIds: ['resp_002'] },
    { id: 'eta_003', projetoId: 'proj_001', nome: 'Desenvolvimento dos materiais',status: 'A Fazer',          oQueFazer: 'Criar pe√ßas gr√°ficas para redes sociais, e-mail e impressos.',    responsaveisIds: ['resp_001', 'resp_003'] },
    { id: 'eta_004', projetoId: 'proj_001', nome: 'Revis√£o e aprova√ß√£o',          status: 'Aguardando Setor', oQueFazer: 'Enviar materiais para aprova√ß√£o da diretoria.',                    responsaveisIds: ['resp_001'] }
  ];

  ESTADO.pessoasParaQuem = {
    'Diretoria': { peso: 5, cor: '#dc2626', bgCor: 'rgba(220,38,38,0.15)', label: 'üî¥ Cr√≠tico' },
    'Demais √°reas': { peso: 4, cor: '#ea580c', bgCor: 'rgba(234,88,12,0.15)', label: 'üü† Urgente' }
  };

  ESTADO.configCalculoPrioridade = {
    gravidade: {
      titulo: 'Gravidade', descricao: 'O que acontece se eu n√£o fizer?',
      opcoes: [
        { valor: 5, label: 'Cr√≠tico - N√£o √© poss√≠vel cumprir as atividades' },
        { valor: 4, label: 'Alto - √â poss√≠vel cumprir parcialmente' },
        { valor: 3, label: 'M√©dio - √â poss√≠vel mas demora muito' }
      ]
    },
    urgencia: {
      titulo: 'Urg√™ncia', descricao: 'Para quando?',
      opcoes: [
        { valor: 5, label: 'Imediata - Executar imediatamente' },
        { valor: 4, label: 'Muito urgente - Prazo curto (5 dias)' },
        { valor: 3, label: 'Urgente - Curto prazo (10 dias)' },
        { valor: 2, label: 'Pouco urgente - Mais de 10 dias' },
        { valor: 1, label: 'Pode esperar' }
      ]
    },
    quemSolicita: {
      titulo: 'Para Quem', descricao: 'Quem solicitou',
      opcoes: [
        { valor: 5, label: 'Diretoria / Cr√≠tico' },
        { valor: 3, label: 'Demais √°reas' }
      ]
    },
tipoProjeto: {
  titulo: 'Tipo de Projeto', descricao: 'Natureza do projeto',
  opcoes: [
    { valor: 5, label: 'Corre√ß√£o' },           // ‚Üê 5 = maior peso
    { valor: 4, label: 'Nova Implementa√ß√£o' },  // ‚Üê 4
    { valor: 3, label: 'Melhoria' }             // ‚Üê 3 = menor peso
  ]
}
  };

  ESTADO.prioridadesProjetos = [];
}

// ========================= PR√â-SELECIONAR INDICADOR POR VALOR =========================
/** Seleciona visualmente um indicador pelo valor num√©rico (usado no pr√©-carregamento) */
function selecionarIndicadorPorValor(indicador, valor) {
  var mapeamentoContainer = {
    'gravidade':    'opcoesGravidade',
    'urgencia':     'opcoesUrgencia',
    'quemSolicita': 'opcoesQuemSolicita',
    'tipoProjeto':  'opcoesTipoProjeto',
    'esforco':      'opcoesEsforco'       // ‚Üê novo
  };
  var containerId = mapeamentoContainer[indicador];
  if (!containerId) return;

  var container = document.getElementById(containerId);
  if (!container) return;

  var opcoes = container.querySelectorAll('.indicador-opcao');
  opcoes.forEach(function(op) {
    var radio = op.querySelector('input[type="radio"]');
    if (radio && parseInt(radio.value) === valor) {
      op.classList.add('selecionado');
      radio.checked = true;
      var labelEl = op.querySelector('.indicador-opcao-label');
      ESTADO.calculoAtual[indicador] = valor;
      ESTADO.calculoAtual[indicador + 'Label'] = labelEl ? labelEl.textContent : '';
    }
  });
}

// ========================= FECHAR MODAL MENSAGEM COMPLETA =========================
function fecharModalMensagemCompleta() {
  fecharModal('modalMensagemCompleta');
}

// ========================= AUTO-RESIZE TEXTAREA DO CHAT =========================
(function() {
  var inputChat = document.getElementById('inputChat');
  if (inputChat) {
    inputChat.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
  }
})();

// ========================= CAMPO LINK READONLY (ESTILO) =========================
/** Adiciona CSS inline para campos de link readonly nos cards */
(function() {
  var style = document.createElement('style');
style.textContent =
  // ‚îÄ‚îÄ Busca no header ‚îÄ‚îÄ
  '.campo-link-readonly{background:var(--cor-fundo)!important;cursor:default!important;color:var(--cor-texto-secundario)!important;font-size:0.75rem!important;border:1px solid var(--cor-borda-clara)!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}' +
  '.campo-busca-wrapper{padding:6px 10px;background:var(--cor-fundo-quente);border-bottom:1px solid var(--cor-borda-clara);}' +
  '.campo-busca{display:flex;align-items:center;gap:6px;background:var(--cor-fundo-card);border:1px solid var(--cor-borda);border-radius:var(--raio);padding:4px 8px;}' +
  '.campo-busca i{color:var(--cor-texto-secundario);font-size:0.75rem;}' +
  '.campo-busca input{border:none!important;box-shadow:none!important;padding:4px!important;font-size:0.78rem!important;background:transparent!important;}' +
  '.campo-busca input:focus{outline:none!important;}' +

  // ‚îÄ‚îÄ Datas nos cards ‚îÄ‚îÄ
  '.projeto-card-datas-wrapper{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}' +
  '.projeto-card-data-item{font-size:0.78rem;color:var(--cor-texto);display:inline-flex;align-items:center;gap:4px;}' +
  '.projeto-card-data-item.vazio{color:#b0a090;font-style:italic;}' +
  '.projeto-card-data-sep{color:var(--cor-texto-secundario);font-size:0.85rem;}' +
  '.projeto-card-duracao{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:var(--cor-primaria-bg);border:1px solid var(--cor-borda-clara);border-radius:4px;font-size:0.75rem;font-weight:700;}' +
  '.badge-duracao{padding:2px 7px;border-radius:3px;font-size:0.65rem;font-weight:700;background:rgba(107,76,59,0.1);color:var(--cor-primaria-escura);display:inline-flex;align-items:center;gap:3px;}' +

  // ‚îÄ‚îÄ Lixeira ‚îÄ‚îÄ
  '.btn-lixeira{background:rgba(166,61,64,0.2)!important;border-color:rgba(166,61,64,0.4)!important;}' +
  '.btn-lixeira:hover{background:rgba(166,61,64,0.4)!important;}' +
  '.btn-diagrama-excluir{color:var(--cor-perigo)!important;opacity:0.7;}' +
  '.btn-diagrama-excluir:hover{background:rgba(166,61,64,0.15)!important;opacity:1;border-color:rgba(166,61,64,0.4)!important;}' +
  '.lixeira-aviso{background:rgba(184,134,11,0.08);border:1px solid rgba(184,134,11,0.25);border-left:3px solid var(--cor-aviso);padding:10px 14px;border-radius:var(--raio);font-size:0.8rem;color:var(--cor-texto);margin-bottom:14px;display:flex;align-items:center;gap:8px;}' +
  '.lixeira-aviso i{color:var(--cor-aviso);flex-shrink:0;}' +
  '.lixeira-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--cor-fundo-card);border:1px solid var(--cor-borda-clara);border-radius:var(--raio);margin-bottom:8px;transition:var(--transicao);}' +
  '.lixeira-item:hover{border-color:var(--cor-primaria-clara);box-shadow:var(--sombra);}' +
  '.lixeira-item-info{flex:1;min-width:0;}' +
  '.lixeira-item-nome{font-weight:600;font-size:0.88rem;color:var(--cor-texto);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}' +
  '.lixeira-item-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}' +
  '.lixeira-setor{font-size:0.72rem;color:var(--cor-texto-secundario);display:flex;align-items:center;gap:3px;}' +
  '.lixeira-data{font-size:0.72rem;color:var(--cor-perigo);display:flex;align-items:center;gap:3px;font-style:italic;}' +
  '.lixeira-item-acoes{display:flex;gap:6px;flex-shrink:0;}' +
  '.btn-lixeira-restaurar{background:var(--cor-sucesso);color:#faf6ee;border:none;padding:6px 12px;border-radius:var(--raio);cursor:pointer;font-size:0.76rem;font-weight:600;display:flex;align-items:center;gap:5px;transition:var(--transicao);}' +
  '.btn-lixeira-restaurar:hover{background:#45603a;transform:translateY(-1px);}' +
  '.btn-lixeira-excluir{background:rgba(166,61,64,0.08);color:var(--cor-perigo);border:1px solid rgba(166,61,64,0.25);width:32px;height:32px;border-radius:var(--raio);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.82rem;transition:var(--transicao);}' +
  '.btn-lixeira-excluir:hover{background:var(--cor-perigo);color:#faf6ee;}' +

  // ‚îÄ‚îÄ Progresso das atividades ‚îÄ‚îÄ
  '.diagrama-progresso-wrapper{margin:0 0 2px;padding:12px 16px;background:var(--cor-fundo);border-top:1px solid var(--cor-borda-clara);}' +
  '.diagrama-progresso-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}' +
  '.diagrama-progresso-titulo{font-size:0.78rem;font-weight:600;color:var(--cor-texto-secundario);display:flex;align-items:center;gap:5px;}' +
  '.diagrama-progresso-contagem{font-size:0.75rem;color:var(--cor-texto-secundario);}' +
  '.diagrama-progresso-barra-bg{width:100%;height:8px;background:var(--cor-borda);border-radius:4px;overflow:hidden;}' +
  '.diagrama-progresso-barra-fill{height:100%;border-radius:4px;transition:width 0.4s ease;}' +
  '.diagrama-progresso-pct{font-size:0.8rem;font-weight:700;text-align:right;margin-top:4px;}' +

  // ‚îÄ‚îÄ Filtro de atividades ‚îÄ‚îÄ
  '.atividades-filtro-barra{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:10px 0 6px;margin-bottom:2px;}' +
  '.atividades-filtro-titulo{font-size:0.75rem;color:var(--cor-texto-secundario);font-weight:600;display:flex;align-items:center;gap:4px;margin-right:2px;white-space:nowrap;}' +
  '.btn-filtro-status{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border:1px solid var(--cor-borda-clara);border-radius:20px;background:var(--cor-fundo-card);color:var(--cor-texto-secundario);font-size:0.73rem;cursor:pointer;transition:var(--transicao);white-space:nowrap;}' +
  '.btn-filtro-status:hover{border-color:var(--cor-primaria-clara);color:var(--cor-primaria);}' +
  '.btn-filtro-status.ativo{background:var(--cor-primaria);color:#faf6ee;border-color:var(--cor-primaria);font-weight:600;}' +
  '.filtro-qtd{background:rgba(255,255,255,0.2);border-radius:10px;padding:0 5px;font-size:0.68rem;min-width:16px;text-align:center;}' +
  '.btn-filtro-status:not(.ativo) .filtro-qtd{background:var(--cor-borda);color:var(--cor-texto-secundario);}' +

  // ‚îÄ‚îÄ Checklist de atividades ‚îÄ‚îÄ
  '.btn-checklist{width:28px;height:28px;flex-shrink:0;border:2px solid var(--cor-borda);border-radius:50%;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--cor-borda);transition:var(--transicao);}' +
  '.btn-checklist:hover{border-color:var(--cor-sucesso);color:var(--cor-sucesso);transform:scale(1.1);}' +
  '.btn-checklist.concluida{border-color:var(--cor-sucesso);color:var(--cor-sucesso);background:rgba(85,107,75,0.1);}' +
  '.btn-checklist.concluida:hover{background:rgba(85,107,75,0.2);}' +
  '.atividade-concluida .atividade-card{opacity:0.72;}' +
  '.riscado{text-decoration:line-through;color:var(--cor-texto-secundario)!important;}' +

  // ‚îÄ‚îÄ Novos cards de atividade (atividade-node / atividade-card) ‚îÄ‚îÄ
  '.atividade-node{margin-bottom:6px;}' +
  '.atividade-card{background:var(--cor-fundo-card);border:1px solid var(--cor-borda-clara);border-radius:var(--raio);overflow:hidden;transition:var(--transicao);box-shadow:var(--sombra);}' +
  '.atividade-card:hover{box-shadow:var(--sombra-lg);transform:translateX(2px);}' +
  '.atividade-card-header{display:flex;align-items:center;gap:9px;padding:10px 12px;background:linear-gradient(135deg,var(--cor-fundo-quente) 0%,var(--cor-fundo-card) 100%);}' +
  '.atividade-card-titulo-area{flex:1;min-width:0;}' +
  '.atividade-card-titulo{font-weight:600;font-size:0.84rem;color:var(--cor-texto);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}' +
  '.atividade-card-badges{display:flex;flex-wrap:wrap;gap:4px;align-items:center;margin-top:2px;}' +
  '.atividade-card-acoes{display:flex;gap:3px;flex-shrink:0;align-items:center;}' +
  '.atividade-card-detalhes{padding:10px 12px;background:var(--cor-fundo-quente);border-top:1px solid var(--cor-borda-clara);display:flex;flex-direction:column;gap:8px;}' +
  '.atividade-detalhe-campo{display:flex;flex-direction:column;gap:3px;}' +
  '.atividade-detalhe-label{font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.04em;color:var(--cor-texto-secundario);display:flex;align-items:center;gap:4px;}' +
  '.atividade-detalhe-label i{color:var(--cor-primaria);font-size:0.6rem;}' +
  '.btn-acao-icone{width:28px;height:28px;border:none;background:transparent;color:var(--cor-texto-secundario);border-radius:var(--raio);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.75rem;transition:var(--transicao);}' +
  '.btn-acao-icone:hover{background:var(--cor-primaria-bg);color:var(--cor-primaria);transform:scale(1.1);}' +
  '.btn-acao-perigo:hover{background:rgba(166,61,64,0.1)!important;color:var(--cor-perigo)!important;}' +
  '.badge-resp-mini{font-size:0.67rem;color:var(--cor-texto-secundario);display:inline-flex;align-items:center;gap:3px;padding:1px 6px;background:var(--cor-primaria-bg);border-radius:3px;}' +
  '.badge-resp-mini i{font-size:0.6rem;color:var(--cor-primaria-clara);}' +

  // ‚îÄ‚îÄ Email ‚îÄ‚îÄ
  '.email-header{padding:14px 0;border-bottom:1px solid var(--cor-borda-clara);margin-bottom:14px;}' +
  '.email-header h3{font-family:var(--font-titulo);font-size:1rem;font-weight:600;color:var(--cor-primaria-escura);margin:0;display:flex;align-items:center;gap:7px;}' +
  '.email-header p{font-size:0.78rem;color:var(--cor-texto-secundario);margin:4px 0 0;}' +
  '.email-secao{background:var(--cor-fundo);border:1px solid var(--cor-borda-clara);border-radius:var(--raio);margin-bottom:12px;overflow:hidden;}' +
  '.email-secao-header{padding:10px 12px;background:var(--cor-fundo-quente);border-bottom:1px solid var(--cor-borda-clara);display:flex;align-items:center;justify-content:space-between;}' +
  '.email-secao-header span{font-size:0.82rem;font-weight:600;color:var(--cor-texto);display:flex;align-items:center;gap:5px;}' +
  '.email-secao-header .contador{background:var(--cor-primaria);color:#faf6ee;padding:2px 7px;border-radius:3px;font-size:0.68rem;font-weight:700;}' +
  '.email-secao-body{padding:8px;max-height:200px;overflow-y:auto;}' +
  '.btn-selecionar-todos{background:var(--cor-primaria-bg);border:1px solid var(--cor-primaria-clara);color:var(--cor-primaria);padding:3px 8px;border-radius:4px;font-size:0.7rem;font-weight:600;cursor:pointer;transition:var(--transicao);}' +
  '.btn-selecionar-todos:hover{background:var(--cor-primaria);color:#faf6ee;}' +
  '.responsavel-email-item{display:flex;align-items:center;gap:8px;padding:8px;background:var(--cor-fundo-card);border:1px solid var(--cor-borda-clara);border-radius:var(--raio);margin-bottom:5px;cursor:pointer;transition:var(--transicao);}' +
  '.responsavel-email-item:hover{border-color:var(--cor-primaria-clara);background:var(--cor-primaria-bg);}' +
  '.responsavel-email-item input[type="checkbox"]{width:16px;height:16px;accent-color:var(--cor-primaria);cursor:pointer;flex-shrink:0;}' +
  '.responsavel-email-info{flex:1;min-width:0;}' +
  '.responsavel-email-nome{font-weight:600;font-size:0.82rem;color:var(--cor-texto);display:flex;align-items:center;gap:6px;}' +
  '.responsavel-email-meta{font-size:0.72rem;color:var(--cor-texto-secundario);margin-top:2px;}' +
  '.responsavel-email-etapas{background:var(--cor-primaria-bg);color:var(--cor-primaria);padding:2px 7px;border-radius:3px;font-size:0.68rem;font-weight:600;white-space:nowrap;flex-shrink:0;}' +
  '.tag-projeto{background:var(--cor-sucesso);color:#faf6ee;padding:1px 6px;border-radius:3px;font-size:0.63rem;font-weight:600;}' +
  '.email-cc-container{padding:4px;}' +
  '.email-cc-header label{font-size:0.75rem;font-weight:500;color:var(--cor-texto-secundario);display:flex;align-items:center;gap:4px;margin-bottom:6px;}' +
  '.email-cc-lista{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px;}' +
  '.email-cc-chip{padding:4px 9px;background:var(--cor-fundo-card);border:1px solid var(--cor-borda-clara);border-radius:4px;font-size:0.72rem;color:var(--cor-texto);cursor:pointer;transition:var(--transicao);display:flex;align-items:center;gap:4px;}' +
  '.email-cc-chip:hover{border-color:var(--cor-primaria-clara);background:var(--cor-primaria-bg);}' +
  '.email-cc-chip.selecionado{background:var(--cor-primaria);color:#faf6ee;border-color:var(--cor-primaria);}' +
  '.email-cc-input-container{display:flex;gap:6px;align-items:center;}' +
  '.email-cc-input-container input{flex:1;padding:6px 10px!important;font-size:0.78rem!important;}' +
  '.email-cc-input-container button{background:var(--cor-primaria);color:#faf6ee;border:none;padding:6px 12px;border-radius:var(--raio);cursor:pointer;font-size:0.75rem;font-weight:500;display:flex;align-items:center;gap:4px;transition:var(--transicao);white-space:nowrap;}' +
  '.email-cc-input-container button:hover{background:var(--cor-primaria-escura);}' +
  '.email-campo label{display:block;font-size:0.78rem;font-weight:500;margin-bottom:4px;color:var(--cor-texto);}' +
  '.email-vazio{text-align:center;padding:24px;color:var(--cor-texto-secundario);}' +
  '.email-vazio i{font-size:1.5rem;margin-bottom:8px;display:block;opacity:0.5;}' +
  '.email-footer{padding:12px 0;border-top:1px solid var(--cor-borda-clara);margin-top:12px;display:flex;justify-content:center;}';
  // ‚îÄ‚îÄ Conte√∫do expand√≠vel das atividades ‚îÄ‚îÄ
  '.atividade-conteudo-corpo{max-height:0;overflow:hidden;transition:max-height 0.3s ease,padding 0.3s ease;background:var(--cor-fundo-quente);border-top:0 solid var(--cor-borda-clara);}' +
  '.atividade-conteudo-corpo.visivel{max-height:500px;padding:10px 12px;border-top-width:1px;}' +
  '.atividade-oQueFazer{display:flex;align-items:flex-start;gap:8px;font-size:0.8rem;color:var(--cor-texto);line-height:1.55;}' +
  '.atividade-oQueFazer i{color:var(--cor-primaria);margin-top:3px;flex-shrink:0;font-size:0.72rem;}' +
  '.btn-expandir-atv{color:var(--cor-texto-secundario)!important;}' +
  '.btn-expandir-atv.ativo{color:var(--cor-primaria)!important;background:var(--cor-primaria-bg)!important;}' +
  '.atividade-ordem-drag{display:flex;align-items:center;gap:2px;flex-shrink:0;}' +
  '.atividade-numero,.atividade-numero-fixo{width:22px;height:22px;background:var(--cor-primaria);color:#faf6ee;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.68rem;font-weight:700;flex-shrink:0;}' +
  '.atividade-numero-fixo{background:var(--cor-primaria-bg);color:var(--cor-primaria);}' +
  '.atividade-drag-handle{color:var(--cor-borda);cursor:grab;font-size:0.75rem;}' +
  '.atividade-drag-handle:active{cursor:grabbing;}' +
  '.atividade-resp-avatar-group{display:inline-flex;align-items:center;}' +
  '.atividade-resp-avatar{width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,var(--cor-primaria),var(--cor-primaria-escura));color:#faf6ee;font-size:0.55rem;font-weight:800;display:inline-flex;align-items:center;justify-content:center;border:1.5px solid var(--cor-fundo-card);flex-shrink:0;}' +
  '.atividade-resp-avatar:not(:first-child){margin-left:-6px;}' +
  '.atividade-resp-avatar.mais{background:var(--cor-texto-secundario);font-size:0.5rem;}' +
  '.atividade-sem-resp{color:var(--cor-borda);font-size:0.72rem;}' +
  '.atividades-dica-drag{font-size:0.68rem;color:var(--cor-texto-secundario);font-style:italic;display:flex;align-items:center;gap:4px;}' +
  '.atividades-dica-drag i{font-size:0.62rem;color:var(--cor-primaria-clara);}' +

  // ‚îÄ‚îÄ Toolbar de atividades ‚Äî cores caf√© ‚îÄ‚îÄ
  '.atividades-toolbar{background:var(--cor-fundo-quente);border:1px solid var(--cor-borda);border-radius:var(--raio);padding:10px 12px;margin-bottom:10px;}' +
  '.atividades-toolbar-linha1{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}' +
  '.atividades-toolbar-linha2{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px;}' +
  '.campo-busca-atv{position:relative;display:flex;align-items:center;flex:1;min-width:160px;}' +
  '.campo-busca-atv .icone-busca-atv{position:absolute;left:9px;font-size:0.7rem;color:var(--cor-texto-secundario);pointer-events:none;}' +
  '.campo-busca-atv input{width:100%;padding:5px 28px 5px 26px;background:var(--cor-fundo-card);border:1px solid var(--cor-borda);border-radius:var(--raio);color:var(--cor-texto);font-size:0.78rem;transition:border-color 0.2s;outline:none;}' +
  '.campo-busca-atv input:focus{border-color:var(--cor-primaria);box-shadow:0 0 0 2px var(--cor-primaria-bg);}' +
  '.campo-busca-atv input::placeholder{color:var(--cor-texto-secundario);font-style:italic;}' +
  '.btn-limpar-busca-atv{position:absolute;right:6px;background:none;border:none;color:var(--cor-texto-secundario);cursor:pointer;padding:2px 4px;font-size:0.7rem;border-radius:3px;}' +
  '.btn-limpar-busca-atv:hover{color:var(--cor-texto);}' +
  '.atividades-ordenacao-grupo{display:flex;align-items:center;background:var(--cor-fundo-card);border:1px solid var(--cor-borda);border-radius:var(--raio);overflow:hidden;}' +
  '.btn-ord-atv{background:none;border:none;border-right:1px solid var(--cor-borda-clara);color:var(--cor-texto-secundario);padding:5px 8px;cursor:pointer;font-size:0.7rem;transition:background 0.15s,color 0.15s;}' +
  '.btn-ord-atv:last-child{border-right:none;}' +
  '.btn-ord-atv:hover{background:var(--cor-primaria-bg);color:var(--cor-primaria);}' +
  '.btn-ord-atv.ativo{background:var(--cor-primaria);color:#faf6ee;}' +
  '.btn-expandir-todas-atv{background:none;border:1px solid var(--cor-borda);color:var(--cor-texto-secundario);border-radius:var(--raio);padding:5px 8px;cursor:pointer;font-size:0.7rem;transition:all 0.15s;}' +
  '.btn-expandir-todas-atv:hover{border-color:var(--cor-primaria);color:var(--cor-primaria);background:var(--cor-primaria-bg);}' +
  '.btn-salvar-ordem-atv{display:none;align-items:center;gap:5px;background:var(--cor-sucesso);border:none;border-radius:var(--raio);color:#faf6ee;font-size:0.75rem;font-weight:600;padding:5px 12px;cursor:pointer;transition:background 0.2s;font-family:var(--font-corpo);}' +
  '.btn-salvar-ordem-atv:hover{background:#45603a;}' +
  '.atividades-filtros-chips{display:flex;gap:5px;flex-wrap:wrap;flex:1;}' +
  '.btn-filtro-status.todos.ativo{border-color:var(--cor-primaria);background:var(--cor-primaria-bg);color:var(--cor-primaria);}' +
  '.btn-filtro-status.afazer.ativo{border-color:var(--cor-aviso);background:rgba(184,134,11,0.1);color:var(--cor-aviso);}' +
  '.btn-filtro-status.andamento.ativo{border-color:var(--cor-info);background:rgba(74,111,165,0.1);color:var(--cor-info);}' +
  '.btn-filtro-status.aguardando.ativo{border-color:var(--cor-aguardando);background:rgba(194,133,90,0.1);color:var(--cor-aguardando);}' +
  '.btn-filtro-status.concluida.ativo{border-color:var(--cor-sucesso);background:rgba(90,114,71,0.1);color:var(--cor-sucesso);}' +
  '.atividades-contador{font-size:0.72rem;color:var(--cor-texto-secundario);white-space:nowrap;display:flex;align-items:center;gap:4px;}' 

document.head.appendChild(style);
})();


// Fechar Modo Foco com a tecla Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    var overlay = document.getElementById('modalModoFoco');
    if (overlay && overlay.classList.contains('visivel')) {
      fecharModoFoco();
    }
  }
});



// ========================= ALTERN√ÇNCIA DE TEMA =========================

/** Abre o modal correto conforme o tema visual atual */
function abrirModalTema() {
  var styleEl = document.getElementById('tema-azul-styles');
  var estaAzul = styleEl && !styleEl.disabled;
  if (estaAzul) {
    abrirModal('modalTemaParaClassico');
  } else {
    abrirModal('modalTemaParaAzul');
  }
}

/** Aplica o tema azul: injeta o CSS e salva no servidor */
function aplicarTemaAzul() {
  fecharModal('modalTemaParaAzul');
  _injetarCssAzul();
  _atualizarBotaoTema(true);
  mostrarToast('Tema azul aplicado... espero que voc√™ esteja satisfeito! üò§', 'info');

  // Persistir no servidor (n√£o depende de localStorage)
  if (typeof google !== 'undefined' && google.script) {
    google.script.run.salvarPreferenciaTema('azul');
  }
}

/** Restaura o tema cl√°ssico: remove o CSS azul e salva no servidor */
function aplicarTemaClassico() {
  fecharModal('modalTemaParaClassico');
  _removerCssAzul();
  _atualizarBotaoTema(false);
  mostrarToast('Bem-vindo de volta ao bom gosto! ‚òï', 'sucesso');

  // Persistir no servidor
  if (typeof google !== 'undefined' && google.script) {
    google.script.run.salvarPreferenciaTema('cafe');
  }
}

function _injetarCssAzul() {
  var styleEl = document.getElementById('tema-azul-styles');
  if (styleEl) {
    styleEl.disabled = false;   // ‚Üê reabilita sem recriar
    return;
  }
  var cssContent = document.createElement('div');
  cssContent.innerHTML = '<?!= include("TemaAzul-CSSüîµ"); ?>';
  var novoStyle = cssContent.querySelector('style');
  if (novoStyle) {
    novoStyle.id = 'tema-azul-styles';
    document.head.appendChild(novoStyle);
  }
}

function _removerCssAzul() {
  var style = document.getElementById('tema-azul-styles');
  if (style) style.disabled = true;  // ‚Üê desabilita sem destruir
  var link = document.getElementById('link-tema-azul');
  if (link) link.remove();
}

/** Atualiza visual do bot√£o de tema */
function _atualizarBotaoTema(estaAzul) {
  var btn = document.getElementById('btnTemaToggle');
  if (!btn) return;
  if (estaAzul) {
    btn.innerHTML = '<i class="fas fa-coffee"></i><span>Tema</span>';
    btn.title = 'Voltar ao tema original';
    btn.style.background = 'rgba(255,255,255,0.2)';
    btn.style.borderColor = 'rgba(255,255,255,0.4)';
  } else {
    btn.innerHTML = '<i class="fas fa-palette"></i><span>Tema</span>';
    btn.title = 'Mudar tema (socorra-nos)';
    btn.style.background = '';
    btn.style.borderColor = '';
  }
}



</script>